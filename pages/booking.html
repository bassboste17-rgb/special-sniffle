<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Georgia Trips - booking</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
:root {
  --primary-color: #dc3545;
  --primary-hover: #dc3545;
  --secondary-color: #00eeff;
  --text-color: #e0e0e0;
  --bg-dark: #0a0a0a;
  --light-bg: #1a1a1a;
  --border-color: #333;
  --success-color: #28a745;
  --error-color: #dc3545;
  --warning-color: #ffc107;
  --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.5);
  --border-radius: 12px;
  --border-radius-sm: 8px;
  --transition: all 0.3s ease;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
  color: var(--text-color);
  line-height: 1.6;
  min-height: 100vh;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2.5rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.header h1 {
  color: #fff;
  font-size: 2rem;
  font-weight: 700;
  letter-spacing: -0.5px;
}

/* Enhanced hero section with better visual hierarchy */
.hero {
  text-align: center;
  padding: 4rem 0 3rem;
  position: relative;
}

.hero::before {
  content: '';
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 600px;
  height: 600px;
  background: radial-gradient(circle, rgba(229, 56, 59, 0.08) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

.hero h1 {
  color: #fff;
  font-size: 2.75rem;
  margin-bottom: 1rem;
  font-weight: 800;
  letter-spacing: -1px;
  position: relative;
  z-index: 1;
  background: linear-gradient(135deg, #fff 0%, #e0e0e0 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.hero p {
  font-size: 1.25rem;
  margin-bottom: 3rem;
  color: var(--text-color);
  position: relative;
  z-index: 1;
  font-weight: 400;
}

/* Refined navigation cards with glassmorphism */
.nav-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 1.5rem;
  margin-top: 3rem;
  position: relative;
  z-index: 1;
}

.nav-card {
  background: rgba(26, 26, 26, 0.8);
  backdrop-filter: blur(10px);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 2.5rem 2rem;
  text-align: center;
  text-decoration: none;
  color: var(--text-color);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.nav-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary-color), transparent);
  transform: scaleX(0);
  transform-origin: left;
  transition: transform 0.4s ease;
}

.nav-card:hover::before {
  transform: scaleX(1);
}

.nav-card:hover {
  transform: translateY(-8px);
  border-color: var(--primary-color);
  box-shadow: var(--shadow-lg);
  background: rgba(26, 26, 26, 0.95);
}

.nav-card-icon {
  font-size: 3.5rem;
  margin-bottom: 1.5rem;
  display: inline-block;
  transition: var(--transition);
  filter: grayscale(0.3);
}

.nav-card:hover .nav-card-icon {
  transform: scale(1.1) rotateY(360deg);
  filter: grayscale(0);
}

.nav-card h3 {
  color: #fff;
  margin-bottom: 0.75rem;
  font-size: 1.25rem;
  font-weight: 600;
}

.nav-card p {
  font-size: 0.95rem;
  color: var(--text-color);
  line-height: 1.5;
}

.nav-card1 {
  background: rgba(26, 26, 26, 0.8);
  backdrop-filter: blur(10px);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 2.5rem 2rem;
  text-align: center;
  text-decoration: none;
  color: var(--text-color);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  min-height: 200px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.nav-card1::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary-color), transparent);
  transform: scaleX(0);
  transform-origin: left;
  transition: transform 0.4s ease;
}

.nav-card1:hover::before {
  transform: scaleX(1);
}

.nav-card1:hover {
  transform: translateY(-8px);
  border-color: var(--primary-color);
  box-shadow: var(--shadow-lg);
  background: rgba(26, 26, 26, 0.95);
}

.nav-card1-icon {
  font-size: 3.5rem;
  margin-bottom: 1.5rem;
  display: inline-block;
  transition: var(--transition);
  filter: grayscale(0.3);
}

.nav-card1:hover .nav-card1-icon {
  transform: scale(1.1) rotateY(360deg);
  filter: grayscale(0);
}

.nav-card1 h3 {
  color: #fff;
  margin-bottom: 0.75rem;
  font-size: 1.25rem;
  font-weight: 600;
}

.notif-badge {
  position: absolute;
  top: 1.5rem;
  right: 1.5rem;
  background: var(--primary-color);
  color: white;
  border-radius: 50%;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: 700;
  box-shadow: 0 2px 8px rgba(229, 56, 59, 0.4);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* Modern tabs with better visual feedback */
.tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 2rem;
  border-bottom: 2px solid var(--border-color);
  padding: 0 0.5rem;
}

.tab-btn {
  background: none;
  border: none;
  color: var(--text-color);
  padding: 1rem 2rem;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 500;
  border-bottom: 3px solid transparent;
  transition: var(--transition);
  position: relative;
  border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0;
}

.tab-btn:hover {
  color: #fff;
  background: rgba(255, 255, 255, 0.03);
}

.tab-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
  background: rgba(229, 56, 59, 0.05);
}

/* Enhanced filters with better spacing */
.filters {
  display: flex;
  gap: 1rem;
  margin-bottom: 2.5rem;
  flex-wrap: wrap;
  padding: 1.5rem;
  background: rgba(26, 26, 26, 0.5);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
}

.price-range-group {
  display: flex;
  gap: 0.75rem;
  align-items: center;
  flex: 1;
  min-width: 280px;
}

.price-range-group .input {
  flex: 1;
  min-width: 110px;
}

.price-range-separator {
  color: var(--text-color);
  font-weight: 600;
  font-size: 1.1rem;
}

.input,
.select {
  background: var(--light-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  padding: 0.875rem 1.25rem;
  color: var(--text-color);
  font-size: 0.95rem;
  flex: 1;
  min-width: 200px;
  transition: var(--transition);
}

.input:focus,
.select:focus {
  outline: none;
  border-color: var(--primary-color);
  background: var(--light-bg);
  box-shadow: 0 0 0 3px rgba(0, 31, 204, 0.1);
}

.input::placeholder {
  color: var(--text-color);
}

.select option {
  background: var(--bg-dark);
  color: var(--text-color);
  padding: 0.5rem;
}

/* Refined item cards with better shadows and hover effects */
.items-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 2rem;
}

.card {
  background: var(--light-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  overflow: hidden;
  transition: var(--transition);
  position: relative;
  box-shadow: var(--shadow-sm);
}

.card:hover {
  transform: translateY(-8px);
  box-shadow: var(--shadow-lg);
  border-color: rgba(229, 56, 59, 0.3);
}

.card-image {
  width: 100%;
  height: 220px;
  object-fit: cover;
  transition: var(--transition);
}

.card:hover .card-image {
  transform: scale(1.05);
}

.card-content {
  padding: 1.75rem;
}

.card-content h3 {
  color: #fff;
  margin-bottom: 0.75rem;
  font-size: 1.25rem;
  font-weight: 600;
  letter-spacing: -0.3px;
}

.card-description {
  color: #666;
  font-size: 0.9rem;
  margin-bottom: 1rem;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.card-details {
  display: flex;
  flex-wrap: wrap;
  gap: 0.625rem;
  margin-bottom: 1.25rem;
  font-size: 0.875rem;
}

.card-details span {
  background: var(--light-bg);
  padding: 0.375rem 0.75rem;
  border-radius: 6px;
  border: 1px solid var(--border-color);
  transition: var(--transition);
}

.card-details span:hover {
  background: rgba(229, 56, 59, 0.1);
  border-color: var(--primary-color);
}

/* Adding special styling for driver field with green background */
.card-details span.with-driver {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.15));
  border-color: rgba(16, 185, 129, 0.4);
  color: #10b981;
  font-weight: 600;
}

.card-details span.with-driver:hover {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.25));
  border-color: rgba(16, 185, 129, 0.6);
}
/* </CHANGE> */

.card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
}

.card-stats {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  font-size: 0.875rem;
  color: var(--text-color);
}

.popularity-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  color: #fff;
  padding: 0.625rem 0.875rem;
  border-radius: 24px;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  font-weight: 600;
  z-index: 10;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}

.popularity-btn:hover {
  background: rgba(0, 0, 0, 0.95);
  border-color: var(--primary-color);
  transform: scale(1.08);
  box-shadow: 0 6px 16px rgba(229, 56, 59, 0.3);
}

.popularity-btn.liked {
  background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
  border-color: #e74c3c;
}

.popularity-btn.liked:hover {
  background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
  box-shadow: 0 6px 20px rgba(231, 76, 60, 0.5);
}

.popularity-btn i {
  font-size: 1.05rem;
  transition: var(--transition);
}

.popularity-btn.liked i {
  color: #fff;
  animation: heartBeat 0.4s ease;
}

@keyframes heartBeat {
  0%, 100% { transform: scale(1); }
  25% { transform: scale(1.4); }
  50% { transform: scale(1.15); }
  75% { transform: scale(1.3); }
}

/* Added license plate badge styling for car cards */
.license-plate-badge {
  position: absolute;
  top: 12px;
  left: 12px;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  color: #fff;
  padding: 0.625rem 0.875rem;
  border-radius: 24px;
  font-size: 0.9rem;
  font-weight: 600;
  z-index: 10;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.license-plate-badge i {
  font-size: 1.05rem;
}

.price {
  color: var(--primary-color);
  font-size: 1.35rem;
  font-weight: 700;
  letter-spacing: -0.5px;
}

/* Enhanced button styles */
.btn {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
  color: #fff;
  border: none;
  border-radius: var(--border-radius-sm);
  padding: 0.875rem 1.75rem;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  box-shadow: 0 4px 12px rgba(0, 31, 204, 0.3);
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 31, 204, 0.4);
}

.btn:active {
  transform: translateY(0);
}

.btn-secondary {
  background: var(--light-bg);
  border: 1px solid var(--border-color);
  box-shadow: none;
}

.btn-secondary:hover {
  background: var(--bg-dark);
  border-color: var(--primary-color);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.btn-danger {
  background: linear-gradient(135deg, var(--error-color) 0%, #c82333 100%);
}

.btn-danger:hover {
  box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
}

.btn-sm {
  padding: 0.625rem 1.25rem;
  font-size: 0.875rem;
}

/* Enhanced modal with glassmorphism */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(8px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 1rem;
}

.modal-content {
  background: linear-gradient(135deg, rgba(26, 26, 26, 0.98) 0%, rgba(20, 20, 20, 0.98) 100%);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 2.5rem;
  max-width: 500px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow-lg);
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-large {
  max-width: 850px;
}

/* Hide calendar in detail modal (modal-large) */
.modal-large .detail-calendar-section {
  display: none !important;
}

.close {
  position: absolute;
  top: 1.5rem;
  right: 1.5rem;
  font-size: 1.75rem;
  color: var(--text-color);
  cursor: pointer;
  line-height: 1;
  transition: var(--transition);
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.05);
}

.close:hover {
  color: var(--primary-color);
  transform: rotate(90deg);
  background: rgba(229, 56, 59, 0.1);
}

.form-group {
  margin-bottom: 1.75rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.625rem;
  color: #fff;
  font-weight: 500;
  font-size: 0.95rem;
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.25rem;
}

textarea.input {
  resize: vertical;
  font-family: inherit;
  min-height: 100px;
}

/* Enhanced booking item info */
.booking-item-info {
  display: flex;
  gap: 1.5rem;
  margin-bottom: 2rem;
  padding: 1.75rem;
  background: linear-gradient(135deg, rgba(31, 31, 31, 0.8) 0%, rgba(26, 26, 26, 0.8) 100%);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
}

.booking-item-info img {
  width: 150px;
  height: 100px;
  object-fit: cover;
  border-radius: var(--border-radius-sm);
  border: 1px solid var(--border-color);
}

.booking-item-details {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.625rem;
}

.booking-item-details h3 {
  margin: 0;
  font-size: 1.35rem;
  color: #fff;
  font-weight: 600;
}

.booking-item-details .location {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--text-color);
  font-size: 0.95rem;
}

.booking-item-details .price {
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--primary-color);
  margin-top: auto;
}

/* Enhanced booking card with license plate and better visual design */
.booking-card {
  background: linear-gradient(135deg, rgba(26, 26, 26, 0.9) 0%, rgba(20, 20, 20, 0.9) 100%);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 2rem;
  margin-bottom: 1.75rem;
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
  position: relative;
  overflow: hidden;
}

.booking-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: var(--primary-color);
  opacity: 0;
  transition: var(--transition);
}

.booking-card:hover::before {
  opacity: 1;
}

.booking-card:hover {
  transform: translateX(4px);
}

.booking-card-image {
  width: 100%;
  height: 200px;
  object-fit: cover;
  border-radius: var(--border-radius-sm);
  margin-bottom: 1.5rem;
  border: 1px solid var(--border-color);
}

.booking-dates-visual {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin: 1.5rem 0;
  padding: 1.25rem;
  background: rgba(0, 0, 0, 0.3);
  border-radius: var(--border-radius-sm);
  border: 1px solid var(--border-color);
}

.booking-date-box {
  flex: 1;
  text-align: center;
  padding: 1rem;
  background: linear-gradient(135deg, rgba(31, 31, 31, 0.8) 0%, rgba(26, 26, 26, 0.8) 100%);
  border-radius: var(--border-radius-sm);
  border: 1px solid var(--border-color);
}

.booking-date-label {
  font-size: 0.85rem;
  color: var(--text-color);
  margin-bottom: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.booking-date-day {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--primary-color);
  line-height: 1;
  margin-bottom: 0.25rem;
}

.booking-date-month {
  font-size: 1.1rem;
  color: #fff;
  font-weight: 600;
}

.booking-date-time {
  font-size: 0.9rem;
  color: var(--text-color);
  margin-top: 0.5rem;
}

.booking-date-arrow {
  font-size: 2rem;
  color: var(--primary-color);
  flex-shrink: 0;
}

.booking-info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin: 1.5rem 0;
}

.booking-info-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.875rem;
  background: rgba(0, 0, 0, 0.2);
  border-radius: var(--border-radius-sm);
  border: 1px solid rgba(255, 255, 255, 0.05);
}

/* Adding special styling for driver field with green background */
.booking-info-item.with-driver {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1));
  border: 1px solid rgba(16, 185, 129, 0.4);
}

.booking-info-item.with-driver .booking-info-icon {
  color: #10b981;
}

.booking-info-item.with-driver .booking-info-value {
  color: #10b981;
  font-weight: 700;
}
/* </CHANGE> */

.booking-info-icon {
  font-size: 1.5rem;
  color: var(--primary-color);
}

.booking-info-content {
  display: flex;
  flex-direction: column;
}

.booking-info-label {
  font-size: 0.85rem;
  color: var(--text-color);
  margin-bottom: 0.25rem;
}

.booking-info-value {
  font-size: 1.05rem;
  color: #fff;
  font-weight: 600;
}

.booking-price-large {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary-color);
  text-align: center;
  padding: 1rem;
  background: rgba(229, 56, 59, 0.1);
  border-radius: var(--border-radius-sm);
  border: 1px solid rgba(229, 56, 59, 0.3);
  margin: 1.5rem 0;
}

.price-info {
  background: transparent;
  padding: 1.75rem;
  border-radius: var(--border-radius);
  margin-bottom: 1.75rem;
}

.price-breakdown {
  color: white;
  text-align: center;
}

.price-breakdown p {
  margin: 0.75rem 0;
  font-size: 1.05rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.price-breakdown strong {
  font-size: 1.5rem;
  color: var(--primary-color);
}

/* Enhanced booking card styles */
.booking-card {
  background: linear-gradient(135deg, rgba(26, 26, 26, 0.9) 0%, rgba(20, 20, 20, 0.9) 100%);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 2rem;
  margin-bottom: 1.75rem;
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
}

.booking-card:hover {
  border-color: var(--primary-color);
  box-shadow: var(--shadow-md);
  transform: translateX(4px);
}

.booking-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 1.25rem;
  gap: 1rem;
}

.booking-header h3 {
  color: #fff;
  font-size: 1.25rem;
  font-weight: 600;
}

.booking-details {
  margin-bottom: 1.25rem;
  padding: 1.25rem;
  background: rgba(0, 0, 0, 0.2);
  border-radius: var(--border-radius-sm);
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.booking-details p {
  margin-bottom: 0.625rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.booking-details p:last-child {
  margin-bottom: 0;
}

.booking-actions {
  display: flex;
  gap: 1rem;
  margin-top: 1.25rem;
  flex-wrap: wrap;
  align-items: center;
}

.status-badge {
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 600;
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.status-მოლოდინში {
  background: linear-gradient(135deg, var(--warning-color) 0%, #e0a800 100%);
  color: #000;
  box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
}

.status-დადასტურებული {
  background: linear-gradient(135deg, var(--success-color) 0%, #218838 100%);
  color: #fff;
  box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
}

.status-გაუქმებული {
  background: linear-gradient(135deg, var(--error-color) 0%, #c82333 100%);
  color: #fff;
  box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
}

/* Enhanced booking card styles with image, calendar-style dates, and better visual hierarchy */
.booking-card {
  background: linear-gradient(135deg, rgba(26, 26, 26, 0.9) 0%, rgba(20, 20, 20, 0.9) 100%);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 0;
  margin-bottom: 1.75rem;
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
}

.booking-card:hover {
  border-color: var(--primary-color);
  box-shadow: var(--shadow-md);
  transform: translateX(4px);
}

.booking-card-header {
  display: flex;
  gap: 1.5rem;
  padding: 1.5rem;
  border-bottom: 1px solid var(--border-color);
  align-items: center;
}

.booking-card-image {
  width: 120px;
  height: 80px;
  object-fit: cover;
  border-radius: var(--border-radius-sm);
  border: 1px solid var(--border-color);
  flex-shrink: 0;
}

.booking-card-title-section {
  flex: 1;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.booking-card-title-section h3 {
  color: #fff;
  font-size: 1.25rem;
  font-weight: 600;
  margin: 0;
}

.booking-card-body {
  padding: 1.5rem;
}

.booking-dates-visual {
  display: flex;
  align-items: center;
  gap: 1.5rem;
  margin-bottom: 1.5rem;
  padding: 1.25rem;
  background: rgba(0, 0, 0, 0.2);
  border-radius: var(--border-radius-sm);
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.booking-date-box {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 1rem;
  background: linear-gradient(135deg, rgba(229, 56, 59, 0.1) 0%, rgba(229, 56, 59, 0.05) 100%);
  border: 2px solid var(--primary-color);
  border-radius: var(--border-radius-sm);
  min-width: 80px;
}

.booking-date-day {
  font-size: 2rem;
  font-weight: 700;
  color: #fff;
  line-height: 1;
  margin-bottom: 0.25rem;
}

.booking-date-month {
  font-size: 0.875rem;
  color: var(--primary-color);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.booking-date-time {
  font-size: 0.8rem;
  color: var(--text-color);
  margin-top: 0.25rem;
}

.booking-date-arrow {
  font-size: 1.5rem;
  color: var(--text-color);
  flex-shrink: 0;
}

.booking-date-duration {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0.75rem 1rem;
  background: rgba(255, 255, 255, 0.05);
  border-radius: var(--border-radius-sm);
  border: 1px solid var(--border-color);
}

.booking-date-duration-number {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--primary-color);
  line-height: 1;
}

.booking-date-duration-label {
  font-size: 0.75rem;
  color: var(--text-color);
  margin-top: 0.25rem;
}

.booking-info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 1.25rem;
}

.booking-info-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.875rem;
  background: rgba(255, 255, 255, 0.03);
  border-radius: var(--border-radius-sm);
  border: 1px solid var(--border-color);
}

.booking-info-icon {
  font-size: 1.25rem;
  color: var(--primary-color);
  flex-shrink: 0;
}

.booking-info-content {
  display: flex;
  flex-direction: column;
}

.booking-info-label {
  font-size: 0.75rem;
  color: var(--text-color);
  margin-bottom: 0.125rem;
}

.booking-info-value {
  font-size: 1rem;
  color: #fff;
  font-weight: 600;
}

.booking-price-large {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary-color);
}

.booking-status-message {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem 1.25rem;
  border-radius: var(--border-radius-sm);
  margin-bottom: 1.25rem;
  font-weight: 500;
}

.booking-status-message.pending {
  background: rgba(255, 193, 7, 0.1);
  border: 1px solid rgba(255, 193, 7, 0.3);
  color: var(--warning-color);
}

.booking-status-message.confirmed {
  background: rgba(40, 167, 69, 0.1);
  border: 1px solid rgba(40, 167, 69, 0.3);
  color: var(--success-color);
}

.booking-status-message.cancelled {
  background: rgba(220, 53, 69, 0.1);
  border: 1px solid rgba(220, 53, 69, 0.3);
  color: var(--error-color);
}

.refund-info {
  color: var(--success-color);
  font-size: 0.9rem;
  font-weight: 500;
  padding: 0.5rem 1rem;
  background: rgba(40, 167, 69, 0.1);
  border-radius: 6px;
  border: 1px solid rgba(40, 167, 69, 0.2);
}

.warning-text {
  color: var(--warning-color);
  font-size: 0.95rem;
  font-weight: 500;
  padding: 1rem 1.25rem;
  background: rgba(255, 193, 7, 0.1);
  border-radius: var(--border-radius-sm);
  border: 1px solid rgba(255, 193, 7, 0.3);
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

/* Enhanced notification cards */
.notification-card {
  background: linear-gradient(135deg, rgba(26, 26, 26, 0.9) 0%, rgba(20, 20, 20, 0.9) 100%);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 1.75rem;
  margin-bottom: 1.25rem;
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
}

.notification-card:hover {
  border-color: var(--primary-color);
  transform: translateX(4px);
  box-shadow: var(--shadow-md);
}

.notification-card.unread {
  border-left: 4px solid var(--primary-color);
  background: linear-gradient(135deg, rgba(229, 56, 59, 0.08) 0%, rgba(26, 26, 26, 0.9) 100%);
}

.notification-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 0.75rem;
  gap: 1rem;
}

.notification-header h3 {
  color: #fff;
  font-size: 1.15rem;
  font-weight: 600;
}

.notification-time {
  font-size: 0.85rem;
  color: var(--text-color);
  white-space: nowrap;
  padding: 0.25rem 0.75rem;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
}

/* Enhanced notification card with automatic price/date highlighting */
.notification-message {
  line-height: 1.7;
  color: var(--text-color);
  margin: 1rem 0;
}

.notification-highlight-price {
  display: inline-block;
  background: rgba(229, 56, 59, 0.2);
  border: 1px solid var(--primary-color);
  border-radius: 6px;
  padding: 0.25rem 0.75rem;
  color: var(--primary-color);
  font-weight: 700;
  font-size: 1.1rem;
}

.notification-highlight-date {
  display: inline-block;
  background: rgba(255, 193, 7, 0.2);
  border: 1px solid var(--warning-color);
  border-radius: 6px;
  padding: 0.25rem 0.75rem;
  color: var(--warning-color);
  font-weight: 600;
}

.notification-highlight-percent {
  display: inline-block;
  background: rgba(40, 167, 69, 0.2);
  border: 1px solid var(--success-color);
  border-radius: 6px;
  padding: 0.25rem 0.75rem;
  color: var(--success-color);
  font-weight: 700;
}

.notification-actions {
  display: flex;
  gap: 0.75rem;
  margin-top: 1.25rem;
  flex-wrap: wrap;
}

.loading {
  text-align: center;
  padding: 4rem;
  font-size: 1.25rem;
  color: var(--text-color);
}

.loading::after {
  content: '...';
  animation: dots 1.5s steps(4, end) infinite;
}

@keyframes dots {
  0%, 20% { content: '.'; }
  40% { content: '..'; }
  60%, 100% { content: '...'; }
}

.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  font-size: 1.15rem;
  color: var(--text-color);
  background: rgba(26, 26, 26, 0.5);
  border-radius: var(--border-radius);
  border: 1px dashed var(--border-color);
}

.text-muted {
  color: var(--text-color);
  font-size: 0.9rem;
}

/* Enhanced auth overlay */
.auth-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

.auth-overlay-content {
  background: linear-gradient(135deg, rgba(26, 26, 26, 0.98) 0%, rgba(20, 20, 20, 0.98) 100%);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 3rem;
  text-align: center;
  max-width: 450px;
  width: 100%;
  animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow-lg);
}

.auth-overlay-content h2 {
  color: #fff;
  margin-bottom: 1.25rem;
  font-size: 1.75rem;
  font-weight: 700;
}

.auth-overlay-content p {
  margin-bottom: 2rem;
  color: var(--text-color);
  font-size: 1.05rem;
  line-height: 1.6;
}

/* Enhanced detail modal */
.detail-modal-content {
  max-width: 800px;
  width: 100%;
}

.detail-modal-body {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2.5rem;
}

.detail-gallery {
  position: relative;
}

.detail-main-image {
  width: 100%;
  height: 300px; /* Adjusted height */
  object-fit: cover;
  border-radius: var(--border-radius);
  margin-bottom: 1.25rem;
  border: 1px solid var(--border-color);
}

.gallery-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(8px);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.1);
  width: 44px;
  height: 44px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  transition: var(--transition);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  z-index: 2;
}

.gallery-nav:hover {
  background: rgba(229, 56, 59, 0.9);
  border-color: var(--primary-color);
  transform: translateY(-50%) scale(1.1);
}

.image-nav-prev {
  left: 1rem;
}

.image-nav-next {
  right: 1rem;
}

.detail-thumbnails {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
  gap: 0.75rem;
}

.detail-thumbnail {
  width: 100%;
  height: 85px;
  object-fit: cover;
  border-radius: var(--border-radius-sm);
  cursor: pointer;
  border: 2px solid transparent;
  transition: var(--transition);
}

.detail-thumbnail:hover {
  border-color: var(--primary-color);
  transform: scale(1.05);
}

.detail-thumbnail.active {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(229, 56, 59, 0.2);
}

.detail-info {
  display: flex;
  flex-direction: column;
  gap: 1rem; /* Adjusted gap */
}

.detail-info h2 {
  color: #fff;
  font-size: 2rem; /* Adjusted size */
  margin-bottom: 0.5rem;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.detail-price {
  color: var(--primary-color);
  font-size: 1.75rem; /* Adjusted size */
  font-weight: 700;
}

.detail-description {
  line-height: 1.8;
  color: var(--text-color);
  font-size: 0.95rem; /* Adjusted size */
}

.detail-specs {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.25rem;
}

.detail-spec {
  background: rgba(31, 31, 31, 0.6);
  padding: 1.25rem;
  border-radius: var(--border-radius-sm);
  display: flex;
  align-items: center;
  gap: 0.75rem;
  border: 1px solid var(--border-color);
  transition: var(--transition);
}

/* Adding special styling for driver field with green background */
.detail-spec.with-driver {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1));
  border: 1px solid rgba(16, 185, 129, 0.4);
  padding: 1rem;
  border-radius: 8px;
}

.detail-spec.with-driver .detail-spec-icon {
  font-size: 1.5rem;
}

.detail-spec.with-driver .detail-spec-value {
  color: #10b981;
  font-weight: 700;
}
/* </CHANGE> */

.detail-spec:hover {
  background: rgba(31, 31, 31, 0.9);
  border-color: var(--primary-color);
}

.detail-spec-icon {
  font-size: 1.75rem;
}

.detail-spec-text {
  display: flex;
  flex-direction: column;
}

.detail-spec-label {
  font-size: 0.85rem;
  color: var(--text-color);
  margin-bottom: 0.25rem;
}

.detail-spec-value {
  font-size: 1.15rem;
  color: #fff;
  font-weight: 600;
}

.detail-actions {
  display: flex;
  gap: 1.25rem;
  margin-top: auto;
}

.spec-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  color: var(--text-color);
  font-size: 0.95rem;
}

.spec-item i {
  color: var(--primary-color);
  font-size: 1.2rem;
}

.detail-calendar-section {
  margin-top: 1.5rem;
}

.detail-calendar-section h3 {
  color: #fff;
  margin-bottom: 1rem;
  font-size: 1.25rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.detail-calendar-section h3 i {
  color: var(--primary-color);
}

.card-clickable {
  cursor: pointer;
  transition: var(--transition);
}

.card-clickable:hover {
  transform: translateY(-10px);
}

/* Enhanced toast notifications */
.toast-container {
  position: fixed;
  top: 24px;
  right: 24px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  max-width: 420px;
}

.toast {
  background: linear-gradient(135deg, rgba(26, 26, 26, 0.98) 0%, rgba(20, 20, 20, 0.98) 100%);
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 1.25rem 1.75rem;
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: start;
  gap: 1.25rem;
  animation: toastSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

@keyframes toastSlideIn {
  from {
    opacity: 0;
    transform: translateX(100%) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateX(0) scale(1);
  }
}

@keyframes toastSlideOut {
  from {
    opacity: 1;
    transform: translateX(0) scale(1);
  }
  to {
    opacity: 0;
    transform: translateX(100%) scale(0.9);
  }
}

.toast.removing {
  animation: toastSlideOut 0.3s ease forwards;
}

.toast-icon {
  font-size: 1.75rem;
  flex-shrink: 0;
  line-height: 1;
}

.toast-content {
  flex: 1;
}

.toast-title {
  color: #fff;
  font-weight: 700;
  margin-bottom: 0.375rem;
  font-size: 1rem;
}

.toast-message {
  color: var(--text-color);
  font-size: 0.9rem;
  line-height: 1.5;
}

.toast-close {
  background: none;
  border: none;
  color: var(--text-color);
  cursor: pointer;
  font-size: 1.5rem;
  line-height: 1;
  padding: 0;
  transition: var(--transition);
  flex-shrink: 0;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.toast-close:hover {
  color: #fff;
  background: rgba(255, 255, 255, 0.1);
}

.toast-progress {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 4px;
  background: var(--primary-color);
  animation: toastProgress 5s linear forwards;
  border-radius: 0 0 0 var(--border-radius);
}

@keyframes toastProgress {
  from { width: 100%; }
  to { width: 0%; }
}

.toast.success {
  border-left: 4px solid var(--success-color);
}

.toast.success .toast-icon {
  color: var(--success-color);
}

.toast.success .toast-progress {
  background: var(--success-color);
}

.toast.error {
  border-left: 4px solid var(--error-color);
}

.toast.error .toast-icon {
  color: var(--error-color);
}

.toast.error .toast-progress {
  background: var(--error-color);
}

.toast.warning {
  border-left: 4px solid var(--warning-color);
}

.toast.warning .toast-icon {
  color: var(--warning-color);
}

.toast.warning .toast-progress {
  background: var(--warning-color);
}

.toast.info {
  border-left: 4px solid var(--info-color);
}

.toast.info .toast-icon {
  color: var(--info-color);
}

.toast.info .toast-progress {
  background: var(--info-color);
}

/* Enhanced confirm modal */
.confirm-modal-content {
  max-width: 480px;
  text-align: center;
}

.confirm-modal-content h2 {
  color: #fff;
  margin-bottom: 1.25rem;
  font-size: 1.75rem;
  font-weight: 700;
}

.confirm-modal-content p {
  color: var(--text-color);
  margin-bottom: 2.5rem;
  line-height: 1.7;
  font-size: 1.05rem;
}

.confirm-actions {
  display: flex;
  gap: 1.25rem;
  justify-content: center;
}

.confirm-actions .btn {
  min-width: 140px;
}

/* Enhanced custom calendar */
.custom-calendar {
  position: absolute;
  top: 100%;
  left: 0;
  margin-top: 0.75rem;
  background: linear-gradient(135deg, rgba(26, 26, 26, 0.98) 0%, rgba(20, 20, 20, 0.98) 100%);
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 1rem;
  box-shadow: var(--shadow-lg);
  z-index: 1001;
  min-width: 300px;
  animation: calendarSlideIn 0.3s ease;
}

@keyframes calendarSlideIn {
  from {
    opacity: 0;
    transform: translateY(-15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.calendar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1.25rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border-color);
}

.calendar-title {
  font-size: 1.15rem;
  font-weight: 700;
  color: #fff;
}

.calendar-nav {
  background: var(--light-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--text-color);
  transition: var(--transition);
  font-weight: 600;
}

.calendar-nav:hover {
  background: var(--primary-color);
  border-color: var(--primary-color);
  color: white;
  transform: scale(1.1);
}

.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.375rem;
  margin-bottom: 0.75rem;
}

.calendar-weekday {
  text-align: center;
  font-size: 0.875rem;
  font-weight: 700;
  color: var(--primary-color);
  padding: 0.625rem 0;
}

.calendar-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.375rem;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.95rem;
  font-weight: 500;
  color: var(--text-color);
  transition: var(--transition);
  position: relative;
}

.calendar-day:not(.disabled):not(.other-month):hover {
  background: var(--light-bg);
  color: #fff;
  transform: scale(1.1);
}

.calendar-day.selected {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
  color: white;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(0, 31, 204, 0.4);
}

.calendar-day.today {
  border: 2px solid var(--primary-color);
  font-weight: 700;
}

.calendar-day.today.selected {
  border-color: white;
}

.calendar-day.disabled {
  color: #555;
  cursor: not-allowed;
  opacity: 0.3;
}

.calendar-day.other-month {
  color: #555;
  cursor: default;
  opacity: 0.4;
}

.booking-modal-content {
  max-width: 800px;
}

/* Replaced simple date inputs with seasonal calendar containers */
.booking-dates-grid {
  display: grid;
  grid-template-columns: 1fr; /* Changed to 1fr to accommodate single calendar */
  gap: 1.25rem;
  margin-bottom: 1.75rem;
}

/* Enhanced time input styles for better UX */
.booking-times-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.25rem;
  margin-bottom: 1.75rem;
}

.form-group input[type="time"] {
  font-size: 1.1rem;
  padding: 1rem 1.25rem;
  cursor: pointer;
  font-weight: 500;
}

.form-group input[type="time"]::-webkit-calendar-picker-indicator {
  cursor: pointer;
  filter: invert(0.7);
  font-size: 1.2rem;
}

.form-group label {
  display: flex;
  align-items: center;
  gap: 0.625rem;
  margin-bottom: 0.625rem;
  color: #fff;
  font-weight: 600;
  font-size: 0.95rem;
}

.form-group label i {
  color: var(--primary-color);
  font-size: 1.1rem;
}

.form-group-calendar {
  position: relative;
}

.form-group-calendar label {
  display: flex;
  align-items: center;
  gap: 0.625rem;
  margin-bottom: 0.625rem;
  color: #fff;
  font-weight: 600;
  font-size: 0.95rem;
}

.form-group-calendar label i {
  color: var(--primary-color);
  font-size: 1.1rem;
}

/* Responsive improvements */
@media (max-width: 768px) {
  .container {
    padding: 1.25rem;
  }

  .header h1 {
    font-size: 1.5rem;
  }

  .hero {
    padding: 3rem 0 2rem;
  }

  .hero h1 {
    font-size: 2rem;
  }

  .hero p {
    font-size: 1.1rem;
  }

  .items-grid {
    grid-template-columns: 1fr;
  }

  .filters {
    flex-direction: column;
    padding: 1.25rem;
  }

  .input,
  .select {
    min-width: 100%;
  }

  .price-range-group {
    min-width: 100%;
  }

  .form-row {
    grid-template-columns: 1fr;
  }

  .detail-modal-body {
    grid-template-columns: 1fr;
  }

  .detail-main-image {
    height: 250px;
  }

  .detail-specs {
    grid-template-columns: 1fr;
  }

  .detail-actions {
    flex-direction: column;
  }

  .toast-container {
    top: 12px;
    right: 12px;
    left: 12px;
    max-width: none;
  }

  .toast {
    padding: 1rem 1.25rem;
  }

  .toast-icon {
    font-size: 1.5rem;
  }

  .toast-title {
    font-size: 0.95rem;
  }

  .toast-message {
    font-size: 0.85rem;
  }

  .confirm-actions {
    flex-direction: column;
  }

  .confirm-actions .btn {
    width: 100%;
  }

  .booking-item-info {
    flex-direction: column;
  }

  .booking-item-info img {
    width: 100%;
    height: 200px;
  }

  .booking-dates-grid,
  .booking-times-grid {
    grid-template-columns: 1fr;
  }

  .custom-calendar {
    min-width: 280px;
  }

  .nav-cards {
    grid-template-columns: 1fr;
  }

  .tabs {
    overflow-x: auto;
    padding-bottom: 0.5rem;
  }

  .tab-btn {
    white-space: nowrap;
  }

  /* Mobile responsive for new elements */
  .booking-dates-visual {
    flex-direction: column;
  }

  .booking-date-arrow {
    transform: rotate(90deg);
  }

  .booking-info-grid {
    grid-template-columns: 1fr;
  }

  .form-group-inline {
    grid-template-columns: 1fr;
  }

  .tour-dates-grid {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  }

  /* Style for booking user info form */
  .booking-user-info {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .booking-user-info h3 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .booking-user-form-grid {
    display: grid;
    grid-template-columns: 1fr;
  }

  .booking-user-form-grid .form-group {
    margin-bottom: 0;
  }
}

/* Calendar Styles for Detail Modal */
.seasonal-calendar {
  background: rgba(26, 26, 26, 0.9);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 1.5rem;
  margin-top: 1.5rem;
  box-shadow: var(--shadow-md);
}

.seasonal-calendar h3 {
  color: #fff;
  margin-bottom: 1rem;
  font-size: 1.25rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.seasonal-calendar h3 i {
  color: var(--primary-color);
}

.calendar-container {
  background: rgba(31, 31, 31, 0.6);
  border-radius: var(--border-radius-sm);
  padding: 1rem;
  border: 1px solid var(--border-color);
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border-color);
}

.calendar-header h2 {
  color: #fff;
  font-size: 1.1rem;
  font-weight: 600;
  margin: 0;
}

.season-indicator {
  font-size: 1.5rem;
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

.nav-buttons {
  display: flex;
  gap: 0.5rem;
}

.nav-buttons button {
  background: var(--light-bg);
  border: 1px solid var(--border-color);
  color: var(--text-color);
  padding: 0.5rem 0.75rem;
  border-radius: 6px;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.9rem;
}

.nav-buttons button:hover {
  background: var(--primary-color);
  border-color: var(--primary-color);
  color: white;
  transform: scale(1.05);
}

.weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.25rem;
  margin-bottom: 0.5rem;
}

.weekday {
  text-align: center;
  font-weight: 600;
  color: var(--primary-color);
  padding: 0.5rem 0;
  font-size: 0.8rem;
}

.days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.25rem;
}

.day {
  aspect-ratio: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 6px;
  cursor: pointer;
  transition: var(--transition);
  font-weight: 500;
  color: var(--text-color);
  font-size: 0.85rem;
  position: relative;
}

.day:hover {
  background: var(--light-bg);
  color: #fff;
  transform: scale(1.1);
}

.day.today {
  border: 2px solid var(--primary-color);
  font-weight: 700;
}

.day.selected {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
  color: white;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(229, 56, 59, 0.4); /* FIX: Changed shadow to red */
}

.day.other-month {
  color: #555;
  cursor: default;
  opacity: 0.4;
}

.day.disabled {
  color: #555;
  cursor: not-allowed;
  opacity: 0.3;
  text-decoration: line-through;
}

/* Seasonal backgrounds */
.spring { background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); }
.summer { background: linear-gradient(135deg, #FF9800 0%, #FFC107 100%); }
.autumn { background: linear-gradient(135deg, #FF5722 0%, #FF9800 100%); }
.winter { background: linear-gradient(135deg, #2196F3 0%, #03A9F4 100%); }

/* Added enhanced calendar styles from availability-calendar */
/* Seasonal Calendar Styles - Enhanced */
.seasonal-calendar {
  background: rgba(26, 26, 26, 0.9);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 1.5rem;
  box-shadow: var(--shadow-md);
  margin-bottom: 1.5rem;
}

.seasonal-calendar h3 {
  color: #fff;
  margin-bottom: 1rem;
  font-size: 1.25rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.seasonal-calendar h3 i {
  color: var(--primary-color);
}

.calendar-container.spring,
.calendar-container.summer,
.calendar-container.autumn,
.calendar-container.winter {
  background: rgba(31, 31, 31, 0.6);
  border-radius: var(--border-radius-sm);
  padding: 1rem;
  border: 1px solid var(--border-color);
}

.season-indicator {
  font-size: 1.5rem;
  animation: bounce 2s infinite;
  display: inline-block;
}

.day.booked {
  background: rgba(220, 53, 69, 0.2);
  border: 1px solid var(--error-color);
  color: var(--error-color);
}

.day.available {
  background: rgba(4, 236, 58, 0.377);
  border: 1px solid var(--success-color);
  color: rgb(255, 255, 255); /* Fixed typo: rgb(255, 255, 255) */
}

/* Calendar Legend */
.calendar-legend {
  display: flex;
  justify-content: center;
  gap: 1.5rem; /* Adjusted gap */
  margin-top: 1.5rem;
  flex-wrap: wrap;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border-color);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.75rem; /* Adjusted gap */
  font-size: 0.9rem; /* Adjusted font size */
  color: var(--text-color);
  font-weight: 500;
}

.legend-color {
  width: 20px; /* Adjusted size */
  height: 20px; /* Adjusted size */
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.legend-available { background: rgba(40, 167, 69, 0.8); }
.legend-booked { background: var(--error-color); }
.legend-selected { 
  /* Updated legend color to match new cyan selected day style */
  background: linear-gradient(135deg, #00d4ff 0%, #00eeff 100%);
  border: 2px solid #00eeff;
}
.legend-today {
    border: 3px solid rgb(0, 255, 255);
    background: transparent;
}

/* Seasonal header backgrounds */
.calendar-container.spring .calendar-header { 
  background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); 
  border-radius: var(--border-radius-sm);
  padding: 0.75rem;
  margin-bottom: 1rem;
}
.calendar-container.summer .calendar-header { 
  background: linear-gradient(135deg, #FF9800 0%, #FFC107 100%); 
  border-radius: var(--border-radius-sm);
  padding: 0.75rem;
  margin-bottom: 1rem;
}
.calendar-container.autumn .calendar-header { 
  background: linear-gradient(135deg, #FF5722 0%, #FF9800 100%); 
  border-radius: var(--border-radius-sm);
  padding: 0.75rem;
  margin-bottom: 1rem;
}
.calendar-container.winter .calendar-header { 
  background: linear-gradient(135deg, #2196F3 0%, #03A9F4 100%); 
  border-radius: var(--border-radius-sm);
  padding: 0.75rem;
  margin-bottom: 1rem;
}

/* Updated booking modal calendar containers */
.booking-calendar-container {
  margin-bottom: 1.5rem;
}

/* Added clear selection button styling */
.clear-selection-btn {
  background: var(--light-bg);
  border: 1px solid var(--border-color);
  color: var(--text-color);
  padding: 0.75rem 1.5rem;
  border-radius: var(--border-radius-sm);
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.95rem;
  font-weight: 600;
  margin-top: 1rem;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.clear-selection-btn:hover {
  background: var(--primary-color);
  border-color: var(--primary-color);
  color: white;
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.clear-selection-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* Tour dates selector styling */
.tour-dates-selector {
  margin-top: 1.5rem;
  padding: 1.5rem;
  background: rgba(31, 31, 31, 0.6);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
}

.tour-dates-selector h3 {
  color: #fff;
  margin-bottom: 1rem;
  font-size: 1.1rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.tour-dates-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 1rem;
}

.tour-date-option {
  padding: 1rem;
  background: linear-gradient(135deg, rgba(31, 31, 31, 0.8) 0%, rgba(26, 26, 26, 0.8) 100%);
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  text-align: center;
  cursor: pointer;
  transition: var(--transition);
}

.tour-date-option:hover:not(.disabled) {
  border-color: var(--primary-color);
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}

.tour-date-option.selected {
  border-color: var(--primary-color);
  background: linear-gradient(135deg, rgba(229, 56, 59, 0.2) 0%, rgba(229, 56, 59, 0.1) 100%);
}

.tour-date-option.disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
     .day.today {
          border: 3px solid #00ffff;
          background: rgba(0, 255, 255, 0.15);
          font-weight: 700;
          box-shadow: 0 0 12px rgba(0, 255, 255, 0.5);
        }

/* Updated calendar styles */
.calendar-day.selected {
  /* Changed to bright cyan gradient for better distinction from disabled days */
  background: linear-gradient(135deg, #00d4ff 0%, #00eeff 100%);
  color: #000;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(0, 238, 255, 0.6);
  transform: scale(1.05);
}

.day.selected {
  /* Changed to bright cyan gradient for better distinction from disabled days */
  background: linear-gradient(135deg, #00d4ff 0%, #00eeff 100%);
  color: #000;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(0, 238, 255, 0.6);
  transform: scale(1.05);
}

.legend-selected { 
  /* Updated legend color to match new cyan selected day style */
  background: linear-gradient(135deg, #00d4ff 0%, #00eeff 100%);
  border: 2px solid #00eeff;
}

/* Added restricted calendar styles for booking page */
.restricted-calendar-container {
  background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(220, 53, 69, 0.05) 100%);
  border: 2px solid var(--primary-color);
  border-radius: var(--border-radius);
  padding: 1.5rem;
  margin: 1.5rem 0;
}

.restricted-calendar-title {
  color: #fff;
  font-size: 1.1rem;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.restricted-calendar-title i {
  color: var(--primary-color);
}

.restricted-calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.5rem;
}

.restricted-calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  cursor: pointer;
  transition: var(--transition);
  border: 2px solid var(--primary-color);
  background: rgba(220, 53, 69, 0.2);
  color: var(--primary-color);
  font-weight: 600;
}

.restricted-calendar-day:hover {
  background: rgba(220, 53, 69, 0.4);
  transform: scale(1.1);
}

.restricted-calendar-day.available {
  background: rgba(40, 167, 69, 0.3);
  border-color: var(--success-color);
  color: var(--success-color);
}

.restricted-calendar-day.available:hover {
  background: rgba(40, 167, 69, 0.5);
}

/* Enhanced contact form styles with better design */
.booking-user-info {
  background: linear-gradient(135deg, rgba(31, 31, 31, 0.95) 0%, rgba(26, 26, 26, 0.95) 100%);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 2rem;
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-md);
  backdrop-filter: blur(10px);
}

.booking-user-info h3 {
  font-size: 1.25rem;
  margin-bottom: 1.5rem;
  color: #fff;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-weight: 600;
  padding-bottom: 1rem;
  border-bottom: 2px solid rgba(229, 56, 59, 0.3);
}

.booking-user-info h3 i {
  color: var(--primary-color);
  font-size: 1.5rem;
}

.booking-user-form-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.5rem;
}

.booking-user-form-grid .form-group {
  margin-bottom: 0;
}

.booking-user-form-grid .form-group label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  color: #fff;
  font-weight: 600;
  font-size: 0.95rem;
}

.booking-user-form-grid .form-group label i {
  color: var(--primary-color);
  font-size: 1.1rem;
}

.booking-user-form-grid .form-group input {
  width: 100%;
  padding: 0.875rem 1.25rem;
  background: var(--light-bg);
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  color: var(--text-color);
  font-size: 0.95rem;
  transition: all 0.3s ease;
}

.booking-user-form-grid .form-group input:focus {
  outline: none;
  border-color: var(--primary-color);
  background: rgba(26, 26, 26, 0.8);
  box-shadow: 0 0 0 4px rgba(229, 56, 59, 0.1);
  transform: translateY(-2px);
}

.booking-user-form-grid .form-group input::placeholder {
  color: #666;
}

.booking-user-form-grid .form-group input:valid {
  border-color: var(--success-color);
}

@media (max-width: 768px) {
  .booking-user-form-grid {
    grid-template-columns: 1fr;
    gap: 1.25rem;
  }
  
  .booking-user-info {
    padding: 1.5rem;
  }
  
  .booking-user-info h3 {
    font-size: 1.1rem;
  }
}

/* Adding styles for additional specifications in booking modal */
.booking-additional-specs {
  width: 100%;
  margin-top: 0.5rem;
  padding: 0.6rem;
  background: rgba(229, 56, 59, 0.1);
  border-radius: 8px;
  border: 1px solid rgba(229, 56, 59, 0.3);
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  font-size: 0.85rem;
  align-items: flex-start;
}

.booking-additional-specs span {
  background: rgba(255, 255, 255, 0.05);
  padding: 0.3rem 0.6rem;
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  border: 1px solid var(--border-color);
}

.booking-additional-specs i {
  font-size: 0.8rem;
  color: var(--primary-color);
}

.booking-features {
  width: 100%;
  margin-top: 0.5rem;
  padding: 0.6rem;
  background: rgba(229, 56, 59, 0.1);
  border-radius: 8px;
  border: 1px solid rgba(229, 56, 59, 0.3);
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
}

.booking-features i {
  color: var(--primary-color);
  margin-top: 0.2rem;
}

.booking-features span {
  flex: 1;
  line-height: 1.4;
}

/* Added styles for multi-region dropdown */
.region-filter-container {
    position: relative;
    width: 100%;
}

.region-filter-button {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    text-align: left;
}

.region-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--light-bg); /* Changed to --light-bg for consistency */
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    margin-top: 4px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.region-option {
    padding: 10px 15px;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.region-option:hover {
    background-color: var(--hover-bg, rgba(255, 255, 255, 0.03)); /* Changed hover background */
}

.region-option label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    width: 100%;
}

.region-checkbox {
    cursor: pointer;
    width: 18px;
    height: 18px;
    accent-color: var(--primary-color); /* Make checkboxes primary color */
}
    </style>
</head>
<body>
    <div id="toastContainer" class="toast-container"></div>

    <div id="homeView" class="view">
        <div class="container">
            <div class="hero">
                <h1 data-i18n="bookingWelcome">მოგესალმებით დაჯავშნის პლატფორმაზე</h1>
                <p data-i18n="bookingSubtitle">დაჯავშნეთ მანქანები და ტურები მარტივად და სწრაფად</p>
                <div id="navbar"></div>
                <div class="nav-cards">
                    <a href="#" class="nav-card" data-view="booking">
                        <div class="nav-card-icon">🚗</div>
                        <h3 data-i18n="bookingCardBook">დაჯავშნა</h3>
                        <p data-i18n="bookingCardBookDesc">დაჯავშნეთ მანქანა ან ტური</p>
                    </a>
                    
                    <a href="#" class="nav-card" data-view="myBookings">
                        <div class="nav-card-icon">📋</div>
                        <h3 data-i18n="bookingCardMyBookings">ჩემი დაჯავშნები</h3>
                        <p data-i18n="bookingCardMyBookingsDesc">ნახეთ თქვენი დაჯავშვნის ისტორია</p>
                    </a>
                    
                    <a href="#" class="nav-card" data-view="notifications">
                        <div class="nav-card-icon">🔔</div>
                        <h3 data-i18n="bookingCardNotifications">შეტყობინებები</h3>
                        <p data-i18n="bookingCardNotificationsDesc">ნახეთ თქვენი შეტყობინებები</p>
                        <span id="notifBadge" class="notif-badge" style="display: none;"></span>
                    </a>
                    
                    <a href="#" class="nav-card1 admin-only" data-view="admin" style="display: none;">
                        <div class="nav-card1-icon">⚙️</div>
                        <h3 data-i18n="bookingCardAdmin">ადმინ პანელი</h3>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="bookingView" class="view" style="display: none;">
        <div class="container">
            <div class="header">
                <h1 data-i18n="bookingCardBook">დაჯავშნა</h1>
                <button class="btn btn-secondary" data-view="home">
                    <i class="fas fa-arrow-left"></i> <span data-i18n="bookingBackBtn">უკან</span>
                </button>
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-tab="cars">
                    <i class="fas fa-car"></i> <span data-i18n="bookingTabCars">მანქანები</span>
                </button>
                <button class="tab-btn" data-tab="tours">
                    <i class="fas fa-map-marked-alt"></i> <span data-i18n="bookingTabTours">ტურები</span>
                </button>
            </div>

            <div class="filters">
                <input type="text" id="searchInput" data-i18n="bookingSearchPlaceholder" placeholder="ძებნა..." class="input">
                
                <div class="price-range-group">
                    <input type="number" id="minPrice" data-i18n="bookingMinPrice" placeholder="მინ. ფასი" class="input" min="0">
                    <span class="price-range-separator">—</span>
                    <input type="number" id="maxPrice" data-i18n="bookingMaxPrice" placeholder="მაქს. ფასი" class="input" min="0">
                </div>
                
                <!-- Changed single select to multi-select with checkboxes -->
                <div class="region-filter-container">
                    <button id="regionFilterButton" class="select region-filter-button">
                        <span id="regionFilterText" data-i18n="bookingAllRegions">ყველა რეგიონი</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="regionFilterDropdown" class="region-dropdown" style="display: none;">
                        <div class="region-option">
                            <label>
                                <input type="checkbox" value="all" id="regionAll" class="region-checkbox">
                                <span data-i18n="bookingAllRegions">ყველა რეგიონი (უნივერსალური)</span>
                            </label>
                        </div>
                        <div class="region-option">
                            <label>
                                <input type="checkbox" value="აფხაზეთი" class="region-checkbox" data-region>
                                <span data-i18n="regionAbkhazia">აფხაზეთი</span>
                            </label>
                        </div>
                        <div class="region-option">
                            <label>
                                <input type="checkbox" value="სამეგრელო-ზემო სვანეთი" class="region-checkbox" data-region>
                                <span data-i18n="regionSamegrelo">სამეგრელო-ზემო სვანეთი</span>
                            </label>
                        </div>
                        <div class="region-option">
                            <label>
                                <input type="checkbox" value="რაჭა-ლეჩხუმი" class="region-checkbox" data-region>
                                <span data-i18n="regionRachaLechkhumi">რაჭა-ლეჩხუმი</span>
                            </label>
                        </div>
                        <div class="region-option">
                            <label>
                                <input type="checkbox" value="იმერეთი" class="region-checkbox" data-region>
                                <span data-i18n="regionImereti">იმერეთი</span>
                            </label>
                        </div>
                        <div class="region-option">
                            <label>
                                <input type="checkbox" value="გურია" class="region-checkbox" data-region>
                                <span data-i18n="regionGuria">გურია</span>
                            </label>
                        </div>
                        <div class="region-option">
                            <label>
                                <input type="checkbox" value="აჭარა" class="region-checkbox" data-region>
                                <span data-i18n="regionAdjara">აჭარა</span>
                            </label>
                        </div>
                        <div class="region-option">
                            <label>
                                <input type="checkbox" value="სამცხე-ჯავახეთი" class="region-checkbox" data-region>
                                <span data-i18n="regionSamtskheJavakheti">სამცხე-ჯავახეთი</span>
                            </label>
                        </div>
                        <div class="region-option">
                            <label>
                                <input type="checkbox" value="შიდა ქართლი" class="region-checkbox" data-region>
                                <span data-i18n="regionShidaKartli">შიდა ქართლი</span>
                            </label>
                        </div>
                        <div class="region-option">
                            <label>
                                <input type="checkbox" value="მცხეთა-მთიანეთი" class="region-checkbox" data-region>
                                <span data-i18n="regionMtskhetaMtianeti">მცხეთა-მთიანეთი</span>
                            </label>
                        </div>
                        <div class="region-option">
                            <label>
                                <input type="checkbox" value="ქვემო ქართლი" class="region-checkbox" data-region>
                                <span data-i18n="regionKvemoKartli">ქვემო ქართლი</span>
                            </label>
                        </div>
                        <div class="region-option">
                            <label>
                                <input type="checkbox" value="კახეთი" class="region-checkbox" data-region>
                                <span data-i18n="regionKakheti">კახეთი</span>
                            </label>
                        </div>
                    </div>
                </div>

                <select id="typeFilter" class="select">
                    <option value="" data-i18n="bookingAllTypes">ყველა ტიპი</option>
                </select>

                <select id="sortBy" class="select">
                    <option value="popularity" data-i18n="bookingSortPopularity">პოპულარობით</option>
                    <option value="newest" data-i18n="bookingSortNewest">უახლესი</option>
                    <option value="oldest" data-i18n="bookingSortOldest">ძველი</option>
                    <option value="price-asc" data-i18n="bookingSortPriceAsc">ფასი: ზრდადობით</option>
                    <option value="price-desc" data-i18n="bookingSortPriceDesc">ფასი: კლებადობით</option>
                </select>
            </div>

            <div id="itemsContainer" class="items-grid"></div>
        </div>
    </div>

    <div id="myBookingsView" class="view" style="display: none;">
        <div class="container">
            <div class="header">
                <h1 data-i18n="bookingCardMyBookings">ჩემი დაჯავშნები</h1>
                <button class="btn btn-secondary" data-view="home">
                    <i class="fas fa-arrow-left"></i> <span data-i18n="bookingBackBtn">უკან</span>
                </button>
            </div>
            <div id="myBookingsContainer" data-i18n-placeholder="bookingMyBookingsLoading"></div>
        </div>
    </div>

    <div id="notificationsView" class="view" style="display: none;">
        <div class="container">
            <div class="header">
                <div class="header-title">
                    <h1 data-i18n="bookingNotificationsTitle">შეტყობინებები</h1>
                    <button class="btn btn-secondary" data-view="home">
                        <i class="fas fa-arrow-left"></i> <span data-i18n="bookingBackBtn">უკან</span>
                    </button>
                </div>
            </div>
            <div id="notificationsContainer" data-i18n-placeholder="bookingNotificationLoading"></div>
        </div>
    </div>

    <div id="bookingModal" class="modal">
      <div class="modal-content booking-modal-content">
        <span class="close" id="closeBookingModal">&times;</span>
        <h2 id="modalTitle" data-i18n="bookingModalTitle">დაჯავშნა</h2>
        
        <div id="modalBody"></div>
        
        <div class="booking-dates-grid">
          <div class="booking-calendar-container" id="startDateCalendarContainer"></div>
          <input type="hidden" id="startDate" />
          <input type="hidden" id="endDate" />
        </div>

        <div class="booking-times-grid" id="timesContainer" style="display: none;">
          <div class="form-group" id="startTimeGroup">
            <label>
              <i class="fas fa-clock"></i>
              <span data-i18n="bookingStartTime">დაწყების დრო</span>
            </label>
            <select id="startTime" class="select">
              <option value="" data-i18n="bookingSelectTime">აირჩიეთ დრო</option>
              <option value="00:00">00:00</option>
              <option value="01:00">01:00</option>
              <option value="02:00">02:00</option>
              <option value="03:00">03:00</option>
              <option value="04:00">04:00</option>
              <option value="05:00">05:00</option>
              <option value="06:00">06:00</option>
              <option value="07:00">07:00</option>
              <option value="08:00">08:00</option>
              <option value="09:00">09:00</option>
              <option value="10:00">10:00</option>
              <option value="11:00">11:00</option>
              <option value="12:00">12:00</option>
              <option value="13:00">13:00</option>
              <option value="14:00">14:00</option>
              <option value="15:00">15:00</option>
              <option value="16:00">16:00</option>
              <option value="17:00">17:00</option>
              <option value="18:00">18:00</option>
              <option value="19:00">19:00</option>
              <option value="20:00">20:00</option>
              <option value="21:00">21:00</option>
              <option value="22:00">22:00</option>
              <option value="23:00">23:00</option>
            </select>
          </div>

          <div class="form-group" id="endTimeGroup">
            <label>
              <i class="fas fa-clock"></i>
              <span data-i18n="bookingEndTime">დასრულების დრო</span>
            </label>
            <select id="endTime" class="select">
              <option value="" data-i18n="bookingSelectTime">აირჩიეთ დრო</option>
              <option value="00:00">00:00</option>
              <option value="01:00">01:00</option>
              <option value="02:00">02:00</option>
              <option value="03:00">03:00</option>
              <option value="04:00">04:00</option>
              <option value="05:00">05:00</option>
              <option value="06:00">06:00</option>
              <option value="07:00">07:00</option>
              <option value="08:00">08:00</option>
              <option value="09:00">09:00</option>
              <option value="10:00">10:00</option>
              <option value="11:00">11:00</option>
              <option value="12:00">12:00</option>
              <option value="13:00">13:00</option>
              <option value="14:00">14:00</option>
              <option value="15:00">15:00</option>
              <option value="16:00">16:00</option>
              <option value="17:00">17:00</option>
              <option value="18:00">18:00</option>
              <option value="19:00">19:00</option>
              <option value="20:00">20:00</option>
              <option value="21:00">21:00</option>
              <option value="22:00">22:00</option>
              <option value="23:00">23:00</option>
            </select>
          </div>
        </div>

        <div id="priceInfo" class="price-info" style="display: none;"></div>

        <div class="booking-user-info">
          <h3><i class="fas fa-user-circle"></i> <span data-i18n="bookingContactInfo">საკონტაქტო ინფორმაცია</span></h3>
          <div class="booking-user-form-grid">
            <div class="form-group">
              <label for="contactName">
                <i class="fas fa-user"></i> <span data-i18n="bookingContactName">სახელი</span> *
              </label>
              <input type="text" id="contactName" data-i18n="bookingContactNamePlaceholder" placeholder="შეიყვანეთ სახელი" required>
            </div>
            <div class="form-group">
              <label for="contactSurname">
                <i class="fas fa-user"></i> <span data-i18n="bookingContactSurname">გვარი</span> *
              </label>
              <input type="text" id="contactSurname" data-i18n="bookingContactSurnamePlaceholder" placeholder="შეიყვანეთ გვარი" required>
            </div>
            <div class="form-group">
              <label for="contactEmail">
                <i class="fas fa-envelope"></i><span data-i18n="bookingContactEmail">ელ-ფოსტა</span> *
              </label>
              <input type="email" id="contactEmail" data-i18n="bookingContactEmailPlaceholder" placeholder="example@email.com" required>
            </div>
            <div class="form-group">
              <label for="contactPhone">
                <i class="fas fa-phone"></i> <span data-i18n="bookingContactPhone">ტელეფონი</span> *
              </label>
              <input type="tel" id="contactPhone" data-i18n="bookingContactPhonePlaceholder" placeholder="+995 555 12 34 56" required>
            </div>
            <!-- დამატებულია აღწერა ველი -->
            <div class="form-group" style="grid-column: 1 / -1;">
              <label for="contactDescription">
                <i class="fas fa-comment-alt"></i> <span data-i18n="bookingContactDescription">აღწერა</span>
              </label>
              <textarea id="contactDescription" class="input" rows="3" data-i18n="bookingContactDescriptionPlaceholder" placeholder="დამატებითი ინფორმაცია ან კომენტარი..."></textarea>
            </div>
            <!-- </CHANGE> -->
          </div>
        </div>

        <button id="confirmBooking" class="btn">
          <i class="fas fa-check-circle"></i>
          <span data-i18n="bookingConfirmBtn">დაჯავშნის დადასტურება</span>
        </button>
      </div>
    </div>

    
    <div id="detailModal" class="modal">
      <div class="modal-content modal-large">
        <span class="close" id="closeDetailModal">&times;</span>
        <!-- <div class="modal-title"></div> --> <!-- Removed modal-title h2 element from detailModal -->
        <div id="detailModalContent"></div>
      </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content confirm-modal-content">
            <h2 id="confirmTitle" data-i18n="postsDeleteCommentConfirm">დადასტურება</h2>
            <p id="confirmMessage"></p>
            <div class="confirm-actions">
                <button class="btn btn-secondary" id="confirmCancel">
                    <i class="fas fa-times"></i> <span data-i18n="myPostsCancel">გაუქმება</span>
                </button>
                <button class="btn" id="confirmOk">
                    <i class="fas fa-check"></i> <span data-i18n="postsDeleteCommentConfirm">დადასტურება</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Helper function to parse duration from tour duration field
        function parseTourDuration(durationString) {
            if (!durationString) return null;
            // Extract number from strings like "3 დღე", "3", "5 დღიანი", etc.
            const match = durationString.match(/(\d+)/);
            return match ? parseInt(match[1]) : null;
        }

        function formatDateToLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseDate(dateString) {
          // Handle both YYYY-MM-DD and other date formats
          if (!dateString) return new Date();
          
          // If it's already in YYYY-MM-DD format
          if (dateString.includes('-')) {
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
          }
          
          // Otherwise try to parse normally
          return new Date(dateString);
        }
        // </CHANGE>

        function getTranslationKeyForValue(value, category) {
          if (!value) return null;
          
          const mappings = {
            fuelType: {
              'ბენზინი': 'fuelTypePetrol',
              'დიზელი': 'fuelTypeDiesel',
              'ელექტრო': 'fuelTypeElectric',
              'ჰიბრიდი': 'fuelTypeHybrid',
              'გაზი': 'fuelTypeGas'
            },
            transmission: {
              'მექანიკური': 'transmissionManual',
              'ავტომატიკური': 'transmissionAutomatic'
            },
            color: {
              'შავი': 'colorBlack',
              'თეთრი': 'colorWhite',
              'ნაცრისფერი': 'colorGray',
              'ვერცხლისფერი': 'colorSilver',
              'წითელი': 'colorRed',
              'ლურჯი': 'colorBlue',
              'ყავისფერი': 'colorBrown',
              'ოქროსფერი': 'colorGold',
              'ნარინჯისფერი': 'colorOrange',
              'მწვანე': 'colorGreen',
              'ყვითალი': 'colorYellow',
              'ღია ლურჯი': 'colorLightBlue',
              'მუქი ლურჯი': 'colorDarkBlue',
              'ბორდო': 'colorBordeaux'
            },
            carType: {
              'სედანი': 'bookingCarTypeSedan',
              'ჯიპი': 'bookingCarTypeJeep',
              'მინივენი': 'bookingCarTypeMinivan',
              'ავტობუსი': 'bookingCarTypeBus'
            },
            type: {
              'კულტურული': 'tourTypeCultural',
              'სათავგადასავლო': 'tourTypeSightseeing',
              'გასტრონომიული': 'tourTypeGastronomic',
              'ისტორიული': 'tourTypeHistorical',
              'ბუნება': 'tourTypeNature'
            },
            region: {
              'თბილისი': 'regionTbilisi',
              'ბათუმი': 'regionBatumi',
              'ქუთაისი': 'regionKutaisi',
              'რუსთავი': 'regionRustavi',
              'გორი': 'regionGori',
              'ზუგდიდი': 'regionZugdidi',
              'თელავი': 'regionTelavi',
              'ფოთი': 'regionPoti',
              'ახალციხე': 'regionAkhaltsikhe',
              'ხაშური': 'regionKhashuri',
              'სენაკი': 'regionSenaki',
              'ზესტაფონი': 'regionZestafoni',
              'მარნეული': 'regionMarneuli',
              'თერჯოლა': 'regionTerjola',
              'ოზურგეთი': 'regionOzurgeti',
              'ქობულეთი': 'regionKobuleti',
              'კასპი': 'regionKaspi',
              'ახალქალაქი': 'regionAkhalkalaki',
              'ცაგერი': 'regionTsageri',
              'საგარეჯო': 'regionSagarejo',
              'ბორჯომი': 'regionBorjomi',
              'თიანეთი': 'regionTianeti',
              'ბოლნისი': 'regionBolnisi',
              'ახმეტა': 'regionAkhmeta',
              'ყვარელი': 'regionKvareli',
              'დედოფლისწყარო': 'regionDedoplistskaro',
              'ონი': 'regionOni',
              'ამბროლაური': 'regionAmbrolauri',
              'ნინოწმინდა': 'regionNinotsminda',
              'მცხეთა': 'regionMtskheta',
              'დუშეთი': 'regionDusheti',
              'გურჯაანი': 'regionGurjaani',
              'სიღნაღი': 'regionSignaghi',
              'ლაგოდეხი': 'regionLagodekhi',
              'წალენჯიხა': 'regionTsalenjikha',
              'ჩხოროწყუ': 'regionChkhorotsku',
              'წალკა': 'regionTsalka',
              'ყაზბეგი': 'regionKazbegi',
              'დმანისი': 'regionDmanisi',
              'ქარელი': 'regionKareli',
              'ვანი': 'regionVani',
              'ხონი': 'regionKhoni',
              'აბაშა': 'regionAbasha',
              'სამტრედია': 'regionSamtredia',
              'მარტვილი': 'regionMartvili',
              'ბაღდათი': 'regionBaghdati',
              'ტყიბული': 'regionTkibuli',
              'ჩიათურა': 'regionChiatura',
              'წყალტუბო': 'regionTskaltubo',
              'ხარაგაული': 'regionKharagauli',
              'საჩხერე': 'regionSachkhere',
              'აფხაზეთი': 'regionAbkhazia',
              'სამეგრელო': 'regionSamegrelo',
              'იმერეთი': 'regionImereti',
              'კახეთი': 'regionKakheti',
              'გურია': 'regionGuria',
              'აჭარა': 'regionAdjara',
              'რაჭა': 'regionRacha',
              'სვანეთი': 'regionSvaneti',
              'სამცხე-ჯავახეთი': 'regionSamtskheJavakheti',
              'მცხეთა-მთიანეთი': 'regionMtskhetaMtianeti',
              'შიდა ქართლი': 'regionShidaKartli',
              'ქვემო ქართლი': 'regionKvemoKartli',
              'რაჭა-ლეჩხუმი': 'regionRachaLechkhumi'
            }
          };
          
          const categoryMap = mappings[category];
          if (!categoryMap) return null;
          
          const key = categoryMap[value];
          return key || null;
        }

        function translateValue(value, category) {
          if (!value) return '';
          
          const key = getTranslationKeyForValue(value, category);
          if (key && window.languageSwitcher) {
            return window.languageSwitcher.translate(key);
          }
          
          return value;
        }

        class AvailabilityCalendar {
            constructor(container, options = {}) {
                this.container = container;
                this.currentDate = new Date();
                this.selectedDates = []; // Array for multiple date selection
                this.onDateSelect = options.onDateSelect || (() => {});
                this.availableDates = options.availableDates || [];
                this.bookedDates = options.bookedDates || [];
                this.itemType = options.itemType || 'cars';
                this.multiSelect = options.multiSelect !== false; // Multi-select enabled by default
                this.minDate = options.minDate || this.getTomorrow();
                this.restrictedMode = options.restrictedMode || false;
                this.calendarMode = options.calendarMode || 'select-unavailable'; // Added for more granular control
                this.tourDuration = options.tourDuration || null; // Expected number of days for tours
                this.tourItem = options.tourItem || null; // Store tour item reference for error messages
                
                this.updateMonthNames();
                
                this.seasons = {
                    spring: { name: 'გაზაფხული', icon: '🌸', months: [2, 3, 4] },
                    summer: { name: 'ზაფხული', icon: '☀️', months: [5, 6, 7] },
                    autumn: { name: 'შემოდგომა', icon: '🍂', months: [8, 9, 10] },
                    winter: { name: 'ზამთარი', icon: '❄️', months: [11, 0, 1] }
                };
                
                this.init();
            }
            
            getTomorrow() {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                return tomorrow;
            }
            
            init() {
                this.render();
            }
            
            getSeason(month) {
                for (let season in this.seasons) {
                    if (this.seasons[season].months.includes(month)) {
                        return { key: season, ...this.seasons[season] };
                    }
                }
            }
            
            updateMonthNames() {
                if (window.languageSwitcher && typeof window.languageSwitcher.getMonthNames === 'function') {
                    this.monthNames = window.languageSwitcher.getMonthNames();
                } else {
                    // Default to Georgian
                    this.monthNames = [
                        'იანვარი', 'თებერვალი', 'მარტი', 'აპრილი', 'მაისი', 'ივნისი',
                        'ივლისი', 'აგვისტო', 'სექტემბერი', 'ოქტომბერი', 'ნოემბერი', 'დეკემბერი'
                    ];
                }
            }
            
            render() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const season = this.getSeason(month);
                
                this.updateMonthNames();
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const prevLastDay = new Date(year, month, 0);
                
                const firstDayIndex = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
                const lastDayDate = lastDay.getDate();
                const prevLastDayDate = prevLastDay.getDate();
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let daysHTML = '';
                
                // Previous month days
                for (let i = firstDayIndex; i > 0; i--) {
                    const day = prevLastDayDate - i + 1;
                    daysHTML += `<div class="day other-month">${day}</div>`;
                }
                
                // Current month days
                for (let i = 1; i <= lastDayDate; i++) {
                    const currentDate = new Date(year, month, i);
                    currentDate.setHours(0, 0, 0, 0);
                    const dateString = formatDateToLocal(currentDate);
                    
                    const isToday = currentDate.getTime() === today.getTime();
                    const isPast = currentDate < this.minDate;
                    const isBeforeMin = this.minDate && currentDate < this.minDate;
                    
                    let classes = 'day';
                    if (isToday) classes += ' today';
                    
                    if (this.restrictedMode) {
                        classes += ' disabled';
                    } else {
                        if (this.itemType === 'tours') {
                            const isBooked = this.bookedDates.includes(dateString);
                            
                            if (isPast || isBeforeMin) {
                                classes += ' disabled';
                            } else if (isBooked) {
                                classes += ' disabled booked';
                            } else {
                                classes += ' available';
                            }
                        } else { // Cars
                            if (this.calendarMode === 'fixed-booked') {
                                const isBooked = this.bookedDates.includes(dateString);
                                if (isPast || isBeforeMin) {
                                    classes += ' disabled';
                                } else if (isBooked) {
                                    classes += ' disabled booked';
                                } else {
                                    classes += ' available';
                                }
                            } else if (this.calendarMode === 'select-unavailable') {
                                const isBooked = this.bookedDates.includes(dateString);
                                if (isBooked || isPast || isBeforeMin) {
                                    classes += ' disabled';
                                    if (isBooked && !isPast) {
                                        classes += ' booked';
                                    }
                                } else {
                                    classes += ' available';
                                }
                            } else {
                                const isAvailable = this.bookedDates.includes(dateString);
                                if (!isAvailable || isPast || isBeforeMin) {
                                    classes += ' disabled';
                                } else {
                                    classes += ' available';
                                }
                            }
                        }
                    }
                    
                    if (this.selectedDates.includes(dateString)) {
                        classes += ' selected';
                    }
                    
                    daysHTML += `<div class="${classes}" data-date="${dateString}">${i}</div>`;
                }
                
                // Next month days
                const totalCells = firstDayIndex + lastDayDate;
                const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
                for (let i = 1; i <= remainingCells; i++) {
                    daysHTML += `<div class="day other-month">${i}</div>`;
                }
                
                const legendHTML = this.restrictedMode 
                    ? `
                        <div class="calendar-legend">
                            <div class="legend-item">
                                <div class="legend-color legend-available"></div>
                                <span data-i18n="bookingCalendarLegendAvailable">${window.languageSwitcher?.translate('bookingCalendarLegendAvailable') || 'ხელმისაწვდომი'}</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color legend-selected"></div>
                                <span data-i18n="bookingCalendarLegendSelected">${window.languageSwitcher?.translate('bookingCalendarLegendSelected') || 'არჩეული'}</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: rgba(85, 85, 85, 0.3); opacity: 0.5;"></div>
                                <span data-i18n="bookingCalendarLegendPast">${window.languageSwitcher?.translate('bookingCalendarLegendPast') || 'გასული'}</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color legend-today"></div>
                                <span data-i18n="bookingCalendarLegendToday">${window.languageSwitcher?.translate('bookingCalendarLegendToday') || 'დღეს'}</span>
                            </div>
                        </div>
                    `
                    : `
                        <div class="calendar-legend">
                            <div class="legend-item">
                                <div class="legend-color legend-available"></div>
                                <span data-i18n="bookingCalendarLegendAvailable">${window.languageSwitcher?.translate('bookingCalendarLegendAvailable') || 'ხელმისაწვდომი'}</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color legend-booked"></div>
                                <span data-i18n="bookingCalendarLegendBooked">${window.languageSwitcher?.translate('bookingCalendarLegendBooked') || 'დაკავებული'}</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color legend-selected"></div>
                                <span data-i18n="bookingCalendarLegendSelected">${window.languageSwitcher?.translate('bookingCalendarLegendSelected') || 'არჩეული'}</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: rgba(85, 85, 85, 0.3); opacity: 0.5;"></div>
                                <span data-i18n="bookingCalendarLegendPast">${window.languageSwitcher?.translate('bookingCalendarLegendPast') || 'გასული'}</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color legend-today"></div>
                                <span data-i18n="bookingCalendarLegendToday">${window.languageSwitcher?.translate('bookingCalendarLegendToday') || 'დღეს'}</span>
                            </div>
                        </div>
                    `;
                // </CHANGE>
                
                const ls = window.languageSwitcher;
                
                const monday = ls ? ls.translate('bookingCalendarMonday') : 'ორშ';
                const tuesday = ls ? ls.translate('bookingCalendarTuesday') : 'სამ';
                const wednesday = ls ? ls.translate('bookingCalendarWednesday') : 'ოთხ';
                const thursday = ls ? ls.translate('bookingCalendarThursday') : 'ხუთ';
                const friday = ls ? ls.translate('bookingCalendarFriday') : 'პარ';
                const saturday = ls ? ls.translate('bookingCalendarSaturday') : 'შაბ';
                const sunday = ls ? ls.translate('bookingCalendarSunday') : 'კვი';
                
                this.container.innerHTML = `
                    <div class="calendar-header">
                        <button class="calendar-nav" id="prevMonth">‹</button>
                        <div class="calendar-title">${season.icon} ${this.monthNames[month]} ${year}</div>
                        <button class="calendar-nav" id="nextMonth">›</button>
                    </div>
                    <div class="calendar-weekdays">
                        <div class="calendar-weekday">${monday}</div>
                        <div class="calendar-weekday">${tuesday}</div>
                        <div class="calendar-weekday">${wednesday}</div>
                        <div class="calendar-weekday">${thursday}</div>
                        <div class="calendar-weekday">${friday}</div>
                        <div class="calendar-weekday">${saturday}</div>
                        <div class="calendar-weekday">${sunday}</div>
                    </div>
                    <div class="calendar-days">
                        ${daysHTML}
                    </div>
                    ${legendHTML}
                `;
                
                // Add event listeners
                this.container.querySelector('#prevMonth').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    this.render();
                });
                
                this.container.querySelector('#nextMonth').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                    this.render();
                });
                
                const clearBtn = this.container.querySelector('#clearSelectionBtn');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => {
                        this.clearSelection();
                    });
                }
                
                // Add click listeners to days
                this.container.querySelectorAll('.day:not(.disabled):not(.other-month)').forEach(day => {
                    day.addEventListener('click', () => {
                        this.selectDate(day.dataset.date);
                    });
                });
            }
            
            selectDate(dateString) {
                if ((this.calendarMode === 'fixed-booked' && this.itemType === 'cars') || 
                    (this.calendarMode === 'fixed-booked' && this.itemType === 'tours')) {
                    
                    if (this.selectedDates.includes(dateString)) {
                        // Date is already selected, clear all selections
                        this.selectedDates = [];
                        this.render();
                        this.onDateSelect(this.selectedDates);
                        return;
                    }
                    
                    // In fixed-booked mode, auto-select all consecutive available days
                    const clickedDate = new Date(dateString);
                    
                    // Check if clicked date is available
                    const isAvailable = !this.bookedDates.includes(dateString) && 
                                       clickedDate >= this.minDate;
                    
                    if (!isAvailable) {
                        return; // Don't select unavailable dates
                    }
                    
                    // Find all consecutive available dates
                    const consecutiveDates = this.findConsecutiveAvailableDates(dateString);
                    
                    // Set selected dates to all consecutive dates
                    this.selectedDates = consecutiveDates;
                    
                    // Re-render to update visual state
                    this.render();
                    this.onDateSelect(this.selectedDates);
                }
                else if (this.itemType === 'tours' && this.tourDuration && !this.restrictedMode) {
                    // For tours with specified duration (not Fixed Time, not Fully Disabled)
                    // When user clicks a date, select exactly that many consecutive days
                    
                    const clickedDate = new Date(dateString);
                    
                    // Check if clicked date is available
                    const isBooked = this.bookedDates.includes(dateString);
                    const isPast = clickedDate < this.minDate;
                    
                    if (isBooked || isPast) {
                        return; // Don't select unavailable dates
                    }
                    
                    // Find consecutive available dates starting from clicked date
                    const consecutiveDates = this.findConsecutiveDaysForTour(dateString, this.tourDuration);
                    
                    if (consecutiveDates.length < this.tourDuration) {
                        // Not enough consecutive days available
                        const durationText = this.tourItem?.duration || `${this.tourDuration} ${window.languageSwitcher?.translate('bookingCalendarDays') || 'დღე'}`;
                        showToast(`არ არის საკმარისი თანმიმდევრული დღეები. ეს ტური საჭიროებს ${durationText} თანმიმდევრულ ხელმისაწვდომ დღეს.`, "warning");
                        return;
                    }
                    
                    // Set selected dates to exactly the tour duration consecutive days
                    this.selectedDates = consecutiveDates;
                    
                    // Re-render to update visual state
                    this.render();
                    this.onDateSelect(this.selectedDates);
                }
                else if (this.multiSelect) {
                    // Original multi-select logic for cars and other non-tour items
                    const index = this.selectedDates.indexOf(dateString);
                    if (index > -1) {
                        // Date already selected, remove it
                        this.selectedDates.splice(index, 1);
                    } else {
                        // Add date to selection
                        this.selectedDates.push(dateString);
                    }
                    
                    // Sort dates chronologically
                    this.selectedDates.sort();
                    
                    // Re-render to update visual state and counter
                    this.render();
                    this.onDateSelect(this.selectedDates);
                } else {
                    // Single selection mode
                    this.selectedDates = [dateString];
                    this.render();
                    this.onDateSelect(dateString);
                }
            }
            
            findConsecutiveDaysForTour(startDateString, requiredDays) {
                const consecutiveDates = [];
                let currentDate = new Date(startDateString);
                
                // Find consecutive available days starting from the clicked date
                for (let i = 0; i < requiredDays; i++) {
                    const dateString = formatDateToLocal(currentDate);
                    const isBooked = this.bookedDates.includes(dateString);
                    const isPast = currentDate < this.minDate;
                    
                    if (isBooked || isPast) {
                        // Hit a booked or past date, can't complete the sequence
                        return consecutiveDates; // Return what we have (will be less than required)
                    }
                    
                    consecutiveDates.push(dateString);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                return consecutiveDates;
            }
            
            findConsecutiveAvailableDates(startDateString) {
                const consecutiveDates = [];
                const startDate = new Date(startDateString);
                
                // Find consecutive dates going forward
                let currentDate = new Date(startDate);
                while (true) {
                    const dateString = formatDateToLocal(currentDate);
                    const isBooked = this.bookedDates.includes(dateString);
                    const isPast = currentDate < this.minDate;
                    
                    if (isBooked || isPast) {
                        break; // Stop if we hit a booked or past date
                    }
                    
                    consecutiveDates.push(dateString);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                // Find consecutive dates going backward (before start date)
                currentDate = new Date(startDate);
                currentDate.setDate(currentDate.getDate() - 1);
                
                const beforeDates = [];
                while (true) {
                    const dateString = formatDateToLocal(currentDate);
                    const isBooked = this.bookedDates.includes(dateString);
                    const isPast = currentDate < this.minDate;
                    
                    if (isBooked || isPast) {
                        break; // Stop if we hit a booked or past date
                    }
                    
                    beforeDates.unshift(dateString); // Add to beginning
                    currentDate.setDate(currentDate.getDate() - 1);
                }
                
                // Combine before and after dates
                return [...beforeDates, ...consecutiveDates].sort();
            }
            
            getSelectedDates() {
                return this.selectedDates;
            }
            
            clearSelection() {
                this.selectedDates = [];
                this.render();
                this.onDateSelect([]);
            }
            
            setAvailableDates(dates) {
                this.availableDates = dates;
                this.render();
            }
            
            setBookedDates(dates) {
                this.bookedDates = dates;
                this.render();
            }
            
            setItemType(type) {
                this.itemType = type;
                this.render();
            }
            
            setRestrictedMode(isRestricted) {
                this.restrictedMode = isRestricted;
                this.render();
            }
        }

        window.AvailabilityCalendar = AvailabilityCalendar;

        // Calendar class for booking modal
        class Calendar {
            constructor(inputElement, options = {}) {
                this.inputElement = inputElement;
                this.minDate = options.minDate || new Date();
                this.bookedDates = options.bookedDates || [];
                this.onSelect = options.onSelect || (() => {});
                this.calendarElement = null;
                this.currentDate = new Date();
                this.selectedDate = null;
                
                this.init();
            }
            
            init() {
                this.createCalendar();
                this.attachEventListeners();
            }
            
            getMonthNames() {
                if (window.languageSwitcher && typeof window.languageSwitcher.getMonthNames === 'function') {
                    return window.languageSwitcher.getMonthNames();
                }
                // Default to Georgian
                return [
                    'იანვარი', 'თებერვალი', 'მარტი', 'აპრილი', 'მაისი', 'ივნისი',
                    'ივლისი', 'აგვისტო', 'სექტემბერი', 'ოქტომბერი', 'ნოემბერი', 'დეკემბერი'
                ];
            }
            
            createCalendar() {
                // Create calendar container
                this.calendarElement = document.createElement('div');
                this.calendarElement.className = 'custom-calendar';
                
                // Position calendar below input
                const rect = this.inputElement.getBoundingClientRect();
                this.calendarElement.style.position = 'absolute';
                this.calendarElement.style.top = `${rect.bottom + window.scrollY}px`;
                this.calendarElement.style.left = `${rect.left + window.scrollX}px`;
                
                // Render calendar content
                this.render();
                
                // Add to document
                document.body.appendChild(this.calendarElement);
            }
            
            render() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const prevLastDay = new Date(year, month, 0);
                
                const firstDayIndex = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
                const lastDayDate = lastDay.getDate();
                const prevLastDayDate = prevLastDay.getDate();
                
                const monthNames = this.getMonthNames();
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let daysHTML = '';
                
                // Previous month days
                for (let i = firstDayIndex; i > 0; i--) {
                    const day = prevLastDayDate - i + 1;
                    daysHTML += `<div class="calendar-day other-month">${day}</div>`;
                }
                
                // Current month days
                for (let day = 1; day <= lastDayDate; day++) {
                    const currentDate = new Date(year, month, day);
                    currentDate.setHours(0, 0, 0, 0);
                    const dateString = formatDateToLocal(currentDate);
                    
                    const isToday = currentDate.getTime() === today.getTime();
                    const isPast = currentDate < this.minDate;
                    const isBooked = this.bookedDates.includes(dateString);
                    const isSelected = this.selectedDate === dateString;
                    
                    let classes = 'calendar-day';
                    if (isToday) classes += ' today';
                    if (isPast || isBooked) classes += ' disabled';
                    if (isSelected) classes += ' selected';
                    
                    daysHTML += `<div class="${classes}" data-date="${dateString}">${day}</div>`;
                }
                
                // Next month days
                const remainingDays = 42 - (firstDayIndex + lastDayDate);
                for (let day = 1; day <= remainingDays; day++) {
                    daysHTML += `<div class="calendar-day other-month">${day}</div>`;
                }
                
                this.calendarElement.innerHTML = `
                    <div class="calendar-header">
                        <button class="calendar-nav prev-month">‹</button>
                        <h2 class="calendar-title">${monthNames[month]} ${year}</h2>
                        <button class="calendar-nav next-month">›</button>
                    </div>
                    <div class="calendar-weekdays">
                        <div class="calendar-weekday">ორშ</div>
                        <div class="calendar-weekday">სამ</div>
                        <div class="calendar-weekday">ოთხ</div>
                        <div class="calendar-weekday">ხუთ</div>
                        <div class="calendar-weekday">პარ</div>
                        <div class="calendar-weekday">შაბ</div>
                        <div class="calendar-weekday">კვი</div>
                    </div>
                    <div class="calendar-days">
                        ${daysHTML}
                    </div>
                `;
                
                // Add click listeners to days
                this.calendarElement.querySelectorAll('.calendar-day:not(.other-month):not(.disabled)').forEach(day => {
                    day.addEventListener('click', () => {
                        this.selectDate(day.dataset.date);
                    });
                });
            }
            
            attachEventListeners() {
                // Previous month
                this.calendarElement.querySelector('.prev-month').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    this.render();
                });
                
                // Next month
                this.calendarElement.querySelector('.next-month').addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                    this.render();
                });
                
                // Close calendar when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.calendarElement.contains(e.target) && e.target !== this.inputElement) {
                        this.close();
                    }
                });
            }
            
            selectDate(dateString) {
                this.selectedDate = dateString;
                this.inputElement.value = dateString;
                this.onSelect(dateString);
                this.close();
            }
            
            close() {
                if (this.calendarElement && this.calendarElement.parentNode) {
                    this.calendarElement.parentNode.removeChild(this.calendarElement);
                }
            }
            
            setMinDate(date) {
                this.minDate = date;
                if (this.calendarElement) {
                    this.render();
                }
            }

            setBookedDates(dates) {
              this.bookedDates = dates;
              if (this.calendarElement) {
                  this.render();
              }
            }
        }

        window.Calendar = Calendar;
    </script>

    <script type="module">
import { auth, db } from "./firebase-config.js"
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js"
import {
  collection,
  addDoc,
  updateDoc,
  deleteDoc,
  doc,
  getDocs,
  getDoc,
  query,
  where,
  orderBy,
  onSnapshot,
  serverTimestamp,
  increment,
  arrayUnion,
  arrayRemove,
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js"

const CLOUD_NAME = "dmxmlw0ln"
const UPLOAD_PRESET = "rentime"

async function uploadImagesToCloudinary(files) {
  const uploadUrls = [];
  const uploadPromises = Array.from(files).map(file => {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', UPLOAD_PRESET);

    return fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
      method: 'POST',
      body: formData,
    })
      .then(response => response.json())
      .then(data => {
        uploadUrls.push(data.secure_url);
      });
  });
  await Promise.all(uploadPromises);
  return uploadUrls;
}

function showToast(message, type = "info", title = "") {
    const container = document.getElementById("toastContainer");
    if (!container) return;

    const icons = {
        success: "✓",
        error: "✗",
        warning: "⚠",
        info: "ℹ",
    };

    // Get translated toast titles using languageSwitcher
    const toastTitles = {
        success: title || (window.languageSwitcher?.translate("toastSuccessTitle") || "Success"),
        error: title || (window.languageSwitcher?.translate("toastErrorTitle") || "Error"),
        warning: title || (window.languageSwitcher?.translate("toastWarningTitle") || "Warning"),
        info: title || (window.languageSwitcher?.translate("toastInfoTitle") || "Info")
    };

    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <div class="toast-icon">${icons[type]}</div>
        <div class="toast-content">
            <div class="toast-title">${toastTitles[type] || toastTitles.info}</div>
            <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close">×</button>
        <div class="toast-progress"></div>
    `;

    container.appendChild(toast);

    // Auto-close toast after 5 seconds
    const autoCloseTimer = setTimeout(() => {
        removeToast(toast);
    }, 5000);

    // Manual close button event listener
    const closeBtn = toast.querySelector(".toast-close");
    closeBtn.addEventListener("click", () => {
        removeToast(toast);
        clearTimeout(autoCloseTimer);
    });

    // Start progress bar animation
    const progressBar = toast.querySelector(".toast-progress");
    progressBar.style.animation = `toastProgress 5s linear forwards`;
}

function removeToast(toast) {
    if (!toast || !toast.parentElement) return;
    toast.classList.add("removing");
    setTimeout(() => {
        if (toast.parentElement) {
            toast.parentElement.removeChild(toast);
        }
    }, 300); // Animation duration for toastSlideOut
}

function showConfirm(message, title = "დადასტურება") {
  return new Promise((resolve) => {
    const modal = document.getElementById("confirmModal")
    const titleEl = document.getElementById("confirmTitle")
    const messageEl = document.getElementById("confirmMessage")
    const okBtn = document.getElementById("confirmOk")
    const cancelBtn = document.getElementById("confirmCancel")

    // Translate title and message if languageSwitcher is available
    titleEl.textContent = window.languageSwitcher?.translate(title) || title;
    messageEl.textContent = window.languageSwitcher?.translate(message) || message;
    
    modal.style.display = "flex"

    const handleOk = () => {
      modal.style.display = "none"
      cleanup()
      resolve(true)
    }

    const handleCancel = () => {
      modal.style.display = "none"
      cleanup()
      resolve(false)
    }

    const cleanup = () => {
      okBtn.removeEventListener("click", handleOk)
      cancelBtn.removeEventListener("click", handleCancel)
    }

    okBtn.addEventListener("click", handleOk)
    cancelBtn.addEventListener("click", handleCancel)
  })
}

async function getTranslation(text, fieldType = null) {
  if (!text || text.trim() === '') {
    return { ka: text, en: text, ru: text };
  }

  // Check if translation already cached
  const cacheKey = `translation_${text}_${fieldType || 'general'}`;
  const cached = sessionStorage.getItem(cacheKey);
  if (cached) {
    return JSON.parse(cached);
  }

  try {
    // Using MyMemory Translation API for real translations
    const enUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=ka|en`;
    const ruUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=ka|ru`;
    
    const [enResponse, ruResponse] = await Promise.all([
      fetch(enUrl),
      fetch(ruUrl)
    ]);
    
    const enData = await enResponse.json();
    const ruData = await ruResponse.json();
    
    const enTranslation = enData.responseData?.translatedText || text;
    const ruTranslation = ruData.responseData?.translatedText || text;

    const result = {
      ka: text,
      en: enTranslation,
      ru: ruTranslation
    };

    sessionStorage.setItem(cacheKey, JSON.JSON.stringify(result));

    return result;
  } catch (error) {
    console.error('[v0] Translation error:', error);
    return { ka: text, en: text, ru: text };
  }
}

let currentUser = null
let isAdmin = false
let currentView = "home"
let currentTab = "cars"
let allCars = []
let allTours = []
let selectedItem = null
let selectedItemType = null
let tourAvailableDates = []
let currentItemType = null

let startCalendar, endCalendar // Renamed from startAvailabilityCalendar, endAvailabilityCalendar

async function setupNotificationsListener() {
  if (!currentUser) return;
  
  const notifQuery = query(
    collection(db, "notifications"),
    where("userId", "==", currentUser.uid),
    where("read", "==", false)
  );
  
  onSnapshot(notifQuery, (snapshot) => {
    const unreadCount = snapshot.size;
    // Use the correct selector for the badge element
    const notifBadge = document.getElementById("notifBadge");
    if (notifBadge) {
      notifBadge.textContent = unreadCount;
      notifBadge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
    }
  });
}

onAuthStateChanged(auth, async (user) => {
  currentUser = user
  if (user) {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    isAdmin = userDoc.exists() && userDoc.data().isAdmin;

    if (isAdmin) {
      document.querySelectorAll(".admin-only").forEach((el) => {
        el.style.display = "flex";
      });
    }

    setupNotificationsListener(); // Call the new function here
  } else {
    isAdmin = false;
    document.querySelectorAll(".admin-only").forEach((el) => (el.style.display = "none"));
  }
});

document.addEventListener("click", (e) => {
  const viewBtn = e.target.closest("[data-view]")
  if (viewBtn) {
    e.preventDefault()
    const view = viewBtn.dataset.view
    navigateToView(view)
  }
})

function navigateToView(view) {
  document.querySelectorAll(".view").forEach((v) => (v.style.display = "none"))

  const viewElement = document.getElementById(`${view}View`)

  if (viewElement) {
    viewElement.style.display = "block"
    currentView = view

    if (view === "booking") {
      loadBookingData()
    } else if (view === "myBookings") {
      loadMyBookings()
    } else if (view === "notifications") {
      loadNotifications()
    } else if (view === "admin") {
      if (!isAdmin) {
        showToast("თქვენ არ გაქვთ ადმინის უფლებები", "error")
        navigateToView("home")
        return
      }
      // Load admin panel from external file
      loadAdminPanel();
    }
  }
}

function loadBookingData() {
  loadCarsAndTours()
  setupBookingFilters()
  setupBookingTabs()
}

async function loadCarsAndTours() {
  try {
    const carsSnapshot = await getDocs(collection(db, "cars"))
    allCars = carsSnapshot.docs.map((doc) => ({ id: doc.id, ...doc.data(), createdAt: doc.data().createdAt?.toDate() || null }))

    const toursSnapshot = await getDocs(collection(db, "tours"))
    allTours = toursSnapshot.docs.map((doc) => ({ id: doc.id, ...doc.data(), createdAt: doc.data().createdAt?.toDate() || null }))

    updateTypeFilter()
    displayItems()
  } catch (error) {
    console.error("Error loading data:", error)
    showToast("მონაცემების ჩატვირთვა ვერ მოხერხდა", "error")
  }
}

function setupBookingTabs() {
  document.querySelectorAll("[data-tab]").forEach((btn) => {
    btn.addEventListener("click", () => {
      document.querySelectorAll("[data-tab]").forEach((b) => b.classList.remove("active"))
      btn.classList.add("active")
      currentTab = btn.dataset.tab
      updateTypeFilter()
      displayItems()
    })
  })
}

function setupBookingFilters() {
  const searchInput = document.getElementById("searchInput")
  const regionFilterButton = document.getElementById("regionFilterButton") // New button element
  const typeFilter = document.getElementById("typeFilter")
  const sortBy = document.getElementById("sortBy")
  const minPrice = document.getElementById("minPrice")
  const maxPrice = document.getElementById("maxPrice")
  ;[searchInput, typeFilter, sortBy, minPrice, maxPrice].forEach((el) => { // Removed regionFilterButton from this list
    if (el) el.addEventListener("change", filterItems) // Use filterItems
    if (el) el.addEventListener("input", filterItems) // Use filterItems
  })

  if (regionFilterButton) {
    // Toggle dropdown
    regionFilterButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const dropdown = document.getElementById("regionFilterDropdown");
        if (dropdown) {
            dropdown.style.display = dropdown.style.display === "none" ? "block" : "none";
        }
    });

    // Close dropdown when clicking outside
    document.addEventListener("click", (e) => {
        const dropdown = document.getElementById("regionFilterDropdown");
        if (dropdown && dropdown.style.display !== "none" && !regionFilterButton.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = "none";
        }
    });
  }

  // Handle checkbox changes
  const regionCheckboxes = document.querySelectorAll('.region-checkbox');
  regionCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
          const regionAll = document.getElementById('regionAll');
          
          if (e.target.value === 'all') {
              // If "All" is checked, uncheck others
              if (e.target.checked) {
                  regionCheckboxes.forEach(cb => {
                      if (cb.value !== 'all') cb.checked = false;
                  });
              }
          } else {
              // If specific region is checked, uncheck "All"
              if (e.target.checked && regionAll) {
                  regionAll.checked = false;
              }
          }
          
          updateRegionFilterText();
          filterItems(); // Trigger filtering
      });
  });
}

function updateRegionFilterText() {
    const regionCheckboxes = document.querySelectorAll('.region-checkbox:checked');
    const regionFilterText = document.getElementById('regionFilterText');
    const regionAll = document.getElementById('regionAll');
    const ls = window.languageSwitcher;
    
    if (regionAll && regionAll.checked) {
        regionFilterText.textContent = ls ? ls.translate('bookingAllRegions') : 'ყველა რეგიონი';
        return;
    }
    
    if (regionCheckboxes.length === 0) {
        // If nothing selected, default to All but don't check the box automatically to avoid confusion
        // or we could say "Select Region"
        regionFilterText.textContent = ls ? ls.translate('bookingAllRegions') : 'ყველა რეგიონი';
    } else if (regionCheckboxes.length === 1) {
        // Show the name of the single selected region
        const regionValue = regionCheckboxes[0].value;
        const regionLabel = translateValue(regionValue, 'region');
        regionFilterText.textContent = regionLabel;
    } else {
        // Show count
        const selectedText = ls ? ls.translate('bookingRegionSelected') : 'რეგიონი არჩეულია';
        regionFilterText.textContent = `${regionCheckboxes.length} ${selectedText}`;
    }
}

function updateTypeFilter() {
  const typeFilter = document.getElementById("typeFilter")
  if (!typeFilter) return

  // Clear and add "All Types" option with translation
  const allTypesText = window.languageSwitcher?.translate("bookingAllTypes") || "ყველა ტიპი";
  typeFilter.innerHTML = `<option value="" data-i18n="bookingAllTypes">${allTypesText}</option>`

  if (currentTab === "cars") {
    const carTypes = [
      { value: 'სედანი', key: 'bookingCarTypeSedan' },
      { value: 'ჯიპი', key: 'bookingCarTypeJeep' },
      { value: 'მინივენი', key: 'bookingCarTypeMinivan' },
      { value: 'ავტობუსი', key: 'bookingCarTypeBus' }
    ];
    carTypes.forEach((type) => {
      const translatedText = window.languageSwitcher?.translate(type.key) || type.value;
      typeFilter.innerHTML += `<option value="${type.value}" data-i18n="${type.key}">${translatedText}</option>`
    })
  } else {
    const tourTypes = [
      { value: 'კულტურული', key: 'tourTypeCultural' }, // Added translations
      { value: 'სათავგადასავლო', key: 'tourTypeSightseeing' },
      { value: 'გასტრონომიული', key: 'tourTypeGastronomic' },
      { value: 'ისტორიული', key: 'tourTypeHistorical' },
      { value: 'ბუნება', key: 'tourTypeNature' }
    ];
    tourTypes.forEach((type) => {
      const translatedText = window.languageSwitcher?.translate(type.key) || type.value;
      typeFilter.innerHTML += `<option value="${type.value}" data-i18n="${type.key}">${translatedText}</option>`
    })
  }
}

// Function to handle all filtering logic
function filterItems() {
  const searchTerm = document.getElementById("searchInput")?.value.toLowerCase() || "";
  const regionCheckboxes = document.querySelectorAll('.region-checkbox:checked');
  let regions = Array.from(regionCheckboxes).map(cb => cb.value);
  
  // If no regions selected or "all" is selected, treat as all regions
  if (regions.length === 0 || regions.includes('all')) {
      regions = ['all'];
  }
  // </CHANGE>

  // Apply type filter
  const type = document.getElementById("typeFilter")?.value || ""
  const sort = document.getElementById("sortBy")?.value || "popularity"
  const minPrice = parseFloat(document.getElementById("minPrice")?.value) || 0
  const maxPrice = parseFloat(document.getElementById("maxPrice")?.value) || Infinity

  let filtered = [...(currentTab === "cars" ? allCars : allTours)]

  if (searchTerm) {
    filtered = filtered.filter(
      (item) => (item.name?.toLowerCase().includes(searchTerm) || item.description?.toLowerCase().includes(searchTerm)),
    )
  }

  if (!regions.includes('all')) {
    filtered = filtered.filter(item => {
      // If item is universal (has 'all' or 'universal' in regions), it should show up regardless of filter
      if (item.region === 'all' || (Array.isArray(item.regions) && item.regions.includes('all'))) {
          return true;
      }

      // Check if item.regions is an array
      if (Array.isArray(item.regions)) {
        // Check for intersection: does the item have ANY of the selected regions?
        return item.regions.some(r => regions.includes(r));
      } else if (item.region) {
        // If item.region is a string, check if it matches ANY selected region
        return regions.includes(item.region);
      }
      return false; // No region info
    });
  }
  // </CHANGE>

  // Apply type filter
  if (type) {
    filtered = filtered.filter((item) => item.type === type)
  }

  // Apply price filter
  if (minPrice > 0 || maxPrice < Infinity) {
    filtered = filtered.filter((item) => {
      const price = item.pricePerDay || 0
      return price >= minPrice && price <= maxPrice
    })
  }

  if (sort === "price-asc") {
    filtered.sort((a, b) => (a.pricePerDay || 0) - (b.pricePerDay || 0))
  } else if (sort === "price-desc") {
    filtered.sort((a, b) => (b.pricePerDay || 0) - (a.pricePerDay || 0))
  } else if (sort === "popularity") {
    filtered.sort((a, b) => (b.likes || 0) - (a.likes || 0))
  } else if (sort === "newest") {
    filtered.sort((a, b) => {
      const aTime = a.createdAt?.seconds || a.createdAt?.getTime?.() / 1000 || 0
      const bTime = b.createdAt?.seconds || b.createdAt?.getTime?.() / 1000 || 0
      return bTime - aTime
    })
  } else if (sort === "oldest") {
    filtered.sort((a, b) => {
      const aTime = a.createdAt?.seconds || a.createdAt?.getTime?.() / 1000 || 0
      const bTime = b.createdAt?.seconds || b.createdAt?.getTime?.() / 1000 || 0
      return aTime - bTime
    })
  }

  displayItems(filtered) // Pass filtered items to display
}


function displayItems(itemsToDisplay) { // Accept filtered items as argument
  const container = document.getElementById("itemsContainer")
  if (!container) return

  // Use the provided itemsToDisplay if available, otherwise fetch and filter
  const items = itemsToDisplay || (currentTab === "cars" ? allCars : allTours)

  if (items.length === 0) {
    const notFoundText = window.languageSwitcher?.translate("bookingNotFound") || "მონაცემები არ მოიძებნა";
    container.innerHTML = `<div class="empty-state">${notFoundText}</div>`
    return
  }

  container.innerHTML = items.map((item) => createItemCard(item, currentTab)).join("")

  container.querySelectorAll(".card-clickable").forEach((card) => {
    card.addEventListener("click", (e) => {
      if (e.target.closest(".book-btn")) return
      if (e.target.closest(".popularity-btn")) return

      const itemId = card.dataset.id
      const item = items.find((i) => i.id === itemId)
      
      openDetailModal(item, currentTab)
    })
  })

  container.querySelectorAll(".book-btn").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation()
      const itemId = btn.dataset.id
      const item = items.find((i) => i.id === itemId)
      openBookingModal(item, currentTab)
    })
  })

  container.querySelectorAll(".popularity-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      e.stopPropagation()
      const itemId = btn.dataset.id
      await toggleLike(itemId, currentTab)
    })
  })
}

async function toggleLike(itemId, type) {
  if (!currentUser) {
    showToast("გთხოვთ შეხვიდეთ სისტემაში", "warning")
    // showAuthOverlay() // No longer needed for booking
    return
  }

  try {
    const collectionName = type === "cars" ? "cars" : "tours"
    const itemRef = doc(db, collectionName, itemId)
    const itemDoc = await getDoc(itemRef)
    
    if (!itemDoc.exists()) return
    
    const itemData = itemDoc.data()
    const likedBy = itemData.likedBy || []
    const isLiked = likedBy.includes(currentUser.uid)
    
    if (isLiked) {
      await updateDoc(itemRef, {
        likes: increment(-1),
        likedBy: arrayRemove(currentUser.uid)
      })
      
      if (type === "cars") {
        const car = allCars.find(c => c.id === itemId)
        if (car) {
          car.likes = (car.likes || 1) - 1
          car.likedBy = car.likedBy.filter(uid => uid !== currentUser.uid)
        }
      } else {
        const tour = allTours.find(t => t.id === itemId)
        if (tour) {
          tour.likes = (tour.likes || 1) - 1
          tour.likedBy = tour.likedBy.filter(uid => uid !== currentUser.uid)
        }
      }
      
      showToast("მოწონება წაიშალა", "info")
    } else {
      await updateDoc(itemRef, {
        likes: increment(1),
        likedBy: arrayUnion(currentUser.uid)
      })
      
      if (type === "cars") {
        const car = allCars.find(c => c.id === itemId)
        if (car) {
          car.likes = (car.likes || 0) + 1
          car.likedBy = [...(car.likedBy || []), currentUser.uid]
        }
      } else {
        const tour = allTours.find(t => t.id === itemId)
        if (tour) {
          tour.likes = (tour.likes || 0) + 1
          tour.likedBy = [...(tour.likedBy || []), currentUser.uid]
        }
      }
      
      showToast("მოწონება დაემატა", "success")
    }
    
    displayItems() // Re-display items to update like count and icon
  } catch (error) {
    console.error("Error toggling like:", error)
    showToast("მოწონების დამატება/წაშლა ვერ მოხერხდა", "error")
  }
}

function createItemCard(item, type) {
  const lang = window.languageSwitcher?.getCurrentLanguage() || 'ka';
  
  // Translate all fields
  const name = (lang !== 'ka' && item.nameTranslations?.[lang]) ? item.nameTranslations[lang] : item.name;
  const description = (lang !== 'ka' && item.descriptionTranslations?.[lang]) ? item.descriptionTranslations[lang] : (item.description || "");
  
  // --- Region Translation Update ---
  let regionDisplay = '';
  if (item.region === 'all' || (Array.isArray(item.regions) && item.regions.includes('all'))) {
      regionDisplay = window.languageSwitcher?.translate('bookingAllRegions') || 'ყველა რეგიონი (უნივერსალური)';
  } else if (Array.isArray(item.regions) && item.regions.length > 0) {
      if (item.regions.length === 1) {
          const translationKey = getRegionTranslationKey(item.regions[0]);
          regionDisplay = window.languageSwitcher?.translate(translationKey) || item.regions[0];
      } else {
          regionDisplay = item.regions.map(region => {
              const translationKey = getRegionTranslationKey(region);
              return window.languageSwitcher?.translate(translationKey) || region;
          }).join(', ');
      }
  } else {
      const translationKey = getRegionTranslationKey(item.region);
      regionDisplay = window.languageSwitcher?.translate(translationKey) || item.region;
  }
  // --- End Region Translation Update ---

  const type_translated = (lang !== 'ka' && item.typeTranslations?.[lang]) ? item.typeTranslations[lang] : item.type;
  const fuelType = (lang !== 'ka' && item.fuelTypeTranslations?.[lang]) ? item.fuelTypeTranslations[lang] : item.fuelType;
  const transmission = (lang !== 'ka' && item.transmissionTranslations?.[lang]) ? item.transmissionTranslations[lang] : item.transmission;
  const color = (lang !== 'ka' && item.colorTranslations?.[lang]) ? item.colorTranslations[lang] : item.color;
  const features = (lang !== 'ka' && item.featuresTranslations?.[lang]) ? item.featuresTranslations[lang] : item.features;
  const route = (lang !== 'ka' && item.routeTranslations?.[lang]) ? item.routeTranslations[lang] : item.route;
  const duration = (lang !== 'ka' && item.durationTranslations?.[lang]) ? item.durationTranslations[lang] : item.duration;
  
  const imageUrl =
    item.images?.[0] ||
    `https://via.placeholder.com/300x200/e0e0e0/666666?text=${encodeURIComponent(name || "No Image")}`

  const isLiked = currentUser && item.likedBy?.includes(currentUser.uid)
  const likeClass = isLiked ? "liked" : ""
  const heartIcon = isLiked ? "fas fa-heart" : "far fa-heart"

  const licensePlateBadge = type === "cars" && item.licensePlate 
    ? `<div class="license-plate-badge"><i class="fas fa-id-card"></i> ${item.licensePlate}</div>` 
    : ''
  
  const ls = window.languageSwitcher;
  const perDay = ls ? ls.translate('bookingPerDay') : '/დღე';
  const doors = ls ? ls.translate('bookingDoors') : 'კარი';
  const seats = ls ? ls.translate('bookingSeats') : 'ადგილი';
  const withDriver = ls ? ls.translate('bookingWithDriver') : 'მძღოლით';
  const durationLabel = ls ? ls.translate('bookingDuration') : 'ხანგრძლივობა';
  const capacity = ls ? ls.translate('bookingCapacity') : 'ადგილები';
  const bookBtn = ls ? ls.translate('bookingCardBook') : 'დაჯავშნა';

  
  // </CHANGE>

  if (type === "cars") {
    return `
            <div class="card card-clickable" data-id="${item.id}">
                <img src="${imageUrl}" alt="${name}" class="card-image">
                ${licensePlateBadge}
                <button class="popularity-btn ${likeClass}" data-id="${item.id}" title="${ls ? ls.translate('bookingLikeBtn') : 'მოწონება'}">
                    <i class="${heartIcon}"></i>
                    <span>${item.likes || 0}</span>
                </button>
                <div class="card-content">
                    <h3>${name}</h3>
                    <p class="card-description">${description}</p>
                    <div class="card-details">
                        <!-- Updated region display -->
                        <span>📍 ${regionDisplay}</span>
                        <!-- </CHANGE> -->
                        <span>🚗 ${translateValue(item.type, 'carType')}</span>
                        <span>🚪 ${item.doors} ${doors}</span>
                        <span>👥 ${item.seats} ${seats}</span>
                        ${fuelType ? `<span>⛽ ${translateValue(fuelType, 'fuelType')}</span>` : ''}
                        ${transmission ? `<span>⚙️ ${translateValue(transmission, 'transmission')}</span>` : ''}
                        ${item.year ? `<span>📅 ${item.year}</span>` : ''}
                        ${color ? `<span>🎨 ${translateValue(color, 'color')}</span>` : ''}
                        ${item.engineCapacity ? `<span>🔧 ${item.engineCapacity}L</span>` : ''}
                        ${item.withDriver ? `<span class="with-driver">👨‍✈️ ${withDriver}</span>` : ''}
                    </div>
                    <div class="card-footer">
                        <div class="price">${item.pricePerDay}₾${perDay}</div>
                        <button class="btn btn-sm book-btn" data-id="${item.id}">${bookBtn}</button>
                    </div>
                </div>
            </div>
        `
  } else {
    const tourLicensePlateBadge = item.licensePlate 
      ? `<div class="license-plate-badge"><i class="fas fa-hashtag"></i> ${item.licensePlate}</div>` 
      : '';
    
    return `
            <div class="card card-clickable" data-id="${item.id}">
                <img src="${imageUrl}" alt="${name}" class="card-image">
                ${tourLicensePlateBadge}
                <button class="popularity-btn ${likeClass}" data-id="${item.id}" title="${ls ? ls.translate('bookingLikeBtn') : 'მოწონება'}">
                    <i class="${heartIcon}"></i>
                    <span>${item.likes || 0}</span>
                </button>
                <div class="card-content">
                    <h3>${name}</h3>
                    <p class="card-description">${description}</p>
                    <div class="card-details">
                        <span>📍 ${regionDisplay}</span>
                        <span>🎯 ${translateValue(item.type, 'type')}</span>
                        <span>🕒 ${duration}</span>
                        <span>👥 ${item.capacity} ${capacity}</span>
                    </div>
                    <div class="card-footer">
                        <div class="price">${item.pricePerDay}₾</div>
                        <button class="btn btn-sm book-btn" data-id="${item.id}">${bookBtn}</button>
                    </div>
                </div>
            </div>
        `
  }
}

window.changeDetailImage = (direction) => {
  const images = window.detailImages
  if (!images || images.length <= 1) return

  window.currentDetailImageIndex = (window.currentDetailImageIndex + direction + images.length) % images.length
  setDetailImage(window.currentDetailImageIndex)
}

window.setDetailImage = (index) => {
  const images = window.detailImages
  if (!images) return

  window.currentDetailImageIndex = index
  const mainImage = document.getElementById("detailMainImage")
  if (mainImage) {
    mainImage.src = images[index]
  }

  document.querySelectorAll(".detail-thumbnail").forEach((thumb, i) => {
    thumb.classList.toggle("active", i === index)
  })
}

window.bookFromDetail = () => {
  closeDetailModal()
  openBookingModal(selectedItem, selectedItemType)
}

window.closeDetailModal = () => {
  document.getElementById("detailModal").style.display = "none"
}

function closeDetailModal() {
  window.closeDetailModal()
}

function setDetailImage(index) {
  window.setDetailImage(index)
}

async function openBookingModal(item, type) {
  selectedItem = item
  selectedItemType = type

  const lang = window.languageSwitcher?.getCurrentLanguage() || 'ka';
  
  // Translate all fields
  const name = (lang !== 'ka' && item.nameTranslations?.[lang]) ? item.nameTranslations[lang] : item.name;
  const description = (lang !== 'ka' && item.descriptionTranslations?.[lang]) ? item.descriptionTranslations[lang] : (item.description || "");
  
  // --- Region Translation Update in Modal ---
  let regionModalText = '';
  if (item.region === 'all' || (Array.isArray(item.regions) && item.regions.includes('all'))) {
      regionModalText = window.languageSwitcher?.translate('bookingAllRegions') || 'ყველა რეგიონი (უნივერსალური)';
  } else if (Array.isArray(item.regions) && item.regions.length > 0) {
      regionModalText = item.regions.map(region => {
          const translationKey = getRegionTranslationKey(region);
          return window.languageSwitcher?.translate(translationKey) || region;
      }).join(', ');
  } else {
      const translationKey = getRegionTranslationKey(item.region);
      regionModalText = window.languageSwitcher?.translate(translationKey) || item.region;
  }
  // --- End Region Translation Update ---
  
  const type_translated = (lang !== 'ka' && item.typeTranslations?.[lang]) ? item.typeTranslations[lang] : item.type;
  const fuelType = (lang !== 'ka' && item.fuelTypeTranslations?.[lang]) ? item.fuelTypeTranslations[lang] : item.fuelType;
  const transmission = (lang !== 'ka' && item.transmissionTranslations?.[lang]) ? item.transmissionTranslations[lang] : item.transmission;
  const color = (lang !== 'ka' && item.colorTranslations?.[lang]) ? item.colorTranslations[lang] : item.color;
  const features = (lang !== 'ka' && item.featuresTranslations?.[lang]) ? item.featuresTranslations[lang] : item.features;
  const route = (lang !== 'ka' && item.routeTranslations?.[lang]) ? item.routeTranslations[lang] : item.route;
  const duration = (lang !== 'ka' && item.durationTranslations?.[lang]) ? item.durationTranslations[lang] : item.duration;
  
  const modal = document.getElementById("bookingModal")
  const modalBody = document.getElementById("modalBody")
  
  const images =
    item.images && item.images.length > 0
      ? item.images
      : [`https://placehold.co/150x100/e0e0e0/666666?text=${encodeURIComponent(name || "No Image")}`]

  const ls = window.languageSwitcher;
  const bookingTitle = ls ? ls.translate('bookingModalTitle') : 'დაჯავშნა';
  
  const itemNameTranslations = await getTranslation(item.name);
  const currentLang = ls ? ls.getCurrentLanguage() : 'ka';
  const translatedItemName = itemNameTranslations[currentLang] || item.name;
  
  modalTitle.textContent = `${bookingTitle}: ${translatedItemName}`

  const imageUrl =
    item.images?.[0] ||
    `https://placehold.co/150x100/e0e0e0/666666?text=${encodeURIComponent(item.name || "No Image")}`
  
  const licensePlateHtml = type === "cars" && item.licensePlate 
    ? `<div class="booking-license-plate"><i class="fas fa-id-card"></i> ${item.licensePlate}</div>` 
    : '';
  
  const isRestricted = item.restrictedMode || false;
  
  const perDay = ls ? ls.translate('bookingPerDay') : 'დღე';
  const perTour = ls ? ls.translate('bookingPerTour') : 'ტური';
  const withDriver = ls ? ls.translate('bookingWithDriver') : 'მძღოლით';
  const fullyBookedTitle = ls ? ls.translate('bookingFullyBooked') : 'სრულად დაკავებულია';
  const fullyBookedMsg = ls ? ls.translate('bookingFullyBookedMessage') : `ამ ${type === "cars" ? "მანქანას" : "ტურს"} ამჟამად არ აქვს ხელმისაწვდომი თარიღები`;
  
  const translatedFuelType = translateValue(item.fuelType, 'fuelType');
  const translatedTransmission = translateValue(item.transmission, 'transmission');
  const translatedColor = translateValue(item.color, 'color');

  if (isRestricted) {
    modalBody.innerHTML = `
      <div class="booking-item-info">
          <img src="${imageUrl}" alt="${translatedItemName}">
          <div class="booking-item-details">
              <h3>${translatedItemName}</h3>
              ${licensePlateHtml}
              <div class="location">
                  <i class="fas fa-map-marker-alt"></i>
                  ${regionModalText || 'N/A'}
              </div>
              <div class="price">${item.pricePerDay}₾/${type === "cars" ? perDay : perTour}</div>
          </div>
      </div>
      <div style="padding: 2rem; background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; border-radius: 12px; text-align: center; margin-top: 1.5rem;">
          <i class="fas fa-ban" style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;"></i>
          <h3 style="color: #fff; font-weight: 600; margin-bottom: 0.5rem;">${fullyBookedTitle}</h3>
          <p style="color: var(--text-color); font-size: 1rem;">${fullyBookedMsg}</p>
      </div>
    `;
    
    timesContainer.style.display = "none";
    if (priceInfo) priceInfo.style.display = "none";
    
    const confirmBtn = document.getElementById("confirmBooking");
    if (confirmBtn) {
      confirmBtn.style.display = "none";
    }
    
    modal.style.display = "flex";
    return;
  }
  
  modalBody.innerHTML = `
      <div class="booking-item-info">
          <img src="${imageUrl}" alt="${translatedItemName}">
          <div class="booking-item-details">
              <h3>${translatedItemName}</h3>
              ${licensePlateHtml}
              <div class="location">
                  <i class="fas fa-map-marker-alt"></i>
                  ${regionModalText || 'N/A'}
              </div>
              <div class="price">${item.pricePerDay}₾/${type === "cars" ? perDay : perTour}</div>
              ${type === "cars" ? `
                <div class="booking-additional-specs">
                  ${item.fuelType ? `<span><i class="fas fa-gas-pump"></i> ${translatedFuelType}</span>` : ''}
                  ${item.transmission ? `<span><i class="fas fa-cog"></i> ${translatedTransmission}</span>` : ''}
                  ${item.year ? `<span><i class="fas fa-calendar"></i> ${item.year}</span>` : ''}
                  ${item.color ? `<span><i class="fas fa-palette"></i> ${translatedColor}</span>` : ''}
                  ${item.engineCapacity ? `<span><i class="fas fa-tachometer-alt"></i> ${item.engineCapacity}L</span>` : ''}
                  ${item.withDriver ? `<span class="with-driver"><i class="fas fa-user-tie"></i> ${withDriver}</span>` : ''}
                  ${item.features ? `<div class="booking-features"><i class="fas fa-star"></i> <span>${item.features}</span></div>` : ''}
                </div>
              ` : ''}
          </div>
      </div>
  `

  if (type === "tours") {
    timesContainer.style.display = "none"
  } else {
    timesContainer.style.display = "grid"
  }

  const confirmBtn = document.getElementById("confirmBooking");
  if (confirmBtn) {
    confirmBtn.style.display = "inline-flex";
  }

  let tourDurationDays = null;
  if (type === "tours" && item.duration) {
    tourDurationDays = parseTourDuration(item.duration);
  }
  
  setTimeout(() => {
    startCalendar = new AvailabilityCalendar(startDateCalendarContainer, {
      itemType: type,
      bookedDates: item.bookedDates || [],
      availableDates: item.availableDates || [],
      calendarMode: item.calendarMode || 'select-unavailable',
      restrictedMode: isRestricted,
      multiSelect: type === "cars",
      tourDuration: tourDurationDays,
      tourItem: item,
      onDateSelect: (dates) => {
        if (type === "tours") {
          document.getElementById("startDate").value = dates[0] || "";
          document.getElementById("endDate").value = dates[0] || "";
        } else {
          document.getElementById("startDate").value = dates[0] || "";
          document.getElementById("endDate").value = dates[dates.length - 1] || "";
        }
        updateBookingPrice();
      },
    });
  }, 50);

  modal.style.display = "flex"
  if (priceInfo) priceInfo.style.display = "none"
}

function updateBookingPrice() {
  const startDateInput = document.getElementById("startDate");
  const endDateInput = document.getElementById("endDate");
  const priceInfo = document.getElementById("priceInfo");
  
  if (!priceInfo) return;

  const startDateValue = startDateInput?.value || "";
  const endDateValue = endDateInput?.value || "";

  if (!startDateValue || !endDateValue || !selectedItem) {
    priceInfo.style.display = "none";
    priceInfo.innerHTML = "";
    return;
  }

  const start = parseDate(startDateValue);
  const end = parseDate(endDateValue);
  
  let days = 1;
  if (selectedItemType === "cars") {
    // Use the calendar's selected dates for accurate count
    if (startCalendar && startCalendar.selectedDates && startCalendar.selectedDates.length > 0) {
      days = startCalendar.selectedDates.length;
    } else {
      // Fallback: inclusive day count
      const diffTime = end.getTime() - start.getTime();
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      days = Math.max(1, diffDays + 1);
    }
  } else if (selectedItemType === "tours" && startCalendar && startCalendar.selectedDates) {
    days = startCalendar.selectedDates.length;
  }

  if (selectedItemType === "cars" && end < start) {
    const warningText = window.languageSwitcher?.translate('bookingToastEndDateAfter') || 'დასრულების თარიღი უნდა იყოს დაწყების თარიღის შემდეგ';
    priceInfo.style.display = "block";
    priceInfo.innerHTML = `<p class="warning-text"><i class="fas fa-exclamation-triangle"></i>${warningText}</p>`;
    priceInfo.style.background = "transparent";
    return;
  }

  const total = days * selectedItem.pricePerDay;
  
  // Use languageSwitcher for date formatting
  const formatDate = (date) => {
    if (window.languageSwitcher) {
      const currentLang = window.languageSwitcher.getCurrentLanguage();
      return date.toLocaleDateString(currentLang === 'ka' ? 'ka-GE' : currentLang === 'ru' ? 'ru-RU' : 'en-US');
    }
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${month}/${day}/${year}`;
  };
  
  const startFormatted = formatDate(start);
  const endFormatted = formatDate(end);
  
  priceInfo.style.display = "block";
  priceInfo.style.background = "rgba(0, 0, 0, 0)";
  
  const ls = window.languageSwitcher;
  
  // Updated translation keys for date labels
  const fromDateLabel = ls ? ls.translate('bookingPriceFromDateLabel') || 'დან' : 'დან';
  const toDateLabel = ls ? ls.translate('bookingPriceToDateLabel') || 'მდე' : 'მდე';
  
  if (selectedItemType === "tours") {
    const periodLabel = ls ? ls.translate('bookingPricePeriod') : 'პერიოდი';
    const tourLabel = ls ? ls.translate('bookingTour') : 'ტური';
    const totalLabel = ls ? ls.translate('bookingPriceTotal') : 'სულ';
    
    getTranslation(selectedItem.name).then(translations => {
      const currentLang = ls ? ls.getCurrentLanguage() : 'ka';
      const translatedName = translations[currentLang] || selectedItem.name;
      
      priceInfo.innerHTML = `
        <div class="price-breakdown">
            <p><i class="fas fa-calendar-alt"></i> ${periodLabel}: ${startFormatted} ${fromDateLabel} ${endFormatted} ${toDateLabel}</p>
            <p><i class="fas fa-route"></i> ${tourLabel}: ${translatedName}</p>
            <p><strong><i class="fas fa-money-bill-wave"></i> ${totalLabel}: ${total}₾</strong></p>
        </div>
      `;
    });
  } else { // For cars
    const periodLabel = ls ? ls.translate('bookingPricePeriod') : 'პერიოდი';
    const daysLabel = ls ? ls.translate('bookingPriceDays') : 'დღე';
    const totalLabel = ls ? ls.translate('bookingPriceTotal') : 'სულ';
    
    priceInfo.innerHTML = `
      <div class="price-breakdown">
          <p><i class="fas fa-calendar-alt"></i> ${periodLabel}: ${startFormatted} ${fromDateLabel} ${endFormatted} ${toDateLabel}</p>
          <p><i class="fas fa-calendar-day"></i> ${days} ${daysLabel} × ${selectedItem.pricePerDay}₾</p>
          <p><strong><i class="fas fa-money-bill-wave"></i> ${totalLabel}: ${total}₾</strong></p>
      </div>
    `;
  }
}


document.getElementById("confirmBooking")?.addEventListener("click", async () => {
  const startDateInput = document.getElementById("startDate");
  const endDateInput = document.getElementById("endDate");
  const startTimeInput = document.getElementById("startTime");
  const endTimeInput = document.getElementById("endTime");
  
  const contactName = document.getElementById("contactName")?.value?.trim() || '';
  const contactSurname = document.getElementById("contactSurname")?.value?.trim() || '';
  const contactEmail = document.getElementById("contactEmail")?.value?.trim() || '';
  const contactPhone = document.getElementById("contactPhone")?.value?.trim() || '';
  
  const startDate = startDateInput?.value || '';
  const endDate = endDateInput?.value || '';
  const startTime = startTimeInput?.value || '';
  const endTime = endTimeInput?.value || '';

  if (!contactName || !contactSurname || !contactEmail || !contactPhone) {
    showToast(window.languageSwitcher?.translate('bookingToastFillAllFields') || "გთხოვთ შეავსოთ ყველა საკონტაქტო ველი", "warning");
    return;
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(contactEmail)) {
    showToast(window.languageSwitcher?.translate('bookingToastValidEmail') || "გთხოვთ შეიყვანოთ სწორი ელ-ფოსტის მისამართი", "warning");
    return;
  }

  if (!startDate || !endDate) {
    showToast(window.languageSwitcher?.translate('bookingToastSelectDates') || "გთხოვთ აირჩიოთ თარიღები კალენდარიდან", "warning");
    return;
  }

  if (selectedItemType === "cars") {
    const start = parseDate(startDate);
    const end = parseDate(endDate);
    if (end < start) {
      showToast(window.languageSwitcher?.translate('bookingToastEndDateAfter') || "დასრულების თარიღი უნდა იყოს დაწყების თარიღის შემდეგ", "warning");
      return;
    }
  }

  if (selectedItemType === "tours" && selectedItem.duration && selectedItem.calendarMode !== 'fixed-booked') {
    const tourDurationDays = parseTourDuration(selectedItem.duration);
    if (tourDurationDays && startCalendar && startCalendar.selectedDates) {
      const selectedDaysCount = startCalendar.selectedDates.length;
      if (selectedDaysCount !== tourDurationDays) {
        const durationText = selectedItem.duration;
        showToast(`ეს ტური არის ${durationText}. გთხოვთ აირჩიოთ ზუსტად ${tourDurationDays} დღე.`, "warning");
        return;
      }
    }
  }

  const start = parseDate(startDate);
  const end = parseDate(endDate);
  
  let days = 1;
  if (selectedItemType === "cars") {
    if (startCalendar && startCalendar.selectedDates && startCalendar.selectedDates.length > 0) {
      days = startCalendar.selectedDates.length;
    } else {
      const diffTime = end.getTime() - start.getTime();
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      days = Math.max(1, diffDays + 1);
    }
  } else if (selectedItemType === "tours" && startCalendar && startCalendar.selectedDates) {
    days = startCalendar.selectedDates.length;
  }

  const total = days * selectedItem.pricePerDay;

  const confirmBtn = document.getElementById("confirmBooking");
  const originalText = confirmBtn.textContent; // Store original text
  // </CHANGE>
  confirmBtn.disabled = true
  confirmBtn.textContent = window.languageSwitcher?.translate("bookingLoading") || "იტვირთება...";

  try {
    const bookingData = {
      itemType: selectedItemType,
      itemId: selectedItem.id,
      itemName: selectedItem.name,
      // itemImage: selectedItem.images?.[0] || "", // Added itemImage and itemRegion/itemRegions
      itemImage: selectedItem.images?.[0] || "",
      itemRegion: selectedItem.region || "",
      itemRegions: selectedItem.regions || [],
      startDate,
      endDate,
      duration: days, // Use calculated days
      // basePrice: parseFloat(selectedItem.price), // Removed basePrice, using pricePerDay instead
      totalPrice: total,
      status: "მოლოდინში", // Changed from "pending" to Georgian
      createdAt: serverTimestamp(),
      contactName: contactName,
      contactSurname: contactSurname,
      contactEmail: contactEmail,
      contactPhone: contactPhone,
      contactDescription: document.getElementById("contactDescription")?.value?.trim() || '', // Store description
      // Keep nested object for backward compatibility if needed, or structured access
      contactInfo: {
        firstName: contactName,
        lastName: contactSurname,
        email: contactEmail,
        phone: contactPhone,
      },
      // </CHANGE>
      // Add userId only if user is authenticated
      ...(currentUser && { userId: currentUser.uid }),
      ...(currentUser && { userEmail: currentUser.email }),
      ...( !currentUser && { isGuest: true }), // Mark as guest if not authenticated
      // </CHANGE>
    };

    // Add all selected dates for better tracking
    if (startCalendar && startCalendar.selectedDates && startCalendar.selectedDates.length > 0) {
      bookingData.selectedDates = startCalendar.selectedDates;
    }

    if (selectedItemType === "cars" && selectedItem.licensePlate) {
      bookingData.licensePlate = selectedItem.licensePlate;
    }

    const docRef = await addDoc(collection(db, "bookings"), bookingData);

    try {
      const usersSnapshot = await getDocs(collection(db, "users"));
      const adminUsers = usersSnapshot.docs.filter((doc) => doc.data().isAdmin === true).map((doc) => doc.id);

      const notificationTitle = window.languageSwitcher?.translate("bookingNotificationNewRequest") || "🔔 ახალი დაჯავშნის მოთხოვნა";
      const requestFromText = window.languageSwitcher?.translate("bookingNotificationRequestFrom") || "ითხოვს დაჯავშნას:";
      const goToManageText = window.languageSwitcher?.translate("bookingNotificationGoToManage") || "გადადით \"დაჯავშნის მართვა\" განყოფილებაში დასადასტურებლად ან უარსაყოფად.";
      
      // Use contact info for notification
      const userIdentifier = currentUser?.email || `${contactName} ${contactSurname} (${contactEmail})`;
      
      for (const adminId of adminUsers) {
        await addDoc(collection(db, "notifications"), {
          userId: adminId,
          title: notificationTitle,
          message: `${userIdentifier} ${requestFromText}\n"${selectedItem.name}"\n📅 ${startDate} - ${endDate}\n💰 ${total}₾\n📧 ${contactEmail}\n📱 ${contactPhone}\n\n${goToManageText}`,
          type: "admin_booking_request",
          read: false,
          bookingId: docRef.id,
          createdAt: serverTimestamp(),
        });
      }
    } catch (adminNotifError) {
      console.error("Error creating admin notifications:", adminNotifError);
    }

    const userNotificationTitle = window.languageSwitcher?.translate("bookingNotificationRequestSent") || "📋 დაჯავშნის მოთხოვნა გაგზავნილია";
    let userNotificationMsg = window.languageSwitcher?.translate("bookingNotificationRequestSentMsg") || "თქვენი დაჯავშნის მოთხოვნა \"{itemName}\" ({startDate} - {endDate}) გაგზავნილია ადმინისთვის. მოლოდინის რეჟიმში ელოდება დადასტურებას. შეტყობინება მიიღებთ როგორც კი ადმინი განიხილავს თქვენს მოთხოვნას.";
    
    // Replace placeholders
    userNotificationMsg = userNotificationMsg.replace("{itemName}", selectedItem.name).replace("{startDate}", startDate).replace("{endDate}", endDate);
    
    await addDoc(collection(db, 'notifications'), {
      userId: currentUser?.uid || null, // Use current user ID if logged in, otherwise null
      title: userNotificationTitle,
      message: userNotificationMsg,
      type: 'booking_request_sent',
      read: false,
      bookingId: docRef.id,
      createdAt: serverTimestamp()
    });

    // </CHANGE> Using translated booking submission message
    showToast(
      window.languageSwitcher?.translate("bookingSubmittedMessage") || "დაჯავშნის მოთხოვნა წარმატებით გაგზავნილია! ადმინის დადასტურების შემდეგ მიიღებთ შეტყობინებას.",
      "success",
      window.languageSwitcher?.translate("bookingSubmittedTitle") || "დაჯავშნა გაგზავნილია",
    );
    document.getElementById("bookingModal").style.display = "none";

    const priceInfo = document.getElementById("priceInfo");
    if (priceInfo) priceInfo.style.display = "none";
    if (priceInfo) priceInfo.innerHTML = "";
    
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    document.getElementById("startTime").value = "";
    document.getElementById("endTime").value = "";
    if (startCalendar) startCalendar.clearSelection();
    if (endCalendar) endCalendar.close();

    document.getElementById("contactName").value = '';
    document.getElementById("contactSurname").value = '';
    document.getElementById("contactEmail").value = '';
    document.getElementById("contactPhone").value = '';
    document.getElementById("contactDescription").value = ''; // Clear description field
    
    loadMyBookings();
  } catch (error) {
    console.error("Error creating booking:", error);
    
    let errorMessage = "დაჯავშნის შენახვისას მოხდა შეცდომა";
    
    if (error.code === 'permission-denied' || error.message?.includes('permission')) {
      errorMessage = "⚠️ Firebase უსაფრთხოების შეცდომა\n\nთქვენ უნდა განაახლოთ Firestore Security Rules:\n\n1. გადადით Firebase Console → Firestore Database → Rules\n2. დაამატეთ:\n\nrules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /bookings/{booking} {\n      allow create: if true;\n      allow read, update, delete: if request.auth != null;\n    }\n    match /notifications/{notification} {\n      allow create: if true;\n      allow read, update, delete: if request.auth != null;\n    }\n  }\n}\n\n3. დააჭირეთ Publish ღილაკს";
      
      console.error("[v0] Firebase Security Rules არ არის კონფიგურირებული ავტორიზაციის გარეშე დაჯავშნისთვის. გადადით Firebase Console-ში და განაახლეთ rules.");
    }
    
    showToast(errorMessage, "error", "დაჯავშნის შეცდომა");
  } finally {
    confirmBtn.textContent = originalText; // Restore original text
    confirmBtn.disabled = false;
  }
});


async function loadMyBookings() {
  if (!currentUser) {
    const container = document.getElementById('myBookingsContainer');
    if (container) {
      const loginText = window.languageSwitcher?.translate("bookingMyBookingsLoginRequired") || "გთხოვთ შეხვიდეთ სისტემაში დაჯავშნის სანახავად";
      container.innerHTML = `<div class="empty-state">${loginText}</div>`;
    }
    return;
  }

  const container = document.getElementById('myBookingsContainer');
  if (!container) return;

  try {
    const loadingText = window.languageSwitcher?.translate("bookingMyBookingsLoading") || "იტვირთება";
    container.innerHTML = `<div class="loading">${loadingText}</div>`;

    // Removed orderBy to avoid composite index requirement
    const q = query(
      collection(db, "bookings"),
      where("userId", "==", currentUser.uid)
    );

    const snapshot = await getDocs(q);
    let bookings = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    // Sort in JavaScript instead of Firestore
    bookings.sort((a, b) => {
      const aTime = a.createdAt?.seconds || 0;
      const bTime = b.createdAt?.seconds || 0;
      return bTime - aTime; // Descending order (newest first)
    });

    if (bookings.length === 0) {
      const emptyText = window.languageSwitcher?.translate("bookingMyBookingsEmpty") || "თქვენ არ გაქვთ დაჯავშნები";
      container.innerHTML = `<div class="empty-state">${emptyText}</div>`;
      return;
    }

    container.innerHTML = bookings.map(booking => createBookingCard(booking)).join('');

    // Add event listeners for cancel buttons
    container.querySelectorAll('.cancel-booking-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const bookingId = btn.dataset.bookingId;
        await cancelBooking(bookingId);
      });
    });

  } catch (error) {
    console.error("Error loading bookings:", error);
    const errorText = window.languageSwitcher?.translate("bookingMyBookingsLoadError") || "დაჯავშნების ჩატვირთვისას მოხდა შეცდომა";
    container.innerHTML = `<div class="empty-state">${errorText}</div>`;
    const toastText = window.languageSwitcher?.translate("bookingMyBookingsLoadFailed") || "დაჯავშნების ჩატვირთვა ვერ მოხერხდა";
    showToast(toastText, "error");
  }
}

function createBookingCard(booking) {
  const statusClass = `status-${booking.status}`;
  const imageUrl = booking.itemImage || 'https://via.placeholder.com/800x400/e0e0e0/666666?text=No+Image';
  
  //  Use languageSwitcher for date formatting
  const formatDate = (dateStr) => {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    if (window.languageSwitcher) {
      const currentLang = window.languageSwitcher.getCurrentLanguage();
      return date.toLocaleDateString(currentLang === 'ka' ? 'ka-GE' : currentLang === 'ru' ? 'ru-RU' : 'en-US');
    }
    return date.toLocaleDateString('ka-GE');
  };

  const startDate = formatDate(booking.startDate);
  const endDate = formatDate(booking.endDate);

  let statusMessage = '';
  let actions = '';

  const statusPending = window.languageSwitcher?.translate("bookingMyBookingsStatusPending") || "მოლოდინში";
  const statusConfirmed = window.languageSwitcher?.translate("bookingMyBookingsStatusConfirmed") || "დადასტურებული";
  const statusCancelled = window.languageSwitcher?.translate("bookingMyBookingsStatusCancelled") || "გაუქმებული";
  
  const statusPendingMsg = window.languageSwitcher?.translate("bookingMyBookingsStatusPendingMsg") || "თქვენი დაჯავშნა მოლოდინის რეჟიმშია და ელოდება ადმინის დადასტურებას";
  const statusConfirmedMsg = window.languageSwitcher?.translate("bookingMyBookingsStatusConfirmedMsg") || "თქვენი დაჯავშნა დადასტურებულია!";
  const statusCancelledMsg = window.languageSwitcher?.translate("bookingMyBookingsStatusCancelledMsg") || "დაჯავშნა გაუქმებულია";
  const refundedText = window.languageSwitcher?.translate("bookingMyBookingsRefunded") || "თანხა დაბრუნებულია";
  const cancelText = window.languageSwitcher?.translate("bookingMyBookingsCancel") || "გაუქმება";
  const licensePlateText = window.languageSwitcher?.translate("bookingMyBookingsLicensePlate") || "სახელმწიფო ნომერი";
  const daysText = window.languageSwitcher?.translate("bookingMyBookingsDays") || "დღე";

  let translatedStatus = booking.status;
  if (booking.status === 'მოლოდინში') {
    translatedStatus = statusPending;
  } else if (booking.status === 'დადასტურებული') {
    translatedStatus = statusConfirmed;
  } else if (booking.status === 'გაუქმებული') {
    translatedStatus = statusCancelled;
  }

  if (booking.status === statusPending || booking.status === 'მოლოდინში') {
    statusMessage = `<div class="booking-status-message pending"><i class="fas fa-clock"></i> ${statusPendingMsg}</div>`;
    actions = `<button class="btn btn-danger btn-sm cancel-booking-btn" data-booking-id="${booking.id}">${cancelText}</button>`;
  } else if (booking.status === statusConfirmed || booking.status === 'დადასტურებული') {
    statusMessage = `<div class="booking-status-message confirmed"><i class="fas fa-check-circle"></i> ${statusConfirmedMsg}</div>`;
    actions = `<button class="btn btn-danger btn-sm cancel-booking-btn" data-booking-id="${booking.id}">${cancelText}</button>`;
  } else if (booking.status === statusCancelled || booking.status === 'გაუქმებული') {
    statusMessage = `<div class="booking-status-message cancelled"><i class="fas fa-times-circle"></i> ${statusCancelledMsg}</div>`;
    if (booking.refunded) {
      statusMessage += `<div class="refund-info"><i class="fas fa-money-bill-wave"></i> ${refundedText}</div>`;
    }
  }

  const licensePlateHtml = booking.licensePlate 
    ? `<div class="booking-info-item">
        <i class="booking-info-icon fas fa-id-card"></i>
        <div class="booking-info-content">
          <span class="booking-info-label">${licensePlateText}</span>
          <span class="booking-info-value">${booking.licensePlate}</span>
        </div>
      </div>`
    : '';

  return `
    <div class="booking-card">
      <div class="booking-card-header">
        <img src="${imageUrl}" alt="${booking.itemName}" class="booking-card-image">
        <div class="booking-card-title-section">
          <h3>${booking.itemName}</h3>
          <span class="status-badge ${statusClass}">${translatedStatus}</span>
        </div>
      </div>
      <div class="booking-card-body">
        ${statusMessage}
        <div class="booking-dates-visual">
          <div class="booking-date-box">
            <div class="booking-date-day">${startDate.split('.')[0]}</div>
            <div class="booking-date-month">${startDate}</div>
          </div>
          <div class="booking-date-arrow"><i class="fas fa-arrow-right"></i></div>
          <div class="booking-date-box">
            <div class="booking-date-day">${endDate.split('.')[0]}</div>
            <div class="booking-date-month">${endDate}</div>
          </div>
          <div class="booking-date-duration">
            <div class="booking-date-duration-number">${booking.days}</div>
            <div class="booking-date-duration-label">${daysText}</div>
          </div>
        </div>
        <div class="booking-info-grid">
          ${licensePlateHtml}
        </div>
      </div>
      <div class="booking-card-footer">
        ${actions}
      </div>
    </div>
  `;
}

async function cancelBooking(bookingId) {
  const cancelTitle = window.languageSwitcher?.translate("bookingMyBookingsCancelTitle") || "დაჯავშნის გაუქმება";
  const cancelConfirm = window.languageSwitcher?.translate("bookingMyBookingsCancelConfirm") || "ნამდვილად გსურთ ამ დაჯავშნის გაუქმება?";
  
  const confirmed = await showConfirm(
    cancelConfirm,
    cancelTitle
  );

  if (!confirmed) return;

  try {
    const statusCancelled = window.languageSwitcher?.translate("bookingMyBookingsStatusCancelled") || "გაუქმებული";
    
    await updateDoc(doc(db, 'bookings', bookingId), {
      status: statusCancelled,
      cancelledAt: serverTimestamp(),
      cancelledBy: currentUser.uid
    });

    const notificationTitle = window.languageSwitcher?.translate("bookingMyBookingsStatusCancelledMsg") || "დაჯავშნა გაუქმებულია";
    const notificationMessage = window.languageSwitcher?.translate("bookingMyBookingsCancelled") || "თქვენი დაჯავშნა წარმატებით გაუქმდა";
    
    await addDoc(collection(db, 'notifications'), {
      userId: currentUser.uid,
      title: `❌ ${notificationTitle}`,
      message: notificationMessage,
      type: 'booking_cancelled',
      read: false,
      bookingId: bookingId,
      createdAt: serverTimestamp()
    });

    const successMessage = window.languageSwitcher?.translate("bookingMyBookingsCancelled") || "დაჯავშნა წარმატებით გაუქმდა";
    showToast(successMessage, 'success');
    loadMyBookings();
  } catch (error) {
    console.error('Error cancelling booking:', error);
    const errorMessage = window.languageSwitcher?.translate("bookingMyBookingsCancelFailed") || "დაჯავშნის გაუქმება ვერ მოხერხდა";
    showToast(errorMessage, 'error');
  }
}

// Helper function to get translation key for region names
function getRegionTranslationKey(regionValue) {
  const regionMap = {
    'აფხაზეთი': 'regionAbkhazia',
    'აჭარა': 'regionAdjara',
    'გურია': 'regionGuria',
    'იმერეთი': 'regionImereti',
    'კახეთი': 'regionKakheti',
    'ქვემო ქართლი': 'regionKvemoKartli',
    'მცხეთა-მთიანეთი': 'regionMtskhetaMtianeti',
    'რაჭა-ლეჩხუმი': 'regionRachaLechkhumi',
    'სამცხე-ჯავახეთი': 'regionSamtskheJavakheti',
    'შიდა ქართლი': 'regionShidaKartli',
    'სამეგრელო-ზემო სვანეთი': 'regionSamegrelo',
    'თბილისი': 'regionTbilisi'
  };
  return regionMap[regionValue] || `region${regionValue.charAt(0).toUpperCase() + regionValue.slice(1)}`;
}

async function loadNotifications() {
  if (!currentUser) {
    const container = document.getElementById('notificationsContainer');
    if (container) {
      const loginText = window.languageSwitcher?.translate("bookingNotificationLoginRequired") || "გთხოვთ შეხვიდეთ სისტემაში შეტყობინებების სანახავად";
      container.innerHTML = `<div class="empty-state">${loginText}</div>`;
    }
    return;
  }

  const container = document.getElementById('notificationsContainer');
  if (!container) return;

  try {
    const loadingText = window.languageSwitcher?.translate("bookingNotificationLoading") || "იტვირთება";
    container.innerHTML = `<div class="loading">${loadingText}</div>`;

    const q = query(
      collection(db, 'notifications'),
      where('userId', '==', currentUser.uid),
      orderBy('createdAt', 'desc')
    );

    const snapshot = await getDocs(q);
    const notifications = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    if (notifications.length === 0) {
      const emptyText = window.languageSwitcher?.translate("bookingNotificationEmpty") || "თქვენ არ გაქვთ შეტყობინებები";
      container.innerHTML = `<div class="empty-state">${emptyText}</div>`;
      return;
    }

    // Create notification cards with translation
    const notificationCards = await Promise.all(
      notifications.map(notif => createNotificationCard(notif))
    );
    container.innerHTML = notificationCards.join('');

    notifications.forEach(async (notif) => {
      if (!notif.read) {
        await updateDoc(doc(db, 'notifications', notif.id), {
          read: true
        });
      }
    });

  } catch (error) {
    console.error('Error loading notifications:', error);
    const errorText = window.languageSwitcher?.translate("bookingNotificationLoadError") || "შეტყობინებების ჩატვირთვისას მოხდა შეცდომა";
    container.innerHTML = `<div class="empty-state">${errorText}</div>`;
    const toastText = window.languageSwitcher?.translate("bookingNotificationLoadFailed") || "შეტყობინებების ჩატვირთვა ვერ მოხერხდა";
    showToast(toastText, 'error');
  }
}

async function createNotificationCard(notif) {
  const unreadClass = notif.read ? '' : 'unread';
  const timeAgo = getTimeAgo(notif.createdAt);
  
  // Translate notification title and message
  let translatedTitle = notif.title;
  let translatedMessage = notif.message;
  
  // Get current language
  const currentLang = window.languageSwitcher?.currentLanguage || 'ka';
  
  // Only translate if not in Georgian
  if (currentLang !== 'ka') {
    try {
      // Use the getTranslation utility function
      const titleResult = await getTranslation(notif.title);
      const messageResult = await getTranslation(notif.message);
      
      translatedTitle = titleResult[currentLang] || notif.title;
      translatedMessage = messageResult[currentLang] || notif.message;
    } catch (error) {
      console.error('Error translating notification:', error);
    }
  }

  return `
    <div class="notification-card ${unreadClass}">
      <div class="notification-header">
        <h3>${translatedTitle}</h3>
        <span class="notification-time">${timeAgo}</span>
      </div>
      <div class="notification-message">${translatedMessage}</div>
    </div>
  `;
}

// The loadNotifications function is already async and uses Promise.all,
// so the change is integrated into the existing structure.
// No further structural changes needed here for this specific update.

function getTimeAgo(timestamp) {
  if (!timestamp) {
    return window.languageSwitcher?.translate("bookingNotificationTimeJustNow") || 'ახლახან';
  }
  
  const now = new Date();
  const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
  const diff = now - date;
  
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);
  
  const justNowText = window.languageSwitcher?.translate("bookingNotificationTimeJustNow") || "ახლახან";
  const minutesAgoText = window.languageSwitcher?.translate("bookingNotificationTimeMinutesAgo") || "წუთის წინ";
  const hoursAgoText = window.languageSwitcher?.translate("bookingNotificationTimeHoursAgo") || "საათის წინ";
  const daysAgoText = window.languageSwitcher?.translate("bookingNotificationTimeDaysAgo") || "დღის წინ";
  
  if (minutes < 1) return justNowText;
  if (minutes < 60) return `${minutes} ${minutesAgoText}`;
  if (hours < 24) return `${hours} ${hoursAgoText}`;
  return `${days} ${daysAgoText}`;
}


// function showAuthOverlay() {
//   const overlay = document.getElementById('authOverlay');
//   if (overlay) {
//     overlay.style.display = 'flex';
//   }
// }

document.addEventListener("DOMContentLoaded", () => {
  // Close booking modal
  const closeBookingBtn = document.getElementById("closeBookingModal");
  if (closeBookingBtn) {
    closeBookingBtn.addEventListener("click", () => {
      console.log("[v0] Closing booking modal");
      const modal = document.getElementById("bookingModal");
      if (modal) {
        modal.style.display = "none";
      }
    });
  }

  // Close detail modal
  const closeDetailBtn = document.getElementById("closeDetailModal");
  if (closeDetailBtn) {
    closeDetailBtn.addEventListener("click", () => {
      console.log("[v0] Closing detail modal");
      window.closeDetailModal();
    });
  }

  // Close modals when clicking outside
  window.addEventListener("click", (event) => {
    const bookingModal = document.getElementById("bookingModal");
    const detailModal = document.getElementById("detailModal");
    
    if (event.target === bookingModal) {
      console.log("[v0] Clicked outside booking modal");
      bookingModal.style.display = "none";
    }
    
    if (event.target === detailModal) {
      console.log("[v0] Clicked outside detail modal");
      window.closeDetailModal();
    }
  });
});
document.querySelector('.nav-card1.admin-only').addEventListener('click', function(e) {
    e.preventDefault();
    window.location.href = 'admin.html';
});

window.addEventListener('languageChanged', () => {
  // განახლდეს typeFilter თარგმანები
  updateTypeFilter();
  
  // თუ My Bookings view-ზე ვართ, გადატვირთოთ
  const currentView = document.querySelector('.view[style*="display: block"], .view[style=""]');
  if (currentView && currentView.id === 'myBookingsView') {
    loadMyBookings();
  }
  
  // თუ Notifications view-ზე ვართ, გადატვირთოთ
  if (currentView && currentView.id === 'notificationsView') {
    loadNotifications();
  }
});

// </CHANGE> Added openDetailModal function definition

function openDetailModal(item, type) {
  selectedItem = item
  selectedItemType = type

  const lang = window.languageSwitcher?.getCurrentLanguage() || 'ka';
  
  // Translate all fields
  const name = (lang !== 'ka' && item.nameTranslations?.[lang]) ? item.nameTranslations[lang] : item.name;
  
  // --- Region Translation Update in Detail Modal ---
  let regionDetailText = '';
  if (item.region === 'all' || (Array.isArray(item.regions) && item.regions.includes('all'))) {
      regionDetailText = window.languageSwitcher?.translate('bookingAllRegions') || 'ყველა რეგიონი (უნივერსალური)';
  } else if (Array.isArray(item.regions) && item.regions.length > 0) {
      regionDetailText = item.regions.map(region => {
          const translationKey = getRegionTranslationKey(region);
          return window.languageSwitcher?.translate(translationKey) || region;
      }).join(', ');
  } else {
      const translationKey = getRegionTranslationKey(item.region);
      regionDetailText = window.languageSwitcher?.translate(translationKey) || item.region;
  }
  // --- End Region Translation Update ---
  
  const description = (lang !== 'ka' && item.descriptionTranslations?.[lang]) ? item.descriptionTranslations[lang] : (item.description || "");
  const type_translated = (lang !== 'ka' && item.typeTranslations?.[lang]) ? item.typeTranslations[lang] : item.type;
  const fuelType = (lang !== 'ka' && item.fuelTypeTranslations?.[lang]) ? item.fuelTypeTranslations[lang] : item.fuelType;
  const transmission = (lang !== 'ka' && item.transmissionTranslations?.[lang]) ? item.transmissionTranslations[lang] : item.transmission;
  const color = (lang !== 'ka' && item.colorTranslations?.[lang]) ? item.colorTranslations[lang] : item.color;
  const features = (lang !== 'ka' && item.featuresTranslations?.[lang]) ? item.featuresTranslations[lang] : item.features;
  const route = (lang !== 'ka' && item.routeTranslations?.[lang]) ? item.routeTranslations[lang] : item.route;
  const duration = (lang !== 'ka' && item.durationTranslations?.[lang]) ? item.durationTranslations[lang] : item.duration;
  
  const modal = document.getElementById("detailModal")
  const modalBody = document.getElementById("detailModalContent")
  
  const images =
    item.images && item.images.length > 0
      ? item.images
      : [`https://via.placeholder.com/800x400/e0e0e0/666666?text=${encodeURIComponent(name || "No Image")}`]

  const ls = window.languageSwitcher;
  const regionLabel = ls ? ls.translate('bookingDetailRegion') : 'რეგიონი';
  const typeLabel = ls ? ls.translate('bookingDetailType') : 'ტიპი';
  const doorsLabel = ls ? ls.translate('bookingDoors') : 'კარები';
  const seatsLabel = ls ? ls.translate('bookingSeats') : 'ადგილები';
  const fuelTypeLabel = ls ? ls.translate('bookingFuelType') : 'საწავლის ტიპი';
  const transmissionLabel = ls ? ls.translate('bookingTransmission') : 'ტრანსმისია';
  const yearLabel = ls ? ls.translate('bookingYear') : 'წელი';
  const colorLabel = ls ? ls.translate('bookingColor') : 'ფერი';
  const engineLabel = ls ? ls.translate('bookingEngineCapacity') : 'ძრავის მოცულობა';
  const driverLabel = ls ? ls.translate('bookingDriver') : 'მძღოლი';
  const driverAvailable = ls ? ls.translate('bookingDriverAvailable') : 'ხელმისაწვდომი';
  const featuresLabel = ls ? ls.translate('bookingFeatures') : 'დამატებითი მახასიათებლები';
  const durationLabel = ls ? ls.translate('bookingDuration') : 'ხანგრძლივობა';
  const capacityLabel = ls ? ls.translate('bookingCapacity') : 'ადგილები';
  const routeLabel = ls ? ls.translate('bookingRoute') : 'მარშრუტი';
  const noDesc = ls ? ls.translate('bookingNoDescription') : 'აღწერა არ არის მითითებული';
  const bookBtn = ls ? ls.translate('bookingCardBook') : 'დაჯავშნა';
  const closeBtn = ls ? ls.translate('bookingDetailClose') : 'დახურვა';
  const perDay = ls ? ls.translate('bookingPerDay') : '/დღე';

  

  let specsHTML = ""
  if (type === "cars") {
    specsHTML = `
      <div class="detail-specs">
        <div class="detail-spec">
          <span class="detail-spec-icon">📍</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${regionLabel}</span>
            <span class="detail-spec-value">${regionDetailText}</span>
          </div>
        </div>
        <div class="detail-spec">
          <span class="detail-spec-icon">🚗</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${typeLabel}</span>
            <span class="detail-spec-value">${translateValue(item.type, 'carType')}</span>
          </div>
        </div>
        <div class="detail-spec">
          <span class="detail-spec-icon">🚪</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${doorsLabel}</span>
            <span class="detail-spec-value">${item.doors}</span>
          </div>
        </div>
        <div class="detail-spec">
          <span class="detail-spec-icon">👥</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${seatsLabel}</span>
            <span class="detail-spec-value">${item.seats}</span>
          </div>
        </div>
        ${fuelType ? `
        <div class="detail-spec">
          <span class="detail-spec-icon">⛽</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${fuelTypeLabel}</span>
            <span class="detail-spec-value">${translateValue(fuelType, 'fuelType')}</span>
          </div>
        </div>
        ` : ''}
        ${transmission ? `
        <div class="detail-spec">
          <span class="detail-spec-icon">⚙️</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${transmissionLabel}</span>
            <span class="detail-spec-value">${translateValue(transmission, 'transmission')}</span>
          </div>
        </div>
        ` : ''}
        ${item.year ? `
        <div class="detail-spec">
          <span class="detail-spec-icon">📅</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${yearLabel}</span>
            <span class="detail-spec-value">${item.year}</span>
          </div>
        </div>
        ` : ''}
        ${color ? `
        <div class="detail-spec">
          <span class="detail-spec-icon">🎨</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${colorLabel}</span>
            <span class="detail-spec-value">${translateValue(color, 'color')}</span>
          </div>
        </div>
        ` : ''}
        ${item.engineCapacity ? `
        <div class="detail-spec">
          <span class="detail-spec-icon">🔧</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${engineLabel}</span>
            <span class="detail-spec-value">${item.engineCapacity}L</span>
          </div>
        </div>
        ` : ''}
        ${item.withDriver ? `
        <div class="detail-spec with-driver">
          <span class="detail-spec-icon">👨‍✈️</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${driverLabel}</span>
            <span class="detail-spec-value">${driverAvailable}</span>
          </div>
        </div>
        ` : ''}
        ${features ? `
        <div class="detail-spec" style="grid-column: 1 / -1;">
          <span class="detail-spec-icon">⭐</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${featuresLabel}</span>
            <span class="detail-spec-value">${features}</span>
          </div>
        </div>
        ` : ''}
      </div>
    `

  } else {
    specsHTML = `
      <div class="detail-specs">
        <div class="detail-spec">
          <span class="detail-spec-icon">📍</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${regionLabel}</span>
            <span class="detail-spec-value">${regionDetailText}</span>
          </div>
        </div>
        <div class="detail-spec">
          <span class="detail-spec-icon">🎯</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${typeLabel}</span>
            <span class="detail-spec-value">${translateValue(item.type, 'type')}</span>
          </div>
        </div>
        <div class="detail-spec">
          <span class="detail-spec-icon">🕒</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${durationLabel}</span>
            <span class="detail-spec-value">${duration}</span>
          </div>
        </div>
        <div class="detail-spec">
          <span class="detail-spec-icon">👥</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${capacityLabel}</span>
            <span class="detail-spec-value">${item.capacity} ${capacityLabel}</span>
          </div>
        </div>
        ${route ? `
        <div class="detail-spec" style="grid-column: 1 / -1;">
          <span class="detail-spec-icon">🗺️</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${routeLabel}</span>
            <span class="detail-spec-value">${route}</span>
          </div>
        </div>
        ` : ''}
        ${features ? `
        <div class="detail-spec" style="grid-column: 1 / -1;">
          <span class="detail-spec-icon">⭐</span>
          <div class="detail-spec-text">
            <span class="detail-spec-label">${featuresLabel}</span>
            <span class="detail-spec-value">${features}</span>
          </div>
        </div>
        ` : ''}
      </div>
    `
  }

  modalBody.innerHTML = `
    <div class="detail-modal-body">
      <div class="detail-gallery">
        ${images.length > 1 ? '<button class="gallery-nav image-nav image-nav-prev" onclick="changeDetailImage(-1)">‹</button>' : ""}
        <img src="${images[0]}" alt="${name}" class="detail-main-image" id="detailMainImage">
        ${images.length > 1 ? '<button class="gallery-nav image-nav image-nav-next" onclick="changeDetailImage(1)">›</button>' : ""}
        ${
          images.length > 1
            ? `
        <div class="detail-thumbnails">
          ${images
            .map(
              (img, index) => `
            <img src="${img}" 
                 alt="${name}" 
                 class="detail-thumbnail ${index === 0 ? "active" : ""}" 
                 onclick="setDetailImage(${index})">
          `,
            )
            .join("")}
        </div>
        `
            : ""
        }
      </div>
      <div class="detail-info">
        <div>
          <h2>${name}</h2>
          <div class="detail-price">${item.pricePerDay}₾${type === "cars" ? perDay : ''}</div>
        </div>
        <div class="detail-description">
          ${description || noDesc}
        </div>
        ${specsHTML}
        <div class="detail-actions">
          <button class="btn" onclick="window.bookFromDetail()">${bookBtn}</button>
          <button class="btn btn-secondary" onclick="window.closeDetailModal()">${closeBtn}</button>
        </div>
      </div>
    </div>
    <div class="detail-calendar-section">
      <h3><i class="fas fa-calendar-alt"></i> ${ls ? ls.translate('bookingCalendarAvailable') : 'ხელმისაწვდომი თარიღები'}</h3>
      <div id="detailCalendarContainer"></div>
    </div>
  `

  window.detailImages = images
  window.currentDetailImageIndex = 0

  setTimeout(() => {
    const calendarContainer = document.getElementById('detailCalendarContainer');
    if (!calendarContainer) return;
    
    const availableDates = type === "tours" ? (item.availableDates || []) : [];
    const bookedDates = type === "cars" ? (item.bookedDates || []) : [];
    const restrictedMode = item.restrictedMode || false;
    const calendarMode = item.calendarMode || 'select-unavailable';
    
    const calendar = new AvailabilityCalendar(calendarContainer, {
      availableDates: availableDates,
      bookedDates: bookedDates,
      itemType: type,
      multiSelect: type === 'tours',
      minDate: new Date(),
      restrictedMode: restrictedMode,
      calendarMode: calendarMode,
      onDateSelect: (date) => {
        console.log('Selected date:', date);
      }
    });
  }, 100);

  modal.style.display = "flex"
  if (priceInfo) priceInfo.style.display = "none"
}
    </script>
    
    <div id="footer"></div>
    <script type="module" src="navbar.js"></script>
    <script src="translations.js"></script>
    <script type="module" src="footer.js"></script>
</body>
</html>
