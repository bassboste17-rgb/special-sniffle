<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Georgia Trips - admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
:root {
  --primary-color: #dc3545;
  --primary-hover: #dc3545;
  --secondary-color: #00eeff;
  --text-color: #e0e0e0;
  --bg-dark: #0a0a0a;
  --light-bg: #1a1a1a;
  --border-color: #333;
  --success-color: #28a745;
  --error-color: #dc3545;
  --warning-color: #ffc107;
  --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.5);
  --border-radius: 12px;
  --border-radius-sm: 8px;
  --transition: all 0.3s ease;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
  color: var(--text-color);
  line-height: 1.6;
  min-height: 100vh;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

/* Added enhanced calendar styles from oldadmin.html */
.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border-color);
}

.calendar-header h2 {
  color: #fff;
  font-size: 1.1rem;
  font-weight: 600;
  margin: 0;
}

.calendar-nav {
  background: var(--light-bg);
  border: 1px solid var(--border-color);
  color: var(--text-color);
  padding: 0.5rem 0.75rem;
  border-radius: 6px;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.9rem;
}

.calendar-nav:hover {
  background: var(--primary-color);
  border-color: var(--primary-color);
  color: white;
  transform: scale(1.05);
}

.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.25rem;
  margin-bottom: 0.5rem;
}

.calendar-weekday {
  text-align: center;
  font-weight: 600;
  color: var(--primary-color);
  padding: 0.5rem 0;
  font-size: 0.8rem;
}

.calendar-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.25rem;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 6px;
  cursor: pointer;
  transition: var(--transition);
  font-weight: 500;
  color: var(--text-color);
  font-size: 0.85rem;
  position: relative;
  background: linear-gradient(135deg, #3a8200 0%, #509600 100%);
  border: 1px solid var(--border-color);
}

.calendar-day:not(.disabled):not(.other-month):hover {
  background: var(--light-bg);
  color: #fff;
  transform: scale(1.1);
}

.calendar-day.today {
  border: 2px solid var(--primary-color);
  font-weight: 700;
}

.calendar-day.selected {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: white;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
}

.calendar-day.disabled {
  background: rgba(255, 255, 255, 0.05);
  color: #666;
  cursor: not-allowed;
  opacity: 0.5;
}

.calendar-day.other-month {
  background: rgba(255, 255, 255, 0.02);
  color: #666;
  cursor: default;
  opacity: 0.4;
}

.calendar-legend {
  display: flex;
  gap: 1.5rem;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  color: var(--text-color);
}

.legend-color {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.legend-color.available {
  background: linear-gradient(135deg, #3a8200 0%, #509600 100%);
}

.legend-color.selected {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.legend-color.past {
  background: rgba(255, 255, 255, 0.05);
}

/* Added button styles for make all available button */
.make-all-available-btn {
  padding: 0.5rem 1rem;
  background: linear-gradient(135deg, #3a8200 0%, #509600 100%);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.make-all-available-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(58, 130, 0, 0.3);
}

.make-all-available-btn:active {
  transform: translateY(0);
}

.admin-calendar-container {
  background: linear-gradient(135deg, rgba(31, 31, 31, 0.8) 0%, rgba(26, 26, 26, 0.8) 100%);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 1.5rem;
}
/* </CHANGE> */

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2.5rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.header h1 {
  color: #fff;
  font-size: 2rem;
  font-weight: 700;
  letter-spacing: -0.5px;
}

/* Enhanced admin panel styles */
.admin-panel-header {
  background: linear-gradient(135deg, rgba(229, 56, 59, 0.1) 0%, rgba(26, 26, 26, 0.8) 100%);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 2rem;
  margin-bottom: 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1.5rem;
}

.admin-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.admin-stat-card {
  background: linear-gradient(135deg, rgba(26, 26, 20, 0.9) 0%, rgba(20, 20, 20, 0.9) 100%);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 1.5rem;
  text-align: center;
  transition: var(--transition);
}

.admin-stat-card:hover {
  border-color: var(--primary-color);
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}

.admin-stat-icon {
  font-size: 2.5rem;
  margin-bottom: 0.75rem;
  display: block;
}

.admin-stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary-color);
  margin-bottom: 0.5rem;
}

.admin-stat-label {
  font-size: 0.95rem;
  color: var(--text-color);
}

/* Modern tabs with better visual feedback */
.tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 2rem;
  border-bottom: 2px solid var(--border-color);
  padding: 0 0.5rem;
}

.tab-btn {
  background: none;
  border: none;
  color: var(--text-color);
  padding: 1rem 2rem;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 500;
  border-bottom: 3px solid transparent;
  transition: var(--transition);
  position: relative;
  border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0;
}

.tab-btn:hover {
  color: #fff;
  background: rgba(255, 255, 255, 0.03);
}

.tab-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
  background: rgba(229, 56, 59, 0.05);
}

/* Enhanced admin cards */
.admin-table {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.admin-item-card {
  background: linear-gradient(135deg, rgba(26, 26, 26, 0.9) 0%, rgba(20, 20, 20, 0.9) 100%);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 2rem;
  display: flex;
  gap: 2rem;
  align-items: start;
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
}

.admin-item-card:hover {
  border-color: var(--primary-color);
  box-shadow: var(--shadow-md);
  transform: translateX(4px);
}

.admin-item-card img {
  width: 180px;
  height: 120px;
  object-fit: cover;
  border-radius: var(--border-radius-sm);
  border: 1px solid var(--border-color);
}

.admin-item-info {
  flex: 1;
}

.admin-item-info h3 {
  color: #fff;
  margin-bottom: 0.75rem;
  font-size: 1.25rem;
  font-weight: 600;
}

.admin-item-details {
  display: flex;
  gap: 1.25rem;
  margin-top: 0.75rem;
  font-size: 0.95rem;
  flex-wrap: wrap;
}

.admin-item-details span {
  padding: 0.375rem 0.875rem;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 6px;
  border: 1px solid var(--border-color);
}

.admin-item-actions {
  display: flex;
  gap: 0.75rem;
  flex-direction: column;
}

/* Enhanced button styles */
.btn {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
  color: #fff;
  border: none;
  border-radius: var(--border-radius-sm);
  padding: 0.875rem 1.75rem;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  box-shadow: 0 4px 12px rgba(0, 31, 204, 0.3);
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 31, 204, 0.4);
}

.btn:active {
  transform: translateY(0);
}

.btn-secondary {
  background: var(--light-bg);
  border: 1px solid var(--border-color);
  box-shadow: none;
}

.btn-secondary:hover {
  background: var(--bg-dark);
  border-color: var(--primary-color);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.btn-danger {
  background: linear-gradient(135deg, var(--error-color) 0%, #c82333 100%);
}

.btn-danger:hover {
  box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
}

.btn-sm {
  padding: 0.625rem 1.25rem;
  font-size: 0.875rem;
}

/* Enhanced modal with glassmorphism */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(8px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 1rem;
}

.modal-content {
  background: linear-gradient(135deg, rgba(26, 26, 26, 0.98) 0%, rgba(20, 20, 20, 0.98) 100%);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 2.5rem;
  max-width: 500px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow-lg);
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-large {
  max-width: 850px;
}

.close {
  position: absolute;
  top: 1.5rem;
  right: 1.5rem;
  font-size: 1.75rem;
  color: var(--text-color);
  cursor: pointer;
  line-height: 1;
  transition: var(--transition);
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.05);
}

.close:hover {
  color: var(--primary-color);
  transform: rotate(90deg);
  background: rgba(229, 56, 59, 0.1);
}

.form-group {
  margin-bottom: 1.75rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.625rem;
  color: #fff;
  font-weight: 500;
  font-size: 0.95rem;
}

.form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.25rem;
}

textarea.input {
  resize: vertical;
  font-family: inherit;
  min-height: 100px;
}

.input,
.select {
  background: var(--light-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  padding: 0.875rem 1.25rem;
  color: var(--text-color);
  font-size: 0.95rem;
  flex: 1;
  min-width: 200px;
  transition: var(--transition);
}

.input:focus,
.select:focus {
  outline: none;
  border-color: var(--primary-color);
  background: var(--light-bg);
  box-shadow: 0 0 0 3px rgba(0, 31, 204, 0.1);
}

.input::placeholder {
  color: var(--text-color);
}

.form-group-inline {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 1rem;
  align-items: start;
}

.form-group-inline label {
  padding-top: 0.875rem;
}

.license-plate-input {
  font-family: 'Courier New', monospace;
  font-size: 1.1rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 2px;
  text-align: center;
}

.available-dates-container {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  margin-top: 0.75rem;
}

.date-chip {
  background: var(--light-bg);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: var(--transition);
}

.date-chip:hover {
  background: rgba(229, 56, 59, 0.1);
  border-color: var(--primary-color);
}

.date-chip button {
  background: none;
  border: none;
  color: var(--primary-color);
  cursor: pointer;
  font-size: 1.1rem;
  line-height: 1;
  padding: 0;
  transition: var(--transition);
}

.date-chip button:hover {
  color: var(--error-color);
  transform: scale(1.2);
}

.add-date-btn {
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 0.5rem 1.25rem;
  font-size: 0.9rem;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.add-date-btn:hover {
  background: var(--primary-hover);
  transform: translateY(-2px);
}

.tour-dates-selector {
  background: rgba(26, 26, 26, 0.5);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 1.5rem;
  margin-top: 1rem;
}

.tour-dates-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 0.75rem;
  margin-top: 1rem;
}

.tour-date-option {
  background: var(--light-bg);
  border: 2px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  padding: 1rem;
  text-align: center;
  cursor: pointer;
  transition: var(--transition);
}

.tour-date-option:hover {
  border-color: var(--primary-color);
  background: rgba(229, 56, 59, 0.1);
}

.tour-date-option.selected {
  border-color: var(--primary-color);
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
  color: white;
}

.tour-date-option.disabled {
  opacity: 0.3;
  cursor: not-allowed;
  pointer-events: none;
}

.enhanced-form-section {
  background: rgba(31, 31, 31, 0.5);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.enhanced-form-section h3 {
  color: #fff;
  font-size: 1.1rem;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.enhanced-form-section h3 i {
  color: var(--primary-color);
}

/* Added styles for translation preview */
.translation-preview {
    margin-top: 0.5rem;
    padding: 0.75rem;
    background: rgba(74, 144, 226, 0.1);
    border-left: 3px solid #4a90e2;
    border-radius: 4px;
    font-size: 0.9rem;
}

.translation-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0;
}

.translation-item .flag {
    font-size: 1.2rem;
}

.translation-item .lang-label {
    font-weight: 600;
    color: #4a90e2;
    min-width: 70px;
}

.translation-item .translation-text {
    color: var(--text-color);
    flex: 1;
}


/* Enhanced booking card styles */
.booking-card {
  background: linear-gradient(135deg, rgba(26, 26, 26, 0.9) 0%, rgba(20, 20, 20, 0.9) 100%);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 2rem;
  margin-bottom: 1.75rem;
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
}

.booking-card:hover {
  border-color: var(--primary-color);
  box-shadow: var(--shadow-md);
  transform: translateX(4px);
}

.booking-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 1.25rem;
  gap: 1rem;
}

.booking-header h3 {
  color: #fff;
  font-size: 1.25rem;
  font-weight: 600;
}

.booking-details {
  margin-bottom: 1.25rem;
  padding: 1.25rem;
  background: rgba(0, 0, 0, 0.2);
  border-radius: var(--border-radius-sm);
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.booking-details p {
  margin-bottom: 0.625rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.booking-details p:last-child {
  margin-bottom: 0;
}

.booking-actions {
  display: flex;
  gap: 1rem;
  margin-top: 1.25rem;
  flex-wrap: wrap;
  align-items: center;
}

.status-badge {
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 600;
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.status-·Éõ·Éù·Éö·Éù·Éì·Éò·Éú·É®·Éò {
  background: linear-gradient(135deg, var(--warning-color) 0%, #e0a800 100%);
  color: #000;
  box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
}

.status-·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·É£·Éö·Éò {
  background: linear-gradient(135deg, var(--success-color) 0%, #218838 100%);
  color: #fff;
  box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
}

.status-·Éí·Éê·É£·É•·Éõ·Éî·Éë·É£·Éö·Éò {
  background: linear-gradient(135deg, var(--error-color) 0%, #c82333 100%);
  color: #fff;
  box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
}

/* Enhanced filters with better spacing */
.filters {
  display: flex;
  gap: 1rem;
  margin-bottom: 2.5rem;
  flex-wrap: wrap;
  padding: 1.5rem;
  background: rgba(26, 26, 26, 0.5);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
}

.loading {
  text-align: center;
  padding: 4rem;
  font-size: 1.25rem;
  color: var(--text-color);
}

.loading::after {
  content: '...';
  animation: dots 1.5s steps(4, end) infinite;
}

@keyframes dots {
  0%, 20% { content: '.'; }
  40% { content: '..'; }
  60%, 100% { content: '...'; }
}

.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  font-size: 1.15rem;
  color: var(--text-color);
  background: rgba(26, 26, 26, 0.5);
  border-radius: var(--border-radius);
  border: 1px dashed var(--border-color);
}

.text-muted {
  color: var(--text-color);
  font-size: 0.9rem;
}

/* Enhanced toast notifications */
.toast-container {
  position: fixed;
  top: 24px;
  right: 24px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  max-width: 420px;
}

.toast {
  background: linear-gradient(135deg, rgba(26, 26, 26, 0.98) 0%, rgba(20, 20, 20, 0.98) 100%);
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 1.25rem 1.75rem;
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: start;
  gap: 1.25rem;
  animation: toastSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

@keyframes toastSlideIn {
  from {
    opacity: 0;
    transform: translateX(100%) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateX(0) scale(1);
  }
}

@keyframes toastSlideOut {
  from {
    opacity: 1;
    transform: translateX(0) scale(1);
  }
  to {
    opacity: 0;
    transform: translateX(100%) scale(0.9);
  }
}

.toast.removing {
  animation: toastSlideOut 0.3s ease forwards;
}

.toast-icon {
  font-size: 1.75rem;
  flex-shrink: 0;
  line-height: 1;
}

.toast-content {
  flex: 1;
}

.toast-title {
  color: #fff;
  font-weight: 700;
  margin-bottom: 0.375rem;
  font-size: 1rem;
}

.toast-message {
  color: var(--text-color);
  font-size: 0.9rem;
  line-height: 1.5;
}

.toast-close {
  background: none;
  border: none;
  color: var(--text-color);
  cursor: pointer;
  font-size: 1.5rem;
  line-height: 1;
  padding: 0;
  transition: var(--transition);
  flex-shrink: 0;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.toast-close:hover {
  color: #fff;
  background: rgba(255, 255, 255, 0.1);
}

.toast-progress {
  position: absolute;
  bottom: 0;
  left: 0;
  height: 4px;
  background: var(--primary-color);
  animation: toastProgress 5s linear forwards;
  border-radius: 0 0 0 var(--border-radius);
}

@keyframes toastProgress {
  from { width: 100%; }
  to { width: 0%; }
}

.toast.success {
  border-left: 4px solid var(--success-color);
}

.toast.success .toast-icon {
  color: var(--success-color);
}

.toast.success .toast-progress {
  background: var(--success-color);
}

.toast.error {
  border-left: 4px solid var(--error-color);
}

.toast.error .toast-icon {
  color: var(--error-color);
}

.toast.error .toast-progress {
  background: var(--error-color);
}

.toast.warning {
  border-left: 4px solid var(--warning-color);
}

.toast.warning .toast-icon {
  color: var(--warning-color);
}

.toast.warning .toast-progress {
  background: var(--warning-color);
}

.toast.info {
  border-left: 4px solid var(--info-color);
}

.toast.info .toast-icon {
  color: var(--info-color);
}

.toast.info .toast-progress {
  background: var(--info-color);
}

/* Enhanced confirm modal */
.confirm-modal-content {
  max-width: 480px;
  text-align: center;
}

.confirm-modal-content h2 {
  color: #fff;
  margin-bottom: 1.25rem;
  font-size: 1.75rem;
  font-weight: 700;
}

.confirm-modal-content p {
  color: var(--text-color);
  margin-bottom: 2.5rem;
  line-height: 1.7;
  font-size: 1.05rem;
}

.confirm-actions {
  display: flex;
  gap: 1.25rem;
  justify-content: center;
}

.confirm-actions .btn {
  min-width: 140px;
}

/* Enhanced custom calendar */
.custom-calendar {
  position: absolute;
  top: 100%;
  left: 0;
  margin-top: 0.75rem;
  background: linear-gradient(135deg, rgba(26, 26, 26, 0.98) 0%, rgba(20, 20, 20, 0.98) 100%);
  backdrop-filter: blur(12px);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 1rem;
  box-shadow: var(--shadow-lg);
  z-index: 1001;
  min-width: 300px;
  animation: calendarSlideIn 0.3s ease;
}

@keyframes calendarSlideIn {
  from {
    opacity: 0;
    transform: translateY(-15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border-color);
}

.calendar-header h2 {
  color: #fff;
  font-size: 1.1rem;
  font-weight: 600;
  margin: 0;
}

.calendar-nav {
  background: var(--light-bg);
  border: 1px solid var(--border-color);
  color: var(--text-color);
  padding: 0.5rem 0.75rem;
  border-radius: 6px;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.9rem;
}

.calendar-nav:hover {
  background: var(--primary-color);
  border-color: var(--primary-color);
  color: white;
  transform: scale(1.05);
}

.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.25rem;
  margin-bottom: 0.5rem;
}

.calendar-weekday {
  text-align: center;
  font-weight: 600;
  color: var(--primary-color);
  padding: 0.5rem 0;
  font-size: 0.8rem;
}

.calendar-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.25rem;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 6px;
  cursor: pointer;
  transition: var(--transition);
  font-weight: 500;
  color: var(--text-color);
  font-size: 0.85rem;
  position: relative;
  background: linear-gradient(135deg, #3a8200 0%, #509600 100%);
  border: 1px solid var(--border-color);
}

.calendar-day:not(.disabled):not(.other-month):hover {
  background: var(--light-bg);
  color: #fff;
  transform: scale(1.1);
}

.calendar-day.today {
  border: 2px solid var(--primary-color);
  font-weight: 700;
}

.calendar-day.selected {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: white;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
}

.calendar-day.disabled {
  background: rgba(255, 255, 255, 0.05);
  color: #666;
  cursor: not-allowed;
  opacity: 0.5;
}

.calendar-day.other-month {
  background: rgba(255, 255, 255, 0.02);
  color: #666;
  cursor: default;
  opacity: 0.4;
}

.calendar-legend {
  display: flex;
  gap: 1.5rem;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-color);
  flex-wrap: wrap;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  color: var(--text-color);
}

.legend-color {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.legend-color.available {
  background: linear-gradient(135deg, #3a8200 0%, #509600 100%);
}

.legend-color.selected {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.legend-color.past {
  background: rgba(255, 255, 255, 0.05);
}

.admin-calendar-section {
  margin-top: 1.5rem;
  padding: 1.5rem;
  background: rgba(26, 26, 26, 0.6);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
}

.admin-calendar-section h3 {
  color: #fff;
  margin-bottom: 1rem;
  font-size: 1.1rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.admin-calendar-section h3 i {
  color: var(--primary-color);
}

.admin-calendar-container {
  background: linear-gradient(135deg, rgba(31, 31, 31, 0.8) 0%, rgba(26, 26, 26, 0.8) 100%);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 1.5rem;
}

.admin-calendar-legend {
  display: flex;
  gap: 1.5rem;
  margin-bottom: 1rem;
  padding: 0.75rem;
  background: rgba(0, 0, 0, 0.3);
  border-radius: var(--border-radius-sm);
  flex-wrap: wrap;
}

/* Responsive improvements */
@media (max-width: 768px) {
  .container {
    padding: 1.25rem;
  }

  .header h1 {
    font-size: 1.5rem;
  }

  .admin-item-card {
    flex-direction: column;
  }

  .admin-item-card img {
    width: 100%;
    height: 200px;
  }

  .form-row {
    grid-template-columns: 1fr;
  }

  .toast-container {
    top: 12px;
    right: 12px;
    left: 12px;
    max-width: none;
  }

  .toast {
    padding: 1rem 1.25rem;
  }

  .toast-icon {
    font-size: 1.5rem;
  }

  .toast-title {
    font-size: 0.95rem;
  }

  .toast-message {
    font-size: 0.85rem;
  }

  .confirm-actions {
    flex-direction: column;
  }

  .confirm-actions .btn {
    width: 100%;
  }

  .admin-stats {
    grid-template-columns: 1fr;
  }

  .form-group-inline {
    grid-template-columns: 1fr;
  }

  .tour-dates-grid {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  }

  .tabs {
    overflow-x: auto;
    padding-bottom: 0.5rem;
  }

  .tab-btn {
    white-space: nowrap;
  }
}

/* Added toggle switch styles for restricted mode */
.restricted-mode-toggle {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: rgba(255, 193, 7, 0.1);
  border: 1px solid var(--warning-color);
  border-radius: var(--border-radius-sm);
  margin-bottom: 1rem;
}

.toggle-switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 34px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background-color: var(--success-color);
}

input:checked + .toggle-slider:before {
  transform: translateX(26px);
}

.toggle-label {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.toggle-label-title {
  font-weight: 600;
  color: #fff;
  font-size: 1rem;
}

.toggle-label-description {
  font-size: 0.85rem;
  color: var(--text-color);
}

.calendar-hidden-message {
  padding: 1.5rem;
  background: rgba(220, 53, 69, 0.1);
  border: 1px solid var(--error-color);
  border-radius: var(--border-radius-sm);
  color: var(--error-color);
  text-align: center;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

/* Added styles for fixed calendar */
/* ·É§·Éò·É•·É°·Éò·É†·Éî·Éë·É£·Éö·Éò ·Éô·Éê·Éö·Éî·Éú·Éì·É†·Éò·É° ·É°·É¢·Éò·Éö·Éî·Éë·Éò */
.fixed-calendar-container {
    margin-top: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 12px;
    border: 1px solid var(--border-color);
}

.fixed-calendar-wrapper {
    background-color: #f5f1e900;
    padding: 20px;
    border-radius: 12px;
    margin: 0 auto;
    max-width: 320px; /* Adjusted max-width */
}

.fixed-calendar {
    margin-left: auto;
    margin-right: auto;
    width: 280px; /* Adjusted width */
    max-width: 100%;
    font-family: 'Lato', sans-serif;
    box-sizing: border-box;
}

.fixed-calendar-header {
    width: 100%;
    height: 50px; /* Adjusted height */
    text-align: center;
    background-color: #FF6860;
    padding: 0; /* Removed padding */
    border-radius: 12px 12px 0 0;
    box-sizing: border-box;
    position: relative;
    display: flex; /* Added to center content */
    align-items: center; /* Added to center content */
    justify-content: center; /* Added to center content */
}

.fixed-calendar-header h3 {
    font-size: 1.1rem;
    color: #ffffff;
    margin: 0;
    padding: 0; /* Removed padding */
    display: inline-block;
    line-height: 1; /* Adjusted line-height */
}

.fixed-calendar-chev {
    position: absolute;
    top: 50%; /* Adjusted top */
    transform: translateY(-50%);
    width: 36px;
    height: 36px;
    line-height: 36px;
    text-align: center;
    border-radius: 50%;
    cursor: pointer;
    color: #fff;
    font-weight: 700;
    user-select: none;
    transition: background-color 0.2s; /* Added transition */
}

.fixed-calendar-chev:hover {
    background-color: rgba(255, 255, 255, 0.2); /* Added hover effect */
}

.fixed-calendar-chev.left { left: 8px; }
.fixed-calendar-chev.right { right: 8px; }

.fixed-calendar-weekdays,
.fixed-calendar-content {
    position: relative;
    width: 280px; /* Adjusted width */
    max-width: 100%;
    overflow: hidden;
    box-sizing: border-box;
}

.fixed-calendar-weekdays {
    display: flex; /* Changed to flex */
    background-color: #FFFFFF;
}

.fixed-calendar-weekdays div {
    flex: 1; /* Added for flex distribution */
    width: 40px;
    height: 40px;
    text-align: center;
    background-color: #FFFFFF;
    color: #787878;
    box-sizing: border-box;
    font-size: 0.85rem;
    line-height: 40px;
    border-bottom: 1px solid rgba(0,0,0,0.02);
    border-right: 1px solid rgba(0,0,0,0.02); /* Added border-right */
}

.fixed-calendar-weekdays div:last-child {
    border-right: none; /* Remove right border for the last element */
}

.fixed-calendar-content {
    border-radius: 0 0 12px 12px;
    box-sizing: border-box;
    overflow: hidden;
    display: flex; /* Changed to flex */
    flex-wrap: wrap; /* Allow wrapping */
}

/* Added styles for fixed calendar */
.fixed-calendar-content div {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 4px;
    font-size: 14px;
    transition: all 0.2s;
}

.fixed-calendar-content div.blank {
    cursor: default;
    background: transparent;
}

.fixed-calendar-content div.past {
    color: #666;
    cursor: not-allowed;
    background: rgba(255, 255, 255, 0.05);
}

.fixed-calendar-content div.booked {
    background: #ef4444;
    color: white;
    font-weight: 600;
}

.fixed-calendar-content div.booked:hover {
    background: #dc2626;
    transform: scale(1.05);
}

.fixed-calendar-content div.available {
    background: #22c55e;
    color: white;
    font-weight: 600;
}

.fixed-calendar-content div.available:hover {
    background: #16a34a;
    transform: scale(1.05);
}

.fixed-calendar-content div.today {
    border: 2px solid #fff;
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
}
/* </CHANGE> */

@media (max-width: 380px) {
    .fixed-calendar {
        width: 100%;
    }
    
    .fixed-calendar-weekdays,
    .fixed-calendar-content {
        width: 100%;
    }
    
    .fixed-calendar-weekdays div,
    .fixed-calendar-content div {
        width: calc(100% / 7);
        height: calc(100vw / 7 - 4px); /* Adjusted height for smaller screens */
        line-height: calc(100vw / 7 - 4px); /* Adjusted line-height */
        font-size: 0.8rem; /* Adjusted font size */
    }
    
    .fixed-calendar-header {
        padding: 12px 0; /* Adjusted padding */
        height: 44px; /* Adjusted height */
    }
    
    .fixed-calendar-header h3 {
        font-size: 1rem; /* Adjusted font size */
    }
    
    .fixed-calendar-chev {
        width: 32px;
        height: 32px;
        line-height: 32px;
    }
}

/* Added styles for region checkbox grid */
.region-checkbox-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    padding: 15px;
    background: var(--hover-bg, rgba(0, 0, 0, 0.02));
    border-radius: var(--border-radius);
    max-height: 250px;
    overflow-y: auto;
}

.region-checkbox-item label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 14px;
    user-select: none;
}

.region-checkbox-admin {
    cursor: pointer;
    width: 18px;
    height: 18px;
    accent-color: var(--primary-color, #3b82f6);
}

    </style>
</head>
<body>
    <div id="toastContainer" class="toast-container"></div>

    <div id="adminView" class="view">
        <div class="container">
            <!-- Enhanced admin panel styles -->
            <div class="admin-panel-header">
                <h1>·Éê·Éì·Éõ·Éò·Éú ·Éû·Éê·Éú·Éî·Éö·Éò</h1>
                <div>
                    <a href="onlinechat.html" class="btn btn-secondary" style="text-decoration: none;">
                        <i class="fas fa-comments"></i> ·Éù·Éú·Éö·Éê·Éò·Éú ·É©·Éê·É¢·Éò
                    </a>
                    <button class="btn btn-secondary" data-view="adminBookings">
                        <i class="fas fa-tasks"></i> ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·Éõ·Éê·É†·Éó·Éï·Éê
                    </button>
                    <a href="booking.html" class="btn btn-secondary" style="text-decoration: none;">
                        <i class="fas fa-arrow-left"></i> ·É£·Éô·Éê·Éú
                    </a>
                </div>
            </div>
            
            <!-- Added admin stats cards -->
            <div class="admin-stats" id="adminStatsContainer">
                <div class="admin-stat-card">
                    <i class="fas fa-chart-line admin-stat-icon"></i>
                    <span class="admin-stat-value" id="totalBookingsStat">0</span>
                    <span class="admin-stat-label">·É°·É£·Éö ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê</span>
                </div>
                <div class="admin-stat-card">
                    <i class="fas fa-car admin-stat-icon"></i>
                    <span class="admin-stat-value" id="totalCarsStat">0</span>
                    <span class="admin-stat-label">·Éõ·Éê·Éú·É•·Éê·Éú·Éî·Éë·Éò</span>
                </div>
                <div class="admin-stat-card">
                    <i class="fas fa-map-marked-alt admin-stat-icon"></i>
                    <span class="admin-stat-value" id="totalToursStat">0</span>
                    <span class="admin-stat-label">·É¢·É£·É†·Éî·Éë·Éò</span>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-admin-tab="cars">
                    <i class="fas fa-car"></i> ·Éõ·Éê·Éú·É•·Éê·Éú·Éî·Éë·Éò
                </button>
                <button class="tab-btn" data-admin-tab="tours">
                    <i class="fas fa-map-marked-alt"></i> ·É¢·É£·É†·Éî·Éë·Éò
                </button>
            </div>

            <button id="addNewItem" class="btn" style="margin-bottom: 2rem;">
                <i class="fas fa-plus-circle"></i> ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê
            </button>

            <div id="adminItemsContainer" class="admin-table"></div>
        </div>
    </div>

    <div id="adminBookingsView" class="view" style="display: none;">
        <div class="container">
            <div class="header">
                <h1>·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·Éõ·Éê·É†·Éó·Éï·Éê</h1>
                <button class="btn btn-secondary" data-view="admin">
                    <i class="fas fa-arrow-left"></i> ·É£·Éô·Éê·Éú
                </button>
            </div>

            <div class="filters">
                <select id="adminStatusFilter" class="select">
                    <option value="">üìä ·Éß·Éï·Éî·Éö·Éê ·É°·É¢·Éê·É¢·É£·É°·Éò</option>
                    <option value="·Éõ·Éù·Éö·Éù·Éì·Éò·Éú·É®·Éò">‚è≥ ·Éõ·Éù·Éö·Éù·Éì·Éò·Éú·É®·Éò</option>
                    <option value="·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·É£·Éö·Éò">‚úÖ ·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·É£·Éö·Éò</option>
                    <option value="·Éí·Éê·É£·É•·Éõ·Éî·Éë·É£·Éö·Éò">‚ùå ·Éí·Éê·É£·É•·Éõ·Éî·Éë·É£·Éö·Éò</option>
                </select>

                <select id="adminTypeFilter" class="select">
                    <option value="">üè∑Ô∏è ·Éß·Éï·Éî·Éö·Éê ·É¢·Éò·Éû·Éò</option>
                    <option value="cars">üöó ·Éõ·Éê·Éú·É•·Éê·Éú·Éê</option>
                    <option value="tours">üó∫Ô∏è ·É¢·É£·É†·Éò</option>
                </select>
            </div>

            <div id="admin-bookings-container"></div>
        </div>
    </div>

    <!-- Add/Edit Modal for Admin -->
    <div id="adminFormModal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" id="closeAdminModal">&times;</span>
            <h2 id="adminModalTitle">·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê</h2>
            <form id="adminForm">
                <div id="adminFormFields"></div>
                <button type="submit" class="btn">
                    <i class="fas fa-save"></i> ·É®·Éî·Éú·Éê·ÉÆ·Éï·Éê
                </button>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content confirm-modal-content">
            <h2 id="confirmTitle">·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·Éê</h2>
            <p id="confirmMessage"></p>
            <div class="confirm-actions">
                <button class="btn btn-secondary" id="confirmCancel">
                    <i class="fas fa-times"></i> ·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê
                </button>
                <button class="btn" id="confirmOk">
                    <i class="fas fa-check"></i> ·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·Éê
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { auth, db } from "./firebase-config.js"
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js"
        import {
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            getDocs,
            getDoc,
            query,
            where,
            orderBy,
            onSnapshot,
            serverTimestamp,
            increment,
            arrayUnion,
            arrayRemove,
        } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js"

        const TRANSLATION_DICT = {
            // Car types
            types: {
                "·É°·Éî·Éì·Éê·Éú·Éò": { en: "Sedan", ru: "–°–µ–¥–∞–Ω" },
                "·ÉØ·Éò·Éû·Éò": { en: "Jeep", ru: "–î–∂–∏–ø" },
                "·Éõ·Éò·Éú·Éò·Éï·Éî·Éú·Éò": { en: "Minivan", ru: "–ú–∏–Ω–∏–≤—ç–Ω" },
                "·Éê·Éï·É¢·Éù·Éë·É£·É°·Éò": { en: "Bus", ru: "–ê–≤—Ç–æ–±—É—Å" }
            },
            // Regions
            regions: {
                "·Éê·É§·ÉÆ·Éê·Éñ·Éî·Éó·Éò": { en: "Abkhazia", ru: "–ê–±—Ö–∞–∑–∏—è" },
                "·É°·Éê·Éõ·Éî·Éí·É†·Éî·Éö·Éù": { en: "Samegrelo", ru: "–°–∞–º–µ–≥—Ä–µ–ª–æ" },
                "·É†·Éê·É≠·Éê-·Éö·Éî·É©·ÉÆ·É£·Éõ·Éò": { en: "Racha-Lechkhumi", ru: "–†–∞—á–∞-–õ–µ—á—Ö—É–º–∏" },
                "·Éò·Éõ·Éî·É†·Éî·Éó·Éò": { en: "Imereti", ru: "–ò–º–µ—Ä–µ—Ç–∏" },
                "·Éí·É£·É†·Éò·Éê": { en: "Guria", ru: "–ì—É—Ä–∏—è" },
                "·Éê·É≠·Éê·É†·Éê": { en: "Adjara", ru: "–ê–¥–∂–∞—Ä–∞" },
                "·É°·Éê·Éõ·É™·ÉÆ·Éî-·ÉØ·Éê·Éï·Éê·ÉÆ·Éî·Éó·Éò": { en: "Samtskhe-Javakheti", ru: "–°–∞–º—Ü—Ö–µ-–î–∂–∞–≤–∞—Ö–µ—Ç–∏" },
                "·É®·Éò·Éì·Éê ·É•·Éê·É†·Éó·Éö·Éò": { en: "Shida Kartli", ru: "–®–∏–¥–∞ –ö–∞—Ä—Ç–ª–∏" },
                "·Éõ·É™·ÉÆ·Éî·Éó·Éê-·Éõ·Éó·Éò·Éê·Éú·Éî·Éó·Éò": { en: "Mtskheta-Mtianeti", ru: "–ú—Ü—Ö–µ—Ç–∞-–ú—Ç–∏–∞–Ω–µ—Ç–∏" },
                "·É•·Éï·Éî·Éõ·Éù ·É•·Éê·É†·Éó·Éö·Éò": { en: "Kvemo Kartli", ru: "–ö–≤–µ–º–æ –ö–∞—Ä—Ç–ª–∏" },
                "·Éô·Éê·ÉÆ·Éî·Éó·Éò": { en: "Kakheti", ru: "–ö–∞—Ö–µ—Ç–∏" },
                "·Éó·Éë·Éò·Éö·Éò·É°·Éò": { en: "Tbilisi", ru: "–¢–±–∏–ª–∏—Å–∏" }
            },
            // Fuel types
            fuelTypes: {
                "·Éë·Éî·Éú·Éñ·Éò·Éú·Éò": { en: "Gasoline", ru: "–ë–µ–Ω–∑–∏–Ω" },
                "·Éì·Éò·Éñ·Éî·Éö·Éò": { en: "Diesel", ru: "–î–∏–∑–µ–ª—å" },
                "·É∞·Éò·Éë·É†·Éò·Éì·Éò": { en: "Hybrid", ru: "–ì–∏–±—Ä–∏–¥" },
                "·Éî·Éö·Éî·É•·É¢·É†·Éù": { en: "Electric", ru: "–≠–ª–µ–∫—Ç—Ä–æ" },
                "·Éí·Éê·Éñ·Éò": { en: "Gas", ru: "–ì–∞–∑" }
            },
            // Transmission types
            transmissions: {
                "·Éõ·Éî·É•·Éê·Éú·Éò·Éô·É£·É†·Éò": { en: "Manual", ru: "–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è" },
                "·Éê·Éï·É¢·Éù·Éõ·Éê·É¢·É£·É†·Éò": { en: "Automatic", ru: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è" }
            },
            // Common colors
            colors: {
                "·Éó·Éî·Éó·É†·Éò": { en: "White", ru: "–ë–µ–ª—ã–π" },
                "·É®·Éê·Éï·Éò": { en: "Black", ru: "–ß–µ—Ä–Ω—ã–π" },
                "·Éú·Éê·É™·É†·Éò·É°·É§·Éî·É†·Éò": { en: "Gray", ru: "–°–µ—Ä—ã–π" },
                "·Éï·Éî·É†·É™·ÉÆ·Éö·Éò·É°·É§·Éî·É†·Éò": { en: "Silver", ru: "–°–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π" },
                "·É¨·Éò·Éó·Éî·Éö·Éò": { en: "Red", ru: "–ö—Ä–∞—Å–Ω—ã–π" },
                "·Éö·É£·É†·ÉØ·Éò": { en: "Blue", ru: "–°–∏–Ω–∏–π" },
                "·Éß·Éê·Éï·Éò·É°·É§·Éî·É†·Éò": { en: "Brown", ru: "–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π" },
                "·Éõ·É¨·Éï·Éê·Éú·Éî": { en: "Green", ru: "–ó–µ–ª–µ–Ω—ã–π" },
                "·Éß·Éï·Éò·Éó·Éî·Éö·Éò": { en: "Yellow", ru: "–ñ–µ–ª—Ç—ã–π" },
                "·Éú·Éê·É†·Éò·Éú·ÉØ·Éò·É°·É§·Éî·É†·Éò": { en: "Orange", ru: "–û—Ä–∞–Ω–∂–µ–≤—ã–π" },
                "·É§·Éò·É†·É£·Éñ·Éò·É°·É§·Éî·É†·Éò": { en: "Turquoise", ru: "–ë–∏—Ä—é–∑–æ–≤—ã–π" },
                "·Éò·Éò·É°·É§·Éî·É†·Éò": { en: "Purple", ru: "–§–∏–æ–ª–µ—Ç–æ–≤—ã–π" },
                "·Éï·Éê·É†·Éì·Éò·É°·É§·Éî·É†·Éò": { en: "Pink", ru: "–†–æ–∑–æ–≤—ã–π" },
                "·Éù·É•·É†·Éù·É°·É§·Éî·É†·Éò": { en: "Gold", ru: "–ó–æ–ª–æ—Ç–æ–π" }
            }
        };

        async function getTranslation(text, fieldType = null) {
          if (!text || text.trim() === '') {
            return { ka: text, en: text, ru: text };
          }

          // Prioritize dictionary lookup for known categories
          if (fieldType && TRANSLATION_DICT[fieldType] && TRANSLATION_DICT[fieldType][text]) {
              return {
                  ka: text,
                  en: TRANSLATION_DICT[fieldType][text].en,
                  ru: TRANSLATION_DICT[fieldType][text].ru
              };
          }

          try {
            // Using MyMemory Translation API for real translations
            const enUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=ka|en`;
            const ruUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=ka|ru`;
            
            const [enResponse, ruResponse] = await Promise.all([
              fetch(enUrl),
              fetch(ruUrl)
            ]);
            
            const enData = await enResponse.json();
            const ruData = await ruResponse.json();
            
            const enTranslation = enData.responseData?.translatedText || text;
            const ruTranslation = ruData.responseData?.translatedText || text;

            console.log('[v0] Translation:', { original: text, en: enTranslation, ru: ruTranslation });

            return {
              ka: text,
              en: enTranslation,
              ru: ruTranslation
            };
          } catch (error) {
            console.error('[v0] Translation error:', error);
            return { ka: text, en: text, ru: text };
          }
        }

        const CLOUD_NAME = "dmxmlw0ln"
        const UPLOAD_PRESET = "rentime"

        async function uploadImagesToCloudinary(files) {
            const uploadUrls = [];
            const uploadPromises = Array.from(files).map(file => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', UPLOAD_PRESET);

                return fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    uploadUrls.push(data.secure_url);
                });
            });
            await Promise.all(uploadPromises);
            return uploadUrls;
        }
        
        function formatDateToLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function generateNext5YearsDates() {
            const dates = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate dates for next 5 years (1825 days)
            for (let i = 0; i < 1825; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                dates.push(formatDateToLocal(date));
            }
            
            return dates;
        }

        class AdminCalendar {
            constructor(containerId, options = {}) {
                this.container = document.getElementById(containerId);
                if (!this.container) {
                    console.error(`Container with id "${containerId}" not found`);
                    return;
                }
                
                this.currentDate = new Date();
                this.selectedDates = options.selectedDates || [];
                this.onDatesChange = options.onDatesChange || (() => {});
                this.mode = options.mode || 'booked'; // 'booked' or 'available'
                this.tourDuration = options.tourDuration || null;
                this.itemType = options.itemType || 'cars';
                
                this.monthNames = window.languageSwitcher ? window.languageSwitcher.getMonthNames() : [
                    '·Éò·Éê·Éú·Éï·Éê·É†·Éò', '·Éó·Éî·Éë·Éî·É†·Éï·Éê·Éö·Éò', '·Éõ·Éê·É†·É¢·Éò', '·Éê·Éû·É†·Éò·Éö·Éò', '·Éõ·Éê·Éò·É°·Éò', '·Éò·Éï·Éú·Éò·É°·Éò',
                    '·Éò·Éï·Éö·Éò·É°·Éò', '·Éê·Éí·Éï·Éò·É°·É¢·Éù', '·É°·Éî·É•·É¢·Éî·Éõ·Éë·Éî·É†·Éò', '·Éù·É•·É¢·Éù·Éõ·Éë·Éî·É†·Éò', '·Éú·Éù·Éî·Éõ·Éë·Éî·É†·Éò', '·Éì·Éî·Éô·Éî·Éõ·Éë·Éî·É†·Éò'
                ];
                
                this.init();
            }
            
            init() {
                this.render();
            }
            
            render() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                
                if (window.languageSwitcher) {
                    this.monthNames = window.languageSwitcher.getMonthNames();
                }
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const prevLastDay = new Date(year, month, 0);
                
                const firstDayIndex = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Monday is 0
                const lastDayDate = lastDay.getDate();
                const prevLastDayDate = prevLastDay.getDate();
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const weekdays = window.languageSwitcher && window.languageSwitcher.getCurrentLanguage() === 'en'
                    ? ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
                    : window.languageSwitcher && window.languageSwitcher.getCurrentLanguage() === 'ru'
                    ? ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å']
                    : ['·Éù·É†·É®', '·É°·Éê·Éõ', '·Éù·Éó·ÉÆ', '·ÉÆ·É£·Éó', '·Éû·Éê·É†', '·É®·Éê·Éë', '·Éô·Éï·Éò'];
                
                let calendarHTML = `
                    <div class="admin-calendar-container">
                        <div class="calendar-header">
                            <button class="calendar-nav" id="prevMonth_${this.container.id}">‚Äπ</button>
                            <h2>${this.monthNames[month]} ${year}</h2>
                            <button class="calendar-nav" id="nextMonth_${this.container.id}">‚Ä∫</button>
                        </div>
                        
                        <div class="calendar-weekdays">
                            <div class="calendar-weekday">${weekdays[0]}</div>
                            <div class="calendar-weekday">${weekdays[1]}</div>
                            <div class="calendar-weekday">${weekdays[2]}</div>
                            <div class="calendar-weekday">${weekdays[3]}</div>
                            <div class="calendar-weekday">${weekdays[4]}</div>
                            <div class="calendar-weekday">${weekdays[5]}</div>
                            <div class="calendar-weekday">${weekdays[6]}</div>
                        </div>
                        
                        <div class="calendar-days" id="calendarDays_${this.container.id}">
                `;
                
                // Previous month days
                for (let i = firstDayIndex; i > 0; i--) {
                    const day = prevLastDayDate - i + 1;
                    calendarHTML += `<div class="calendar-day other-month">${day}</div>`;
                }
                
                // Current month days
                for (let i = 1; i <= lastDayDate; i++) {
                    const currentDate = new Date(year, month, i);
                    currentDate.setHours(0, 0, 0, 0);
                    const dateString = formatDateToLocal(currentDate);
                    
                    const isToday = currentDate.getTime() === today.getTime();
                    const isPast = currentDate < today;
                    const isSelected = this.selectedDates.includes(dateString);
                    
                    let classes = 'calendar-day';
                    if (isToday) classes += ' today';
                    if (isPast) classes += ' disabled';
                    if (isSelected && !isPast) classes += ' selected'; // Only selected if not past
                    
                    calendarHTML += `<div class="${classes}" data-date="${dateString}">${i}</div>`;
                }
                
                // Next month days to fill the grid
                const totalCells = firstDayIndex + lastDayDate;
                const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
                for (let i = 1; i <= remainingCells; i++) {
                    calendarHTML += `<div class="calendar-day other-month">${i}</div>`;
                }
                
                calendarHTML += `
                        </div>
                        
                        <div class="calendar-legend">
                            <div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
                                <div class="legend-item">
                                    <div class="legend-color available"></div>
                                    <span>·ÉÆ·Éî·Éö·Éõ·Éò·É°·Éê·É¨·Éï·Éì·Éù·Éõ·Éò</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color selected"></div>
                                    <span>·Éì·Éê·Éô·Éê·Éï·Éî·Éë·É£·Éö·Éò</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color past"></div>
                                    <span>·Éí·Éê·É°·É£·Éö·Éò</span>
                                </div>
                            </div>
                            <button class="make-all-available-btn" id="makeAllAvailableBtn_${this.container.id}">
                                ·Éß·Éï·Éî·Éö·Éê ·Éì·É¶·Éî ·ÉÆ·Éî·Éö·Éõ·Éò·É°·Éê·É¨·Éï·Éì·Éù·Éõ·Éò
                            </button>
                        </div>
                    </div>
                `;
                
                this.container.innerHTML = calendarHTML;
                this.attachEventListeners();
            }
            
            attachEventListeners() {
                const prevBtn = document.getElementById(`prevMonth_${this.container.id}`);
                const nextBtn = document.getElementById(`nextMonth_${this.container.id}`);
                const makeAllAvailableBtn = document.getElementById(`makeAllAvailableBtn_${this.container.id}`);
                
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                        this.render();
                    });
                }
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                        this.render();
                    });
                }
                
                if (makeAllAvailableBtn) {
                    makeAllAvailableBtn.addEventListener('click', () => {
                        this.clearAllDates();
                    });
                }
                
                // Day selection
                const days = this.container.querySelectorAll('.calendar-day:not(.disabled):not(.other-month)');
                days.forEach(day => {
                    day.addEventListener('click', () => {
                        const dateString = day.dataset.date;
                        if (dateString) {
                            this.toggleDate(dateString);
                        }
                    });
                });
            }
            
            toggleDate(dateString) {
                const index = this.selectedDates.indexOf(dateString);
                if (index > -1) {
                    // Date is selected, remove it
                    this.selectedDates.splice(index, 1);
                } else {
                    if (this.itemType === 'tours' && this.tourDuration) {
                        if (this.selectedDates.length >= this.tourDuration) {
                            showToast(`·Éó·É•·Éï·Éî·Éú ·É£·Éô·Éï·Éî ·Éê·Éò·É†·É©·Éò·Éî·Éó ${this.tourDuration} ·Éì·É¶·Éî. ·Éõ·Éò·Éó·Éò·Éó·Éî·Éë·É£·Éö·Éò ·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éò·É° ·Éõ·Éò·ÉÆ·Éî·Éì·Éï·Éò·Éó ·Éõ·Éî·É¢·Éò ·Éì·É¶·Éî ·Éï·Éî·É† ·Éê·Éò·É†·É©·Éî·Éï·Éó.`, "warning");
                            return;
                        }
                    }
                    // Date is not selected, add it
                    this.selectedDates.push(dateString);
                }
                this.selectedDates.sort(); // Keep dates sorted
                this.render();
                this.onDatesChange(this.selectedDates);
            }
            
            removeDate(dateString) { // Not currently used but could be useful
                const index = this.selectedDates.indexOf(dateString);
                if (index > -1) {
                    this.selectedDates.splice(index, 1);
                    this.render();
                    this.onDatesChange(this.selectedDates);
                }
            }
            
            clearAllDates() {
                this.selectedDates = [];
                this.render();
                this.onDatesChange(this.selectedDates);
            }
        }

        class FixedCalendar {
            constructor(options = {}) {
                this.container = options.container;
                this.currentDate = new Date();
                this.bookedDates = options.bookedDates || [];
                this.onDateToggle = options.onDateToggle || (() => {});
                
                this.monthNames = window.languageSwitcher ? window.languageSwitcher.getMonthNames() : [
                    '·Éò·Éê·Éú·Éï·Éê·É†·Éò', '·Éó·Éî·Éë·Éî·É†·Éï·Éê·Éö·Éò', '·Éõ·Éê·É†·É¢·Éò', '·Éê·Éû·É†·Éò·Éö·Éò', '·Éõ·Éê·Éò·É°·Éò', '·Éò·Éï·Éú·Éò·É°·Éò',
                    '·Éò·Éï·Éö·Éò·É°·Éò', '·Éê·Éí·Éï·Éò·É°·É¢·Éù', '·É°·Éî·É•·É¢·Éî·Éõ·Éë·Éî·É†·Éò', '·Éù·É•·É¢·Éù·Éõ·Éë·Éî·É†·Éò', '·Éú·Éù·Éî·Éõ·Éë·Éî·É†·Éò', '·Éì·Éî·Éô·Éî·Éõ·Éë·Éî·É†·Éò'
                ];
                this.weekdays = window.languageSwitcher && window.languageSwitcher.getCurrentLanguage() === 'en'
                    ? ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
                    : window.languageSwitcher && window.languageSwitcher.getCurrentLanguage() === 'ru'
                    ? ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±']
                    : ['·Éô·Éï·Éò', '·Éù·É†·É®', '·É°·Éê·Éõ', '·Éù·Éó·ÉÆ', '·ÉÆ·É£·Éó', '·Éû·Éê·É†', '·É®·Éê·Éë'];

                this.monthColors = [
                    '#16a085', '#1abc9c', '#c0392b', '#27ae60', '#FF6860', '#f39c12',
                    '#f1c40f', '#e67e22', '#2ecc71', '#e74c3c', '#d35400', '#2c3e50'
                ];
                
                this.init();
            }
            
            init() {
                this.render();
                this.attachEventListeners();
            }
            
            render() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                
                if (window.languageSwitcher) {
                    this.monthNames = window.languageSwitcher.getMonthNames();
                    const currentLang = window.languageSwitcher.getCurrentLanguage();
                    this.weekdays = currentLang === 'en'
                        ? ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
                        : currentLang === 'ru'
                        ? ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±']
                        : ['·Éô·Éï·Éò', '·Éù·É†·É®', '·É°·Éê·Éõ', '·Éù·Éó·ÉÆ', '·ÉÆ·É£·Éó', '·Éû·Éê·É†', '·É®·Éê·Éë'];
                }
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const firstWeekdayIndex = firstDay.getDay(); // 0 for Sunday, 6 for Saturday
                const daysInMonth = lastDay.getDate();
                
                const weekdaysContainer = document.getElementById('fixedCalendarWeekdays') || document.getElementById('fixedCalendarWeekdaysTour');
                const contentContainer = document.getElementById('fixedCalendarContent') || document.getElementById('fixedCalendarContentTour');
                const titleElement = document.getElementById('fixedCalendarTitle') || document.getElementById('fixedCalendarTitleTour');
                const headerElement = this.container.closest('.fixed-calendar').querySelector('.fixed-calendar-header'); 
                
                if (!weekdaysContainer || !contentContainer || !titleElement) return;
                
                // Render weekdays
                weekdaysContainer.innerHTML = '';
                for (let w = 0; w < 7; w++) {
                    const div = document.createElement('div');
                    div.textContent = this.weekdays[w];
                    weekdaysContainer.appendChild(div);
                }
                
                // Set header color
                const color = this.monthColors[month % this.monthColors.length];
                if(headerElement) headerElement.style.backgroundColor = color;
                titleElement.textContent = this.monthNames[month] + ' ' + year;
                
                // Render calendar days
                contentContainer.innerHTML = '';
                
                // Add blank cells for days before month starts
                // Adjusting for Sunday being the first day of the week in JS getDay()
                const jsFirstWeekdayIndex = firstDay.getDay(); // 0 for Sunday, 1 for Monday ... 6 for Saturday
                const fixedCalendarFirstWeekdayIndex = jsFirstWeekdayIndex === 0 ? 6 : jsFirstWeekdayIndex - 1; // 0 for Monday, 6 for Sunday

                for (let b = 0; b < fixedCalendarFirstWeekdayIndex; b++) {
                    const div = document.createElement('div');
                    div.className = 'blank';
                    contentContainer.appendChild(div);
                }
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Add days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(year, month, day);
                    currentDate.setHours(0, 0, 0, 0);
                    const dateString = formatDateToLocal(currentDate);
                    
                    const div = document.createElement('div');
                    div.textContent = day;
                    div.dataset.date = dateString;
                    
                    const isToday = currentDate.getTime() === today.getTime();
                    const isPast = currentDate < today;
                    const isBooked = this.bookedDates.includes(dateString);
                    
                    if (isToday) {
                        div.classList.add('today');
                        div.style.backgroundColor = color;
                    }
                    
                    if (isPast) {
                        div.classList.add('past');
                    } else if (isBooked) {
                        div.classList.add('booked');
                    } else {
                        div.classList.add('available');
                    }
                    
                    contentContainer.appendChild(div);
                }
                
                // Add blank cells to fill the grid
                const totalCells = fixedCalendarFirstWeekdayIndex + daysInMonth;
                const blanksAtEnd = totalCells <= 42 ? (42 - totalCells) : 0; // Ensure grid is 6 rows
                for (let e = 0; e < blanksAtEnd; e++) {
                    const div = document.createElement('div');
                    div.className = 'blank';
                    contentContainer.appendChild(div);
                }
            }
            
            attachEventListeners() {
                const prevBtn = document.getElementById('fixedCalendarPrev') || document.getElementById('fixedCalendarPrevTour');
                const nextBtn = document.getElementById('fixedCalendarNext') || document.getElementById('fixedCalendarNextTour');
                
                if (prevBtn) {
                    prevBtn.onclick = () => {
                        this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                        this.render();
                        this.attachEventListeners(); // Re-attach after render
                    };
                }
                
                if (nextBtn) {
                    nextBtn.onclick = () => {
                        this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                        this.render();
                        this.attachEventListeners(); // Re-attach after render
                    };
                }
                
                // Day click handler
                const contentContainer = document.getElementById('fixedCalendarContent') || document.getElementById('fixedCalendarContentTour');
                if (contentContainer) {
                    const days = contentContainer.querySelectorAll('div[data-date]:not(.past)');
                    days.forEach(day => {
                        day.onclick = () => {
                            const dateString = day.dataset.date;
                            this.toggleDate(dateString);
                        };
                    });
                }
            }
            
            toggleDate(dateString) {
                const index = this.bookedDates.indexOf(dateString);
                if (index > -1) {
                    // Date is booked, make it available
                    this.bookedDates.splice(index, 1);
                } else {
                    // Date is available, make it booked
                    this.bookedDates.push(dateString);
                }
                this.bookedDates.sort();
                this.saveData();
                this.render();
                this.attachEventListeners(); // Re-attach listeners after render
                this.onDateToggle(this.bookedDates);
            }

            makeAllAvailable() {
                this.bookedDates = [];
                this.saveData();
                this.render();
                this.attachEventListeners(); // Re-attach listeners after render
                this.onDateToggle([]);
            }
            
            saveData() {
                // Store booked dates in localStorage for persistence
                // Using container ID to differentiate car and tour calendars
                const storageKey = this.container?.id === 'fixedCalendarContent' ? 'fixedCalendarBookedDatesCars' : (this.container?.id === 'fixedCalendarContentTour' ? 'fixedCalendarBookedDatesTours' : 'fixedCalendarBookedDates');
                localStorage.setItem(storageKey, JSON.stringify(this.bookedDates));
            }
            
            loadData() {
                // Load booked dates from localStorage
                const storageKey = this.container?.id === 'fixedCalendarContent' ? 'fixedCalendarBookedDatesCars' : (this.container?.id === 'fixedCalendarContentTour' ? 'fixedCalendarBookedDatesTours' : 'fixedCalendarBookedDates');
                const savedDates = localStorage.getItem(storageKey);
                if (savedDates) {
                    this.bookedDates = JSON.parse(savedDates);
                } else {
                    // If no saved data, default to all dates booked for next 5 years
                    this.bookedDates = generateNext5YearsDates();
                }
            }
            
            getBookedDates() {
                return this.bookedDates.sort();
            }
        }

        let currentUser = null
        let isAdmin = false
        let currentView = "admin"
        let currentAdminTab = "cars"
        let allCars = []
        let allTours = []
        let editingItemId = null
        let currentItemType = null

        onAuthStateChanged(auth, async (user) => {
            currentUser = user
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid))
                isAdmin = userDoc.exists() && userDoc.data().isAdmin

                if (!isAdmin) {
                    showToast("·Éó·É•·Éï·Éî·Éú ·Éê·É† ·Éí·Éê·É•·Éï·Éó ·Éê·Éì·Éõ·Éò·Éú·Éò·É° ·É£·É§·Éö·Éî·Éë·Éî·Éë·Éò", "error")
                    window.location.href = "booking.html"
                    return
                }

                loadAdminData()
            } else {
                window.location.href = "booking.html"
            }
        })

        document.addEventListener("click", (e) => {
            const viewBtn = e.target.closest("[data-view]")
            if (viewBtn) {
                e.preventDefault()
                const view = viewBtn.dataset.view
                navigateToView(view)
            }
        })

        function navigateToView(view) {
            document.querySelectorAll(".view").forEach((v) => (v.style.display = "none"))

            const viewElement = document.getElementById(`${view}View`)

            if (viewElement) {
                viewElement.style.display = "block"
                currentView = view

                if (view === "admin") {
                    loadAdminData()
                } else if (view === "adminBookings") {
                    loadAdminBookings()
                }
            }
        }

        async function loadAdminData() {
            const container = document.getElementById("adminItemsContainer")
            if (!container) return

            container.innerHTML = '<div class="loading">·Éò·É¢·Éï·Éò·É†·Éó·Éî·Éë·Éê...</div>'

            try {
                await loadCarsAndTours()
                displayAdminItems()
                setupAdminTabs()
                loadAdminStats()
            } catch (error) {
                console.error("Error loading admin data:", error)
                container.innerHTML = '<div class="empty-state">·É®·Éî·É™·Éì·Éù·Éõ·Éê ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éò·É°·Éê·É°</div>'
            }
        }

        async function loadCarsAndTours() {
            try {
                const carsSnapshot = await getDocs(collection(db, "cars"))
                allCars = carsSnapshot.docs.map((doc) => ({ id: doc.id, ...doc.data(), createdAt: doc.data().createdAt?.toDate() || null }))

                const toursSnapshot = await getDocs(collection(db, "tours"))
                allTours = toursSnapshot.docs.map((doc) => ({ id: doc.id, ...doc.data(), createdAt: doc.data().createdAt?.toDate() || null }))
            } catch (error) {
                console.error("Error loading data:", error)
                showToast("·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê", "error")
            }
        }

        async function loadAdminStats() {
            try {
                const totalBookingsSnapshot = await getDocs(collection(db, "bookings"));
                const totalCarsSnapshot = await getDocs(collection(db, "cars"));
                const totalToursSnapshot = await getDocs(collection(db, "tours"));

                document.getElementById("totalBookingsStat").textContent = totalBookingsSnapshot.size;
                document.getElementById("totalCarsStat").textContent = totalCarsSnapshot.size;
                document.getElementById("totalToursStat").textContent = totalToursSnapshot.size;

            } catch (error) {
                console.error("Error loading admin stats:", error);
                document.getElementById("adminStatsContainer").innerHTML = '<div class="empty-state">·É®·Éî·É™·Éì·Éù·Éõ·Éê ·É°·É¢·Éê·É¢·Éò·É°·É¢·Éò·Éô·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éò·É°·Éê·É°</div>';
            }
        }

        function setupAdminTabs() {
            document.querySelectorAll("[data-admin-tab]").forEach((btn) => {
                btn.addEventListener("click", () => {
                    document.querySelectorAll("[data-admin-tab]").forEach((b) => b.classList.remove("active"))
                    btn.classList.add("active")
                    currentAdminTab = btn.dataset.adminTab
                    displayAdminItems()
                })
            })
        }

        function displayAdminItems() {
            const container = document.getElementById("adminItemsContainer")
            if (!container) return

            const items = currentAdminTab === "cars" ? allCars : allTours

            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state">·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éê·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê</div>'
                return
            }

            container.innerHTML = items.map((item) => createAdminItemCard(item, currentAdminTab)).join("")

            container.querySelectorAll(".edit-item-btn").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const itemId = btn.dataset.id
                    const item = items.find((i) => i.id === itemId)
                    openAdminFormModal(item, currentAdminTab)
                })
            })

            container.querySelectorAll(".delete-item-btn").forEach((btn) => {
                btn.addEventListener("click", () => deleteItem(btn.dataset.id, currentAdminTab))
            })
        }

        function createAdminItemCard(item, type) {
            const imageUrl =
                item.images?.[0] ||
                `https://placehold.co/150x100/e0e0e0/666666?text=${encodeURIComponent(item.name || "No Image")}`

            const licensePlateHtml = item.licensePlate 
                ? `<span><i class="fas fa-id-card"></i> ${item.licensePlate}</span>` 
                : ''

            const availableDatesHtml = type === "tours" && item.availableDates?.length > 0 && !item.restrictedMode
                ? `<span><i class="fas fa-calendar-check"></i> ${item.availableDates.length} ·ÉÆ·Éî·Éö·Éõ·Éò·É°·Éê·É¨·Éï·Éì·Éù·Éõ·Éò ·Éó·Éê·É†·Éò·É¶·Éò</span>`
                : ''

            const withDriverHtml = type === "cars" && item.withDriver 
                ? `<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;"><i class="fas fa-user-tie"></i> ·Éõ·É´·É¶·Éù·Éö·Éò·Éó</span>` 
                : ''

            return `
                    <div class="admin-item-card">
                        <img src="${imageUrl}" alt="${item.name}">
                        <div class="admin-item-info">
                            <h3>${item.name}</h3>
                            <p>${item.description || ""}</p>
                            <div class="admin-item-details">
                                <span><i class="fas fa-map-marker-alt"></i> ${item.regions && item.regions.length > 0 ? (item.regions.includes('all') ? '·Éß·Éï·Éî·Éö·Éê ·É†·Éî·Éí·Éò·Éù·Éú·Éò' : item.regions.join(', ')) : item.region}</span>
                                <span><i class="fas fa-money-bill-wave"></i> ${item.pricePerDay}‚Çæ</span>
                                ${licensePlateHtml}
                                ${withDriverHtml}
                                ${type === "cars" ? `<span><i class="fas fa-door-closed"></i> ${item.doors} ·Éô·Éê·É†·Éò</span><span><i class="fas fa-users"></i> ${item.seats} ·Éê·Éì·Éí·Éò·Éö·Éò</span>` : `<span><i class="fas fa-clock"></i> ${item.duration}</span><span><i class="fas fa-users"></i> ${item.capacity} ·Éê·Éì·Éí·Éò·Éö·Éò</span>`}
                                ${availableDatesHtml}
                            </div>
                        </div>
                        <div class="admin-item-actions">
                            <button class="btn btn-sm edit-item-btn" data-id="${item.id}"><i class="fas fa-edit"></i> ·É†·Éî·Éì·Éê·É•·É¢·Éò·É†·Éî·Éë·Éê</button>
                            <button class="btn btn-sm btn-danger delete-item-btn" data-id="${item.id}"><i class="fas fa-trash"></i> ·É¨·Éê·É®·Éö·Éê</button>
                        </div>
                    </div>
                `
        }

        async function deleteItem(itemId, type) {
            const confirmed = await showConfirm("·Éì·Éê·É†·É¨·Éõ·É£·Éú·Éî·Éë·É£·Éö·Éò ·ÉÆ·Éê·É†·Éó?", "·Éî·Éö·Éî·Éõ·Éî·Éú·É¢·Éò·É° ·É¨·Éê·É®·Éö·Éê")
            if (!confirmed) return

            try {
                const collectionName = type === "cars" ? "cars" : "tours"
                await deleteDoc(doc(db, collectionName, itemId))
                showToast("·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·É¨·Éê·Éò·É®·Éê·Éö·Éê!", "success")
                loadAdminData()
            } catch (error) {
                console.error("Error deleting item:", error)
                showToast("·É¨·Éê·É®·Éö·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê", "error")
            }
        }

        async function loadAdminBookings() {
            const container = document.getElementById("admin-bookings-container")
            if (!container) {
                console.error("Admin bookings container not found")
                return
            }

            container.innerHTML = '<div class="loading">·Éò·É¢·Éï·Éò·É†·Éó·Éî·Éë·Éê...</div>'

            try {
                const q = query(collection(db, "bookings"), orderBy("createdAt", "desc"))
                const snapshot = await getDocs(q)
                let bookings = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }))

                const statusFilter = document.getElementById("adminStatusFilter")?.value
                const typeFilter = document.getElementById("adminTypeFilter")?.value

                if (statusFilter) {
                    bookings = bookings.filter((b) => b.status === statusFilter)
                }

                if (typeFilter) {
                    bookings = bookings.filter((b) => b.itemType === typeFilter)
                }

                if (bookings.length === 0) {
                    container.innerHTML = '<div class="empty-state">·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éî·Éë·Éò ·Éê·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê</div>'
                    return
                }

                container.innerHTML = bookings.map((booking) => createAdminBookingCard(booking)).join("")

                const confirmButtons = container.querySelectorAll(".confirm-booking-btn")
                confirmButtons.forEach((btn) => {
                    btn.addEventListener("click", () =>
                        updateBookingStatus(btn.dataset.id, "·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·É£·Éö·Éò", btn.dataset.user, btn.dataset.item, btn.dataset.itemImage),
                    )
                })

                const cancelAdminButtons = container.querySelectorAll(".cancel-admin-booking-btn")
                cancelAdminButtons.forEach((btn) => {
                    btn.addEventListener("click", () =>
                        updateBookingStatus(btn.dataset.id, "·Éí·Éê·É£·É•·Éõ·Éî·Éë·É£·Éö·Éò", btn.dataset.user, btn.dataset.item, btn.dataset.itemImage),
                    )
                })
            } catch (error) {
                console.error("Error loading admin bookings:", error)
                container.innerHTML = '<div class="empty-state">·É®·Éî·É™·Éì·Éù·Éõ·Éê ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éò·É°·Éê·É°</div>'
            }
        }

        function createAdminBookingCard(booking) {
            const imageHTML = booking.itemImage 
                ? `<img src="${booking.itemImage}" alt="${booking.itemName}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 1rem;">` 
                : '';
            
            const userName = booking.contactName || booking.userEmail || 'User';
            const userInitial = userName ? userName.charAt(0).toUpperCase() : 'U';
            
            const userPhotoHTML = `
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                    <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold; flex-shrink: 0;">
                        ${userInitial}
                    </div>
                    <div style="flex: 1;">
                        <p style="margin: 0; font-weight: 600; color: var(--text-color);">${booking.contactName || 'N/A'} ${booking.contactSurname || ''}</p>
                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-muted);">${booking.contactEmail || booking.userEmail || 'N/A'}</p>
                        ${booking.contactPhone ? `<p style="margin: 0; font-size: 0.9rem; color: var(--text-muted);"><i class="fas fa-phone"></i> ${booking.contactPhone}</p>` : ''}
                    </div>
                </div>
            `;
            
            const licensePlateHTML = booking.licensePlate 
                ? `<p style="display: inline-block; margin: 0.5rem 0; padding: 0.5rem 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 20px; font-weight: 700; border: 1px solid var(--border-color);">
                    <i class="fas fa-id-card" style="color: var(--primary-color);"></i> ${booking.licensePlate}
                  </p>` 
                : '';
            
            return `
                    <div class="booking-card">
                        ${imageHTML}
                        ${userPhotoHTML}
                        ${licensePlateHTML}
                        <div class="booking-header">
                            <div>
                                <h3>${booking.itemName}</h3>
                                <p class="text-muted">${booking.itemType === "cars" ? "üöó ·Éõ·Éê·Éú·É•·Éê·Éú·Éê" : "üó∫Ô∏è ·É¢·É£·É†·Éò"}</p>
                            </div>
                            <span class="status-badge status-${booking.status}">${booking.status}</span>
                        </div>
                        <div class="booking-details">
                            <p><strong>·Éì·Éê·É¨·Éß·Éî·Éë·Éê:</strong> ${booking.startDate} ${booking.startTime || ""}</p>
                            <p><strong>·Éì·Éê·É°·É†·É£·Éö·Éî·Éë·Éê:</strong> ${booking.endDate} ${booking.endTime || ""}</p>
                            <p><strong>·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê:</strong> ${booking.duration} ·Éì·É¶·Éî</p>
                            <p><strong>·É§·Éê·É°·Éò:</strong> ${booking.totalPrice}‚Çæ</p>
                            ${booking.contactDescription ? `<p><strong>·Éê·É¶·É¨·Éî·É†·Éê:</strong> ${booking.contactDescription}</p>` : ''}
                        </div>
                        ${
                            booking.status === "·Éõ·Éù·Éö·Éù·Éì·Éò·Éú·É®·Éò"
                            ? `
                            <div class="booking-actions">
                                <button class="btn btn-sm confirm-booking-btn" 
                                        data-id="${booking.id}" 
                                        data-user="${booking.userId}"
                                        data-item="${booking.itemName}"
                                        data-item-image="${booking.itemImage || ''}">
                                    ·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·Éê
                                </button>
                                <button class="btn btn-sm btn-danger cancel-admin-booking-btn" 
                                        data-id="${booking.id}" 
                                        data-user="${booking.userId}"
                                        data-item="${booking.itemName}"
                                        data-item-image="${booking.itemImage || ''}">
                                    ·É£·Éê·É†·Éß·Éù·É§·Éê
                                </button>
                            </div>
                        `
                            : ""
                        }
                    </div>
                `
        }

        async function updateBookingStatus(bookingId, status, userId, itemName, itemImage) { // Added itemImage parameter
            const confirmMessage =
                status === "·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·É£·Éö·Éò"
                ? "·Éì·Éê·É†·É¨·Éõ·É£·Éú·Éî·Éë·É£·Éö·Éò ·ÉÆ·Éê·É†·Éó, ·É†·Éù·Éõ ·Éí·É°·É£·É†·Éó ·Éê·Éõ ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·Éê?"
                : "·Éì·Éê·É†·É¨·Éõ·É£·Éú·Éî·Éë·É£·Éö·Éò ·ÉÆ·Éê·É†·Éó, ·É†·Éù·Éõ ·Éí·É°·É£·É†·Éó ·Éê·Éõ ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·É£·Éê·É†·Éß·Éù·É§·Éê?"

            const confirmed = await showConfirm(confirmMessage, "·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·É°·É¢·Éê·É¢·É£·É°·Éò·É° ·É®·Éî·É™·Éï·Éö·Éê")
            if (!confirmed) return

            try {
                await updateDoc(doc(db, "bookings", bookingId), {
                    status,
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUser.uid,
                })

                const notificationData = {
                    userId,
                    bookingId,
                    read: false,
                    createdAt: serverTimestamp(),
                }

                if (status === "·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·É£·Éö·Éò") {
                    notificationData.title = "‚úì ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê ·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·É£·Éö·Éò·Éê!"
                    notificationData.message = `·Éí·Éò·Éö·Éù·É™·Éê·Éï·Éó! ·Éó·É•·Éï·Éî·Éú·Éò ·Éì·Éê·ÉØ·Éê·Éï·É®·Éï·Éú·Éê "${itemName}" ·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éì·Éê ·Éê·Éì·Éõ·Éò·Éú·Éò·É° ·Éõ·Éò·Éî·É†. ·É®·Éî·Éí·Éò·É´·Éö·Éò·Éê·Éó ·Éú·Éê·ÉÆ·Éù·Éó ·Éì·Éî·É¢·Éê·Éö·Éî·Éë·Éò "·É©·Éî·Éõ·Éò ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éî·Éë·Éò" ·Éí·Éê·Éú·Éß·Éù·É§·Éò·Éö·Éî·Éë·Éê·É®·Éò.`
                    notificationData.type = "booking_approved"
                } else {
                    notificationData.title = "‚úó ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê ·É£·Éê·É†·Éß·Éù·É§·Éò·Éö·Éò·Éê"
                    notificationData.message = `·É°·Éê·Éõ·É¨·É£·ÉÆ·Éê·É†·Éù·Éì, ·Éó·É•·Éï·Éî·Éú·Éò ·Éì·Éê·ÉØ·Éê·Éï·É®·Éï·Éú·Éê "${itemName}" ·É£·Éê·É†·Éß·Éù·É§·Éò·Éö·Éò·Éê ·Éê·Éì·Éõ·Éò·Éú·Éò·É° ·Éõ·Éò·Éî·É†. ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éò·Éó·Éò ·Éò·Éú·É§·Éù·É†·Éõ·Éê·É™·Éò·Éò·É°·Éó·Éï·Éò·É° ·Éì·Éê·Éí·Éï·Éò·Éô·Éê·Éï·É®·Éò·É†·Éì·Éò·Éó.`
                    notificationData.type = "booking_rejected"
                }

                await addDoc(collection(db, "notifications"), notificationData)

                showToast(
                    `·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê ${status === "·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·É£·Éö·Éò" ? "·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éì·Éê" : "·É£·Éê·É†·Éß·Éù·É§·Éò·Éö·Éò·Éê"}.\n·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éî·Éö·É° ·Éí·Éê·Éî·Éí·Éñ·Éê·Éï·Éú·Éê ·É®·Éî·É¢·Éß·Éù·Éë·Éò·Éú·Éî·Éë·Éê.`,
                    "success",
                )
                loadAdminBookings()
            } catch (error) {
                console.error("Error updating booking status:", error)
                showToast("·É°·É¢·Éê·É¢·É£·É°·Éò·É° ·É®·Éî·É™·Éï·Éö·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê", "error")
            }
        }

        document.getElementById("adminStatusFilter")?.addEventListener("change", loadAdminBookings)
        document.getElementById("adminTypeFilter")?.addEventListener("change", loadAdminBookings)

        // Add New Item button event listener
        document.getElementById("addNewItem").addEventListener("click", () => {
            openAdminFormModal(null, currentAdminTab);
        });

        // Close modal event listener
        document.getElementById("closeAdminModal").addEventListener("click", () => {
            closeAdminFormModal();
        });
        
        function closeAdminFormModal() {
            document.getElementById("adminFormModal").style.display = "none";
            editingItemId = null; // Reset editing item ID
            currentItemType = null;
            // Clean up any lingering calendar instances if necessary
            if (window.fixedCalendarInstance) {
                window.fixedCalendarInstance = null;
            }
            if (window.tourFixedCalendarInstance) {
                window.tourFixedCalendarInstance = null;
            }
             if (window.regularCalendarInstance) {
                window.regularCalendarInstance = null;
            }
             if (window.tourRegularCalendarInstance) {
                window.tourRegularCalendarInstance = null;
            }
        }

        // Initialized region checkboxes logic - CHANGED
        function initializeRegionCheckboxes(item) {
            const allCheckbox = document.getElementById('regionAllAdmin');
            const regionCheckboxes = document.querySelectorAll('.region-checkbox-admin[data-region-admin]');
            
            // Check regions - handle both array and single value formats
            const itemRegions = item?.regions; // Get regions from the item
            const isAllRegions = itemRegions && Array.isArray(itemRegions) && itemRegions.includes('all');

            if (isAllRegions) {
                allCheckbox.checked = true;
                regionCheckboxes.forEach(cb => {
                    cb.checked = false;
                    cb.disabled = true;
                });
            } else {
                allCheckbox.checked = false;
                regionCheckboxes.forEach(cb => {
                    cb.disabled = false;
                    // Check if this region is in the array
                    if (itemRegions && Array.isArray(itemRegions) && itemRegions.includes(cb.value)) {
                        cb.checked = true;
                    } else {
                        cb.checked = false;
                    }
                });
            }
            
            // Handle "All regions" checkbox
            allCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    regionCheckboxes.forEach(cb => {
                        cb.checked = false;
                        cb.disabled = true;
                    });
                } else {
                    regionCheckboxes.forEach(cb => {
                        cb.disabled = false;
                    });
                }
            });

            // Handle individual region checkboxes
            regionCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        allCheckbox.checked = false;
                    }
                });
            });
        }

        function openAdminFormModal(item = null, type = null) {
            editingItemId = item?.id || null
            currentItemType = type || currentAdminTab

            const modal = document.getElementById("adminFormModal")
            const title = document.getElementById("adminModalTitle")
            const formFields = document.getElementById("adminFormFields")

            title.textContent = item ? "·É†·Éî·Éì·Éê·É•·É¢·Éò·É†·Éî·Éë·Éê" : "·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê"

            if (currentAdminTab === "cars") {
                const existingBookedDates = item?.bookedDates || []
                const restrictedMode = item?.restrictedMode || false
                const calendarMode = item?.calendarMode || 'select-unavailable'
                
                formFields.innerHTML = `
                        <div class="enhanced-form-section">
                            <h3><i class="fas fa-info-circle"></i> ·É´·Éò·É†·Éò·Éó·Éê·Éì·Éò ·Éò·Éú·É§·Éù·É†·Éõ·Éê·É™·Éò·Éê</h3>
                            <div class="form-group">
                                <label>·É°·Éê·ÉÆ·Éî·Éö·Éò *</label>
                                <input type="text" id="itemName" class="input" value="${item?.name || ""}" required placeholder="·Éõ·Éê·Éí: Toyota Camry">
                                ${item && item.nameTranslations ? `
                                <div class="translation-preview">
                                    <div class="translation-item">
                                        <span class="flag">üá¨üáß</span>
                                        <span class="lang-label">English:</span>
                                        <span class="translation-text">${item.nameTranslations.en || 'N/A'}</span>
                                    </div>
                                    <div class="translation-item">
                                        <span class="flag">üá∑üá∫</span>
                                        <span class="lang-label">–†—É—Å—Å–∫–∏–π:</span>
                                        <span class="translation-text">${item.nameTranslations.ru || 'N/A'}</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="form-group">
                                <label>·Éê·É¶·É¨·Éî·É†·Éê</label>
                                <textarea id="itemDescription" class="input" rows="3" placeholder="·Éõ·Éê·Éú·É•·Éê·Éú·Éò·É° ·Éì·Éî·É¢·Éê·Éö·É£·É†·Éò ·Éê·É¶·É¨·Éî·É†·Éê...">${item?.description || ""}</textarea>
                                ${item && item.descriptionTranslations ? `
                                <div class="translation-preview">
                                    <div class="translation-item">
                                        <span class="flag">üá¨üáß</span>
                                        <span class="lang-label">English:</span>
                                        <span class="translation-text">${item.descriptionTranslations.en || 'N/A'}</span>
                                    </div>
                                    <div class="translation-item">
                                        <span class="flag">üá∑üá∫</span>
                                        <span class="lang-label">–†—É—Å—Å–∫–∏–π:</span>
                                        <span class="translation-text">${item.descriptionTranslations.ru || 'N/A'}</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <div class="enhanced-form-section">
                            <h3><i class="fas fa-id-card"></i> ·É°·Éê·ÉÆ·Éî·Éö·Éõ·É¨·Éò·É§·Éù ·Éú·Éù·Éõ·Éî·É†·Éò</h3>
                            <div class="form-group">
                                <label>·Éú·Éù·Éõ·Éî·É†·Éò (·Éõ·Éê·Éí: HH-111-BB) *</label>
                                <input type="text" id="itemLicensePlate" class="input license-plate-input" 
                                    value="${item?.licensePlate || ""}" 
                                    required 
                                    placeholder="HH-111-BB"
                                    title="·É§·Éù·É†·Éõ·Éê·É¢·Éò: HH-111-BB">
                            </div>
                        </div>

                        <div class="enhanced-form-section">
                            <h3><i class="fas fa-cog"></i> ·Éì·Éî·É¢·Éê·Éö·Éî·Éë·Éò</h3>
                            <div class="form-row">
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label>·É†·Éî·Éí·Éò·Éù·Éú·Éò (·É†·Éî·Éí·Éò·Éù·Éú·Éî·Éë·Éò) *</label>
                                    <div class="region-checkbox-container">
                                        <div class="region-checkbox-item">
                                            <label>
                                                <input type="checkbox" value="all" id="regionAllAdmin" class="region-checkbox-admin">
                                                <span>·Éß·Éï·Éî·Éö·Éê ·É†·Éî·Éí·Éò·Éù·Éú·Éò (·É£·Éú·Éò·Éï·Éî·É†·É°·Éê·Éö·É£·É†·Éò)</span>
                                            </label>
                                        </div>
                                        ${[
                                            "·Éê·É§·ÉÆ·Éê·Éñ·Éî·Éó·Éò",
                                            "·É°·Éê·Éõ·Éî·Éí·É†·Éî·Éö·Éù",
                                            "·É†·Éê·É≠·Éê-·Éö·Éî·É©·ÉÆ·É£·Éõ·Éò",
                                            "·Éò·Éõ·Éî·É†·Éî·Éó·Éò",
                                            "·Éí·É£·É†·Éò·Éê",
                                            "·Éê·É≠·Éê·É†·Éê",
                                            "·É°·Éê·Éõ·É™·ÉÆ·Éî-·ÉØ·Éê·Éï·Éê·ÉÆ·Éî·Éó·Éò",
                                            "·É®·Éò·Éì·Éê ·É•·Éê·É†·Éó·Éö·Éò",
                                            "·Éõ·É™·ÉÆ·Éî·Éó·Éê-·Éõ·Éó·Éò·Éê·Éú·Éî·Éó·Éò",
                                            "·É•·Éï·Éî·Éõ·Éù ·É•·Éê·É†·Éó·Éö·Éò",
                                            "·Éô·Éê·ÉÆ·Éî·Éó·Éò",
                                            "·Éó·Éë·Éò·Éö·Éò·É°·Éò",
                                        ]
                                            .map((r) => {
                                                const isChecked = item?.regions 
                                                    ? (Array.isArray(item.regions) ? item.regions.includes(r) : item.region === r)
                                                    : false;
                                                return `
                                                <div class="region-checkbox-item">
                                                    <label>
                                                        <input type="checkbox" value="${r}" class="region-checkbox-admin" data-region-admin ${isChecked ? 'checked' : ''}>
                                                        <span>${r}</span>
                                                    </label>
                                                </div>
                                                `;
                                            })
                                            .join("")}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>·É¢·Éò·Éû·Éò *</label>
                                    <select id="itemType" class="select" required>
                                        <option value="">·Éê·Éò·É†·É©·Éò·Éî·Éó ·É¢·Éò·Éû·Éò</option>
                                        ${["·É°·Éî·Éì·Éê·Éú·Éò", "·ÉØ·Éò·Éû·Éò", "·Éõ·Éò·Éú·Éò·Éï·Éî·Éú·Éò", "·Éê·Éï·É¢·Éù·Éë·É£·É°·Éò"]
                                            .map((t) => `<option value="${t}" ${item?.type === t ? "selected" : ""}>${t}</option>`)
                                            .join("")}
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>·É§·Éê·É°·Éò ·Éì·É¶·Éî·É®·Éò (‚Çæ) *</label>
                                    <input type="number" id="itemPrice" class="input" value="${item?.pricePerDay || ""}" required min="0" placeholder="100">
                                </div>
                                <div class="form-group">
                                    <label>·Éô·Éê·É†·Éî·Éë·Éò *</label>
                                    <input type="number" id="itemDoors" class="input" value="${item?.doors || ""}" required min="2" max="6" placeholder="4">
                                </div>
                                <div class="form-group">
                                    <label>·Éê·Éì·Éí·Éò·Éö·Éî·Éë·Éò *</label>
                                    <input type="number" id="itemSeats" class="input" value="${item?.seats || ""}" required min="2" max="50" placeholder="5">
                                </div>
                            </div>
                            
                            <!-- Added additional car specifications -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label>·É°·Éê·É¨·Éï·Éê·Éï·Éò·É° ·É¢·Éò·Éû·Éò *</label>
                                    <select id="itemFuelType" class="select" required>
                                        <option value="">·Éê·Éò·É†·É©·Éò·Éî·Éó ·É°·Éê·É¨·Éï·Éê·Éï·Éò</option>
                                        ${["·Éë·Éî·Éú·Éñ·Éò·Éú·Éò", "·Éì·Éò·Éñ·Éî·Éö·Éò", "·É∞·Éò·Éë·É†·Éò·Éì·Éò", "·Éî·Éö·Éî·É•·É¢·É†·Éù", "·Éí·Éê·Éñ·Éò"]
                                            .map((f) => `<option value="${f}" ${item?.fuelType === f ? "selected" : ""}>${f}</option>`)
                                            .join("")}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>·É´·É†·Éê·Éï·Éò·É° ·Éõ·Éù·É™·É£·Éö·Éù·Éë·Éê (L)</label>
                                    <input type="number" id="itemEngineCapacity" class="input" value="${item?.engineCapacity || ""}" step="0.1" min="0.8" max="8.0" placeholder="2.0">
                                </div>
                                <div class="form-group">
                                    <label>·É¢·É†·Éê·Éú·É°·Éõ·Éò·É°·Éò·Éê *</label>
                                    <select id="itemTransmission" class="select" required>
                                        <option value="">·Éê·Éò·É†·É©·Éò·Éî·Éó ·É¢·Éò·Éû·Éò</option>
                                        ${["·Éõ·Éî·É•·Éê·Éú·Éò·Éô·É£·É†·Éò", "·Éê·Éï·É¢·Éù·Éõ·Éê·É¢·É£·É†·Éò"]
                                            .map((t) => `<option value="${t}" ${item?.transmission === t ? "selected" : ""}>${t}</option>`)
                                            .join("")}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>·É¨·Éî·Éö·Éò</label>
                                    <input type="number" id="itemYear" class="input" value="${item?.year || ""}" min="1990" max="2025" placeholder="2020">
                                </div>
                                <div class="form-group">
                                    <label>·É§·Éî·É†·Éò</label>
                                    <input type="text" id="itemColor" class="input" value="${item?.color || ""}" placeholder="·Éõ·Éê·Éí: ·Éó·Éî·Éó·É†·Éò">
                                    ${item && item.colorTranslations ? `
                                    <div class="translation-preview">
                                        <div class="translation-item">
                                            <span class="flag">üá¨üáß</span>
                                            <span class="translation-text">${item.colorTranslations.en || 'N/A'}</span>
                                        </div>
                                        <div class="translation-item">
                                            <span class="flag">üá∑üá∫</span>
                                            <span class="translation-text">${item.colorTranslations.ru || 'N/A'}</span>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0;">
                                        <input type="checkbox" id="itemWithDriver" ${item?.withDriver ? 'checked' : ''} style="width: 20px; height: 20px; cursor: pointer;">
                                        <span><i class="fas fa-user-tie"></i> ·Éõ·É´·É¶·Éù·Éö·Éò·Éó</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éò·Éó·Éò ·Éõ·Éê·ÉÆ·Éê·É°·Éò·Éê·Éó·Éî·Éë·Éö·Éî·Éë·Éò</label>
                                <textarea id="itemFeatures" class="input" rows="2" placeholder="·Éõ·Éê·Éí: ·Éô·Éù·Éú·Éì·Éò·É™·Éò·Éù·Éú·Éî·É†·Éò, GPS, Bluetooth, ·É£·Éô·Éê·Éú·Éê ·ÉÆ·Éî·Éì·Éï·Éò·É° ·Éô·Éê·Éõ·Éî·É†·Éê">${item?.features || ""}</textarea>
                                ${item && item.featuresTranslations ? `
                                <div class="translation-preview">
                                    <div class="translation-item">
                                        <span class="flag">üá¨üáß</span>
                                        <span class="lang-label">English:</span>
                                        <span class="translation-text">${item.featuresTranslations.en || 'N/A'}</span>
                                    </div>
                                    <div class="translation-item">
                                        <span class="flag">üá∑üá∫</span>
                                        <span class="lang-label">–†—É—Å—Å–∫–∏–π:</span>
                                        <span class="translation-text">${item.featuresTranslations.ru || 'N/A'}</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <div class="enhanced-form-section">
                            <h3><i class="fas fa-calendar-times"></i> ·Éì·Éê·Éô·Éê·Éï·Éî·Éë·É£·Éö·Éò ·Éó·Éê·É†·Éò·É¶·Éî·Éë·Éò</h3>
                            
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 1rem; cursor: pointer; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid var(--border-color);">
                                    <input type="checkbox" id="fixedTimeToggle" ${calendarMode === 'fixed-booked' ? 'checked' : ''} style="width: 20px; height: 20px; cursor: pointer;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #fff; margin-bottom: 0.25rem;">
                                            <i class="fas fa-clock"></i> ·É§·Éò·É•·É°·Éò·É†·Éî·Éë·É£·Éö·Éò ·Éì·É†·Éù
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--text-color);">
                                            ·Éß·Éï·Éî·Éö·Éê ·Éì·É¶·Éî ·Éì·Éê·Éô·Éê·Éï·Éî·Éë·É£·Éö·Éò·Éê, ·ÉÆ·Éî·Éö·Éò·Éó ·Éì·Éê·Éê·Éõ·Éê·É¢·Éî·Éó ·ÉÆ·Éî·Éö·Éõ·Éò·É°·Éê·É¨·Éï·Éì·Éù·Éõ·Éò ·Éì·É¶·Éî·Éî·Éë·Éò
                                        </div>
                                    </div>
                                </label>
                            </div>

                            <div id="fixedCalendarContainer" style="display: ${calendarMode === 'fixed-booked' ? 'block' : 'none'};">
                                <div class="fixed-calendar-container">
                                    <div class="fixed-calendar-wrapper">
                                        <div class="fixed-calendar">
                                            <div class="fixed-calendar-header">
                                                <span class="fixed-calendar-chev left" id="fixedCalendarPrev">&#8249;</span>
                                                <h3 id="fixedCalendarTitle">Month Year</h3>
                                                <span class="fixed-calendar-chev right" id="fixedCalendarNext">&#8250;</span>
                                            </div>
                                            <div class="fixed-calendar-weekdays" id="fixedCalendarWeekdays"></div>
                                            <div class="fixed-calendar-content" id="fixedCalendarContent"></div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 8px;">
                                        <p style="color: #22c55e; font-size: 0.9rem; margin: 0;">
                                            <i class="fas fa-info-circle"></i> ·Éì·Éê·Éê·É¨·Éô·Éê·Éû·É£·Éú·Éî·Éó ·É¨·Éò·Éó·Éî·Éö ·Éì·É¶·Éî·Éî·Éë·Éñ·Éî ·É†·Éù·Éõ ·Éí·Éê·ÉÆ·Éê·Éì·Éù·Éó ·Éò·É°·Éò·Éú·Éò ·ÉÆ·Éî·Éö·Éõ·Éò·É°·Éê·É¨·Éï·Éì·Éù·Éõ·Éò (·Éõ·É¨·Éï·Éê·Éú·Éî)
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 1rem; cursor: pointer; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid var(--border-color);">
                                    <input type="checkbox" id="restrictedModeToggle" ${restrictedMode ? 'checked' : ''} style="width: 20px; height: 20px; cursor: pointer;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #fff; margin-bottom: 0.25rem;">
                                            <i class="fas fa-ban"></i> ·É°·É†·É£·Éö·Éò ·Éí·Éê·Éó·Éò·É®·Éï·Éê
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--text-color);">
                                            ·É†·Éù·É™·Éê ·É©·Éê·É†·Éó·É£·Éö·Éò·Éê, ·Éõ·Éê·Éú·É•·Éê·Éú·Éê ·É°·É†·É£·Éö·Éê·Éì ·Éì·Éê·Éô·Éê·Éï·Éî·Éë·É£·Éö·Éê·Éì ·Éí·Éê·Éõ·Éù·É©·Éú·Éì·Éî·Éë·Éê booking.html-·É®·Éò ·Éì·Éê ·Éô·Éê·Éö·Éî·Éú·Éì·Éê·É†·Éò ·Éí·Éê·É•·É†·Éî·Éë·Éê
                                        </div>
                                    </div>
                                </label>
                            </div>
                            
                            <div id="calendarSection" style="display: ${restrictedMode || calendarMode === 'fixed-booked' ? 'none' : 'block'};">
                                <div id="carBookedDatesCalendar"></div>
                            </div>
                            
                            <div id="restrictedMessage" style="display: ${restrictedMode ? 'block' : 'none'}; padding: 1.5rem; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 8px; text-align: center;">
                                <i class="fas fa-ban" style="font-size: 2rem; color: #ef4444; margin-bottom: 0.5rem;"></i>
                                <p style="color: #fff; font-weight: 600; margin-bottom: 0.5rem;">·Éô·Éê·Éö·Éî·Éú·Éì·Éê·É†·Éò ·Éí·Éê·Éó·Éò·É®·É£·Éö·Éò·Éê</p>
                                <p style="color: var(--text-color); font-size: 0.9rem;">·Éõ·Éê·Éú·É•·Éê·Éú·Éê ·É°·É†·É£·Éö·Éê·Éì ·Éì·Éê·Éô·Éê·Éï·Éî·Éë·É£·Éö·Éê·Éì ·Éí·Éê·Éõ·Éù·É©·Éú·Éì·Éî·Éë·Éê ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éî·Éë·Éò·É°·Éó·Éï·Éò·É°</p>
                            </div>
                            
                            <input type="hidden" id="carBookedDates" value='${JSON.stringify(existingBookedDates)}'>
                            <input type="hidden" id="restrictedMode" value="${restrictedMode}">
                            <input type="hidden" id="calendarMode" value="${calendarMode}">
                        </div>

                        <div class="enhanced-form-section">
                            <h3><i class="fas fa-images"></i> ·É§·Éù·É¢·Éù·Éî·Éë·Éò</h3>
                            <div class="form-group">
                                <label>·Éê·É¢·Éï·Éò·É†·Éó·Éî·Éó ·É§·Éù·É¢·Éù·Éî·Éë·Éò</label>
                                <input type="file" id="itemImages" class="input" multiple accept="image/*">
                                <p class="text-muted">·Éê·É†·É°·Éî·Éë·É£·Éö·Éò ·É§·Éù·É¢·Éù·Éî·Éë·Éò: ${item?.images?.length || 0}</p>
                            </div>
                        </div>
                    `
                
                setTimeout(() => {
                    let fixedCalendarInstance = null; // Use a different name to avoid conflict
                    let regularCalendarInstance = null; // Use a different name
                    
                    // Initialize fixed calendar if in fixed mode
                    const calendarModeInput = document.getElementById('calendarMode');
                    const currentCalendarMode = calendarModeInput ? calendarModeInput.value : 'select-unavailable';

                    if (currentCalendarMode === 'fixed-booked') {
                        fixedCalendarInstance = new FixedCalendar({
                            container: document.getElementById('fixedCalendarContent'),
                            bookedDates: existingBookedDates.length > 0 ? existingBookedDates : generateNext5YearsDates(),
                            onDateToggle: (dates) => {
                                document.getElementById('carBookedDates').value = JSON.stringify(dates)
                            }
                        })
                    } else if (!restrictedMode) {
                        // Initialize regular calendar if not in fixed mode and not restricted
                        regularCalendarInstance = new AdminCalendar('carBookedDatesCalendar', {
                            selectedDates: existingBookedDates,
                            mode: 'booked', // For cars, selected means booked
                            onDatesChange: (dates) => {
                                document.getElementById('carBookedDates').value = JSON.stringify(dates)
                            }
                        })
                    }
                    
                    // Fixed time toggle handler
                    const fixedTimeToggle = document.getElementById('fixedTimeToggle')
                    const fixedCalendarContainer = document.getElementById('fixedCalendarContainer')
                    const calendarSection = document.getElementById('calendarSection')
                    
                    if (fixedTimeToggle) {
                        fixedTimeToggle.addEventListener('change', (e) => {
                            const isFixed = e.target.checked
                            
                            if (isFixed) {
                                // Switch to fixed mode
                                if(calendarModeInput) calendarModeInput.value = 'fixed-booked';
                                fixedCalendarContainer.style.display = 'block'
                                calendarSection.style.display = 'none'
                                
                                // Initialize fixed calendar with all dates booked if it's not already initialized
                                if (!fixedCalendarInstance) {
                                    const currentBookedDates = JSON.parse(document.getElementById('carBookedDates').value || '[]');
                                    fixedCalendarInstance = new FixedCalendar({
                                        container: document.getElementById('fixedCalendarContent'),
                                        bookedDates: currentBookedDates.length > 0 ? currentBookedDates : generateNext5YearsDates(),
                                        onDateToggle: (dates) => {
                                            document.getElementById('carBookedDates').value = JSON.stringify(dates);
                                        }
                                    });
                                }
                            } else {
                                // Switch to regular mode
                                if(calendarModeInput) calendarModeInput.value = 'select-unavailable';
                                fixedCalendarContainer.style.display = 'none';
                                
                                // Show old calendar if not restricted
                                const restrictedToggle = document.getElementById('restrictedModeToggle');
                                if (restrictedToggle && !restrictedToggle.checked) {
                                    calendarSection.style.display = 'block';
                                    
                                    // Initialize regular calendar if it's not already initialized
                                    if (!regularCalendarInstance) {
                                        const currentBookedDates = JSON.parse(document.getElementById('carBookedDates').value || '[]');
                                        regularCalendarInstance = new AdminCalendar('carBookedDatesCalendar', {
                                            selectedDates: currentBookedDates,
                                            mode: 'booked',
                                            onDatesChange: (dates) => {
                                                document.getElementById('carBookedDates').value = JSON.stringify(dates);
                                            }
                                        });
                                    }
                                }
                            }
                        });
                    }
                    
                    // Restricted mode toggle handler
                    const restrictedModeToggle = document.getElementById('restrictedModeToggle');
                    const restrictedMessage = document.getElementById('restrictedMessage');
                    const restrictedModeInput = document.getElementById('restrictedMode');
                    
                    if (restrictedModeToggle) {
                        restrictedModeToggle.addEventListener('change', (e) => {
                            const isRestricted = e.target.checked;
                            if(restrictedModeInput) restrictedModeInput.value = isRestricted;
                            
                            if (isRestricted) {
                                calendarSection.style.display = 'none';
                                fixedCalendarContainer.style.display = 'none';
                                restrictedMessage.style.display = 'block';
                                if(fixedTimeToggle) fixedTimeToggle.disabled = true;
                            } else {
                                restrictedMessage.style.display = 'none';
                                if(fixedTimeToggle) fixedTimeToggle.disabled = false;
                                
                                if (fixedTimeToggle && fixedTimeToggle.checked) {
                                    fixedCalendarContainer.style.display = 'block';
                                } else {
                                    calendarSection.style.display = 'block';
                                }
                            }
                        });
                    }
                }, 100);

            } else { // It's a Tour
                const existingBookedDates = item?.bookedDates || [] // Using bookedDates for tours now
                const restrictedMode = item?.restrictedMode || false
                const calendarMode = item?.calendarMode || 'select-unavailable' // Added calendarMode for tours
                
                formFields.innerHTML = `
                        <div class="enhanced-form-section">
                            <h3><i class="fas fa-info-circle"></i> ·É´·Éò·É†·Éò·Éó·Éê·Éì·Éò ·Éò·Éú·É§·Éù·É†·Éõ·Éê·É™·Éò·Éê</h3>
                            <div class="form-group">
                                <label>·É°·Éê·ÉÆ·Éî·Éö·Éò *</label>
                                <input type="text" id="itemName" class="input" value="${item?.name || ""}" required placeholder="·Éõ·Éê·Éí: ·Éô·Éê·ÉÆ·Éî·Éó·Éò·É° ·É¢·É£·É†·Éò">
                                ${item && item.nameTranslations ? `
                                <div class="translation-preview">
                                    <div class="translation-item">
                                        <span class="flag">üá¨üáß</span>
                                        <span class="lang-label">English:</span>
                                        <span class="translation-text">${item.nameTranslations.en || 'N/A'}</span>
                                    </div>
                                    <div class="translation-item">
                                        <span class="flag">üá∑üá∫</span>
                                        <span class="lang-label">–†—É—Å—Å–∫–∏–π:</span>
                                        <span class="translation-text">${item.nameTranslations.ru || 'N/A'}</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="form-group">
                                <label>·Éê·É¶·É¨·Éî·É†·Éê</label>
                                <textarea id="itemDescription" class="input" rows="3" placeholder="·É¢·É£·É†·Éò·É° ·Éì·Éî·É¢·Éê·Éö·É£·É†·Éò ·Éê·É¶·É¨·Éî·É†·Éê...">${item?.description || ""}</textarea>
                                ${item && item.descriptionTranslations ? `
                                <div class="translation-preview">
                                    <div class="translation-item">
                                        <span class="flag">üá¨üáß</span>
                                        <span class="lang-label">English:</span>
                                        <span class="translation-text">${item.descriptionTranslations.en || 'N/A'}</span>
                                    </div>
                                    <div class="translation-item">
                                        <span class="flag">üá∑üá∫</span>
                                        <span class="lang-label">–†—É—Å—Å–∫–∏–π:</span>
                                        <span class="translation-text">${item.descriptionTranslations.ru || 'N/A'}</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <div class="enhanced-form-section">
                            <h3><i class="fas fa-route"></i> ·Éõ·Éê·É†·É®·É†·É£·É¢·Éò</h3>
                            <div class="form-group">
                                <label>·Éú·Éù·Éõ·Éî·É†·Éò (·Éõ·Éê·Éí: 111)</label>
                                <input type="text" id="itemLicensePlate" class="input license-plate-input" 
                                    value="${item?.licensePlate || ""}" 
                                    placeholder="111"
                                    title="·É§·Éù·É†·Éõ·Éê·É¢·Éò: 111">
                                <small style="color: var(--text-color); font-size: 0.85rem;"> ·Éõ·Éò·Éó·Éò·Éó·Éî·Éó ·É¢·É£·É†·Éò·É° ·Éú·Éù·Éõ·Éî·É†·Éò (·É°·É£·É†·Éï·Éò·Éö·Éò·É°·Éê·Éõ·Éî·Éë·É†)</small>
                            </div>
                        </div>

                        <div class="enhanced-form-section">
                            <h3><i class="fas fa-cog"></i> ·Éì·Éî·É¢·Éê·Éö·Éî·Éë·Éò</h3>

                            <div class="form-row">
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label>·É†·Éî·Éí·Éò·Éù·Éú·Éò (·É†·Éî·Éí·Éò·Éù·Éú·Éî·Éë·Éò) *</label>
                                    <div class="region-checkbox-container">
                                        <div class="region-checkbox-item">
                                            <label>
                                                <input type="checkbox" value="all" id="regionAllAdmin" class="region-checkbox-admin">
                                                <span>·Éß·Éï·Éî·Éö·Éê ·É†·Éî·Éí·Éò·Éù·Éú·Éò (·É£·Éú·Éò·Éï·Éî·É†·É°·Éê·Éö·É£·É†·Éò)</span>
                                            </label>
                                        </div>
                                        ${[
                                            "·Éê·É§·ÉÆ·Éê·Éñ·Éî·Éó·Éò",
                                            "·É°·Éê·Éõ·Éî·Éí·É†·Éî·Éö·Éù",
                                            "·É†·Éê·É≠·Éê-·Éö·Éî·É©·ÉÆ·É£·Éõ·Éò",
                                            "·Éò·Éõ·Éî·É†·Éî·Éó·Éò",
                                            "·Éí·É£·É†·Éò·Éê",
                                            "·Éê·É≠·Éê·É†·Éê",
                                            "·É°·Éê·Éõ·É™·ÉÆ·Éî-·ÉØ·Éê·Éï·Éê·ÉÆ·Éî·Éó·Éò",
                                            "·É®·Éò·Éì·Éê ·É•·Éê·É†·Éó·Éö·Éò",
                                            "·Éõ·É™·ÉÆ·Éî·Éó·Éê-·Éõ·Éó·Éò·Éê·Éú·Éî·Éó·Éò",
                                            "·É•·Éï·Éî·Éõ·Éù ·É•·Éê·É†·Éó·Éö·Éò",
                                            "·Éô·Éê·ÉÆ·Éî·Éó·Éò",
                                            "·Éó·Éë·Éò·Éö·Éò·É°·Éò",
                                        ]
                                            .map((r) => {
                                                const isChecked = item?.regions 
                                                    ? (Array.isArray(item.regions) ? item.regions.includes(r) : item.region === r)
                                                    : false;
                                                return `
                                                <div class="region-checkbox-item">
                                                    <label>
                                                        <input type="checkbox" value="${r}" class="region-checkbox-admin" data-region-admin ${isChecked ? 'checked' : ''}>
                                                        <span>${r}</span>
                                                    </label>
                                                </div>
                                                `;
                                            })
                                            .join("")}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>·É¢·Éò·Éû·Éò *</label>
                                    <select id="itemType" class="select" required>
                                        <option value="">·Éê·Éò·É†·É©·Éò·Éî·Éó ·É¢·Éò·Éû·Éò</option>
                                        ${["·Éô·É£·Éö·É¢·É£·É†·É£·Éö·Éò", "·É°·Éê·Éó·Éê·Éï·Éí·Éê·Éì·Éê·É°·Éê·Éï·Éö·Éù", "·Éí·Éê·É°·É¢·É†·Éù·Éú·Éù·Éõ·Éò·É£·Éö·Éò", "·Éò·É°·É¢·Éù·É†·Éò·É£·Éö·Éò"]
                                            .map((t) => `<option value="${t}" ${item?.type === t ? "selected" : ""}>${t}</option>`)
                                            .join("")}
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>·É§·Éê·É°·Éò (‚Çæ) *</label>
                                    <input type="number" id="itemPrice" class="input" value="${item?.pricePerDay || ""}" required min="0" placeholder="150">
                                </div>
                                <div class="form-group">
                                    <label>·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê *</label>
                                    <input type="text" id="itemDuration" class="input" value="${item?.duration || ""}" placeholder="·Éõ·Éê·Éí: 3 ·Éì·É¶·Éî" required>
                                </div>
                                <div class="form-group">
                                    <label>·Éê·Éì·Éí·Éò·Éö·Éî·Éë·Éò *</label>
                                    <input type="number" id="itemCapacity" class="input" value="${item?.capacity || ""}" required min="1" placeholder="10">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>·Éõ·Éê·É†·É®·É†·É£·É¢·Éò</label>
                                <textarea id="itemRoute" class="input" rows="2" placeholder="·Éõ·Éê·Éí: ·Éó·Éë·Éò·Éö·Éò·É°·Éò - ·É°·Éò·É¶·Éú·Éê·É¶·Éò - ·Éë·Éù·Éì·Éë·Éî - ·Éó·Éë·Éò·Éö·Éò·É°·Éò">${item?.route || ""}</textarea>
                                ${item && item.routeTranslations ? `
                                <div class="translation-preview">
                                    <div class="translation-item">
                                        <span class="flag">üá¨üáß</span>
                                        <span class="lang-label">English:</span>
                                        <span class="translation-text">${item.routeTranslations.en || 'N/A'}</span>
                                    </div>
                                    <div class="translation-item">
                                        <span class="flag">üá∑üá∫</span>
                                        <span class="lang-label">–†—É—Å—Å–∫–∏–π:</span>
                                        <span class="translation-text">${item.routeTranslations.ru || 'N/A'}</span>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="enhanced-form-section">
                            <h3><i class="fas fa-calendar-times"></i> ·ÉÆ·Éî·Éö·Éõ·Éò·É°·Éê·É¨·Éï·Éì·Éù·Éõ·Éò ·Éó·Éê·É†·Éò·É¶·Éî·Éë·Éò</h3>
                            
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 1rem; cursor: pointer; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid var(--border-color);">
                                    <input type="checkbox" id="fixedTimeToggleTour" ${calendarMode === 'fixed-booked' ? 'checked' : ''} style="width: 20px; height: 20px; cursor: pointer;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #fff; margin-bottom: 0.25rem;">
                                            <i class="fas fa-clock"></i> ·Éß·Éï·Éî·Éö·Éê ·Éì·É¶·Éî ·Éì·Éê·Éô·Éê·Éï·Éî·Éë·É£·Éö·Éò·Éê (·É§·Éò·É•·É°·Éò·É†·Éî·Éë·É£·Éö·Éò)
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--text-color);">
                                            ·Éß·Éï·Éî·Éö·Éê ·Éì·É¶·Éî ·Éì·Éê·Éô·Éê·Éï·Éî·Éë·É£·Éö·Éê·Éì ·Éí·Éê·Éõ·Éù·É©·Éú·Éì·Éî·Éë·Éê, ·ÉÆ·Éî·Éö·Éò·Éó ·Éì·Éê·Éê·Éõ·Éê·É¢·Éî·Éó ·ÉÆ·Éî·Éö·Éõ·Éò·É°·Éê·É¨·Éï·Éì·Éù·Éõ·Éò ·Éì·É¶·Éî·Éî·Éë·Éò
                                        </div>
                                    </div>
                                </label>
                            </div>

                            <div id="fixedCalendarContainerTour" style="display: ${calendarMode === 'fixed-booked' ? 'block' : 'none'};">
                                <div class="fixed-calendar-container">
                                    <div class="fixed-calendar-wrapper">
                                        <div class="fixed-calendar">
                                            <div class="fixed-calendar-header">
                                                <span class="fixed-calendar-chev left" id="fixedCalendarPrevTour">&#8249;</span>
                                                <h3 id="fixedCalendarTitleTour">Month Year</h3>
                                                <span class="fixed-calendar-chev right" id="fixedCalendarNextTour">&#8250;</span>
                                            </div>
                                            <div class="fixed-calendar-weekdays" id="fixedCalendarWeekdaysTour"></div>
                                            <div class="fixed-calendar-content" id="fixedCalendarContentTour"></div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; border-radius: 8px;">
                                        <p style="color: #22c55e; font-size: 0.9rem; margin: 0;">
                                            <i class="fas fa-info-circle"></i> ·Éì·Éê·Éê·É¨·Éô·Éê·Éû·É£·Éú·Éî·Éó ·É¨·Éò·Éó·Éî·Éö ·Éì·É¶·Éî·Éî·Éë·Éñ·Éî ·É†·Éù·Éõ ·Éí·Éê·ÉÆ·Éê·Éì·Éù·Éó ·Éò·É°·Éò·Éú·Éò ·ÉÆ·Éî·Éö·Éõ·Éò·É°·Éê·É¨·Éï·Éì·Éù·Éõ·Éò (·Éõ·É¨·Éï·Éê·Éú·Éî)
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 1rem; cursor: pointer; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid var(--border-color);">
                                    <input type="checkbox" id="restrictedModeToggle" ${restrictedMode ? 'checked' : ''} style="width: 20px; height: 20px; cursor: pointer;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #fff; margin-bottom: 0.25rem;">
                                            <i class="fas fa-ban"></i> ·É°·É†·É£·Éö·Éò ·Éí·Éê·Éó·Éò·É®·Éï·Éê
                                        </div>
                                        <div style="font-size: 0.85rem; color: var(--text-color);">
                                            ·É†·Éù·É™·Éê ·É©·Éê·É†·Éó·É£·Éö·Éò·Éê, ·É¢·É£·É†·Éò ·É°·É†·É£·Éö·Éê·Éì ·Éì·Éê·Éô·Éê·Éï·Éî·Éë·É£·Éö·Éê·Éì ·Éí·Éê·Éõ·Éù·É©·Éú·Éì·Éî·Éë·Éê booking.html-·É®·Éò ·Éì·Éê ·Éô·Éê·Éö·Éî·Éú·Éì·Éê·É†·Éò ·Éí·Éê·É•·É†·Éî·Éë·Éê
                                        </div>
                                    </div>
                                </label>
                            </div>
                            
                            <div id="calendarSection" style="display: ${restrictedMode || calendarMode === 'fixed-booked' ? 'none' : 'block'};">
                                <div id="tourBookedDatesCalendar"></div>
                            </div>
                            
                            <div id="restrictedMessage" style="display: ${restrictedMode ? 'block' : 'none'}; padding: 1.5rem; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 8px; text-align: center;">
                                <i class="fas fa-ban" style="font-size: 2rem; color: #ef4444; margin-bottom: 0.5rem;"></i>
                                <p style="color: #fff; font-weight: 600; margin-bottom: 0.5rem;">·Éô·Éê·Éö·Éî·Éú·Éì·Éê·É†·Éò ·Éí·Éê·Éó·Éò·É®·É£·Éö·Éò·Éê</p>
                                <p style="color: var(--text-color); font-size: 0.9rem;">·É¢·É£·É†·Éò ·É°·É†·É£·Éö·Éê·Éì ·Éì·Éê·Éô·Éê·Éï·Éî·Éë·É£·Éö·Éê·Éì ·Éí·Éê·Éõ·Éù·É©·Éú·Éì·Éî·Éë·Éê ·Éõ·Éù·Éõ·ÉÆ·Éõ·Éê·É†·Éî·Éë·Éö·Éî·Éë·Éò·É°·Éó·Éï·Éò·É°</p>
                            </div>
                            
                            <input type="hidden" id="tourBookedDates" value='${JSON.stringify(existingBookedDates)}'>
                            <input type="hidden" id="restrictedMode" value="${restrictedMode}">
                            <input type="hidden" id="calendarMode" value="${calendarMode}">
                        </div>

                        <div class="enhanced-form-section">
                            <h3><i class="fas fa-images"></i> ·É§·Éù·É¢·Éù·Éî·Éë·Éò</h3>
                            <div class="form-group">
                                <label>·Éê·É¢·Éï·Éò·É†·Éó·Éî·Éó ·É§·Éù·É¢·Éù·Éî·Éë·Éò</label>
                                <input type="file" id="itemImages" class="input" multiple accept="image/*">
                                <p class="text-muted">·Éê·É†·É°·Éî·Éë·É£·Éö·Éò ·É§·Éù·É¢·Éù·Éî·Éë·Éò: ${item?.images?.length || 0}</p>
                            </div>
                        </div>
                    `

                setTimeout(() => {
                    let tourFixedCalendarInstance = null; // Instance for tour fixed calendar
                    let tourRegularCalendarInstance = null; // Instance for tour regular calendar
                    
                    // Initialize tour calendar based on mode
                    const calendarModeInput = document.getElementById('calendarMode');
                    const currentCalendarMode = calendarModeInput ? calendarModeInput.value : 'select-unavailable';

                    if (currentCalendarMode === 'fixed-booked') {
                        tourFixedCalendarInstance = new FixedCalendar({
                            container: document.getElementById('fixedCalendarContentTour'),
                            bookedDates: existingBookedDates.length > 0 ? existingBookedDates : generateNext5YearsDates(),
                            onDateToggle: (dates) => {
                                document.getElementById('tourBookedDates').value = JSON.stringify(dates)
                            }
                        })
                        // Update DOM element references for tour
                        const prevTourBtn = document.getElementById('fixedCalendarPrevTour');
                        const nextTourBtn = document.getElementById('fixedCalendarNextTour');

                        if(prevTourBtn) prevTourBtn.onclick = () => { tourFixedCalendarInstance.currentDate.setMonth(tourFixedCalendarInstance.currentDate.getMonth() - 1); tourFixedCalendarInstance.render(); tourFixedCalendarInstance.attachEventListeners(); };
                        if(nextTourBtn) nextTourBtn.onclick = () => { tourFixedCalendarInstance.currentDate.setMonth(tourFixedCalendarInstance.currentDate.getMonth() + 1); tourFixedCalendarInstance.render(); tourFixedCalendarInstance.attachEventListeners(); };
                        
                        // Override render to use tour-specific elements
                        const originalRender = tourFixedCalendarInstance.render.bind(tourFixedCalendarInstance);
                        tourFixedCalendarInstance.render = function() {
                            const weekdaysContainer = document.getElementById('fixedCalendarWeekdaysTour');
                            const contentContainer = document.getElementById('fixedCalendarContentTour');
                            const titleElement = document.getElementById('fixedCalendarTitleTour');
                            const headerElement = document.querySelector('#fixedCalendarContainerTour .fixed-calendar-header');
                            
                            if (!weekdaysContainer || !contentContainer || !titleElement) return;
                            
                            const year = this.currentDate.getFullYear();
                            const month = this.currentDate.getMonth();
                            
                            if (window.languageSwitcher) {
                                this.monthNames = window.languageSwitcher.getMonthNames();
                                const currentLang = window.languageSwitcher.getCurrentLanguage();
                                this.weekdays = currentLang === 'en'
                                    ? ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
                                    : currentLang === 'ru'
                                    ? ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±']
                                    : ['·Éô·Éï·Éò', '·Éù·É†·É®', '·É°·Éê·Éõ', '·Éù·Éó·ÉÆ', '·ÉÆ·É£·Éó', '·Éû·Éê·É†', '·É®·Éê·Éë'];
                            }
                            
                            const firstDay = new Date(year, month, 1);
                            const lastDay = new Date(year, month + 1, 0);
                            const daysInMonth = lastDay.getDate();
                            
                            // Render weekdays
                            weekdaysContainer.innerHTML = '';
                            for (let w = 0; w < 7; w++) {
                                const div = document.createElement('div');
                                div.textContent = this.weekdays[w];
                                weekdaysContainer.appendChild(div);
                            }
                            
                            // Set header color
                            const color = this.monthColors[month % this.monthColors.length];
                            if(headerElement) headerElement.style.backgroundColor = color;
                            titleElement.textContent = this.monthNames[month] + ' ' + year;
                            
                            // Render calendar days
                            contentContainer.innerHTML = '';
                            
                            // Adjusting for Sunday being the first day of the week in JS getDay()
                            const jsFirstWeekdayIndex = firstDay.getDay(); // 0 for Sunday, 1 for Monday ... 6 for Saturday
                            const fixedCalendarFirstWeekdayIndex = jsFirstWeekdayIndex === 0 ? 6 : jsFirstWeekdayIndex - 1; // 0 for Monday, 6 for Sunday

                            for (let b = 0; b < fixedCalendarFirstWeekdayIndex; b++) {
                                const div = document.createElement('div');
                                div.className = 'blank';
                                contentContainer.appendChild(div);
                            }
                            
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            
                            // Add days of the month
                            for (let day = 1; day <= daysInMonth; day++) {
                                const currentDate = new Date(year, month, day);
                                currentDate.setHours(0, 0, 0, 0);
                                const dateString = formatDateToLocal(currentDate);
                                
                                const div = document.createElement('div');
                                div.textContent = day;
                                div.dataset.date = dateString;
                                
                                const isToday = currentDate.getTime() === today.getTime();
                                const isPast = currentDate < today;
                                const isBooked = this.bookedDates.includes(dateString);
                                
                                if (isToday) {
                                    div.classList.add('today');
                                    div.style.backgroundColor = color;
                                }
                                
                                if (isPast) {
                                    div.classList.add('past');
                                } else if (isBooked) {
                                    div.classList.add('booked');
                                } else {
                                    div.classList.add('available');
                                }
                                
                                contentContainer.appendChild(div);
                            }
                            
                            // Add blank cells to fill the grid
                            const totalCells = fixedCalendarFirstWeekdayIndex + daysInMonth;
                            const blanksAtEnd = totalCells <= 42 ? (42 - totalCells) : 0; // Ensure grid is 6 rows
                            for (let e = 0; e < blanksAtEnd; e++) {
                                const div = document.createElement('div');
                                div.className = 'blank';
                                contentContainer.appendChild(div);
                            }
                        };
                        tourFixedCalendarInstance.render();
                        tourFixedCalendarInstance.attachEventListeners();
                    } else if (!restrictedMode) {
                        tourRegularCalendarInstance = new AdminCalendar('tourBookedDatesCalendar', {
                            selectedDates: existingBookedDates,
                            mode: 'booked', // For tours, this calendar shows available dates, so selected means available
                            itemType: 'tours',
                            tourDuration: (() => { // Calculate tour duration from input field
                                const durationField = document.getElementById('itemDuration');
                                if (durationField && durationField.value) {
                                    const match = durationField.value.match(/\d+/);
                                    if (match) return parseInt(match[0]);
                                }
                                return null;
                            })(),
                            onDatesChange: (dates) => {
                                document.getElementById('tourBookedDates').value = JSON.stringify(dates)
                            }
                        })
                    }
                    
                    const fixedTimeToggleTour = document.getElementById('fixedTimeToggleTour')
                    const fixedCalendarContainerTour = document.getElementById('fixedCalendarContainerTour')
                    const calendarSection = document.getElementById('calendarSection')
                    
                    if (fixedTimeToggleTour) {
                        fixedTimeToggleTour.addEventListener('change', (e) => {
                            const isFixed = e.target.checked
                            
                            if (isFixed) {
                                if(calendarModeInput) calendarModeInput.value = 'fixed-booked';
                                fixedCalendarContainerTour.style.display = 'block'
                                calendarSection.style.display = 'none'
                                
                                if (!tourFixedCalendarInstance) {
                                    const currentBookedDates = JSON.parse(document.getElementById('tourBookedDates').value || '[]');
                                    tourFixedCalendarInstance = new FixedCalendar({
                                        container: document.getElementById('fixedCalendarContentTour'),
                                        bookedDates: currentBookedDates.length > 0 ? currentBookedDates : generateNext5YearsDates(),
                                        onDateToggle: (dates) => {
                                            document.getElementById('tourBookedDates').value = JSON.stringify(dates);
                                        }
                                    });
                                    // Ensure the tour fixed calendar's DOM elements are correctly referenced
                                    const tourFixedCalendar = tourFixedCalendarInstance;
                                    document.getElementById('fixedCalendarPrevTour').onclick = () => { tourFixedCalendar.currentDate.setMonth(tourFixedCalendar.currentDate.getMonth() - 1); tourFixedCalendar.render(); tourFixedCalendar.attachEventListeners(); };
                                    document.getElementById('fixedCalendarNextTour').onclick = () => { tourFixedCalendar.currentDate.setMonth(tourFixedCalendar.currentDate.getMonth() + 1); tourFixedCalendar.render(); tourFixedCalendar.attachEventListeners(); };
                                    // Override render method same as above
                                    const originalRenderLocal = tourFixedCalendarInstance.render.bind(tourFixedCalendarInstance);
                                    tourFixedCalendarInstance.render = function() {
                                        const weekdaysContainer = document.getElementById('fixedCalendarWeekdaysTour');
                                        const contentContainer = document.getElementById('fixedCalendarContentTour');
                                        const titleElement = document.getElementById('fixedCalendarTitleTour');
                                        const headerElement = document.querySelector('#fixedCalendarContainerTour .fixed-calendar-header');
                                        
                                        if (!weekdaysContainer || !contentContainer || !titleElement) return;
                                        
                                        const year = this.currentDate.getFullYear();
                                        const month = this.currentDate.getMonth();
                                        
                                        if (window.languageSwitcher) {
                                            this.monthNames = window.languageSwitcher.getMonthNames();
                                            const currentLang = window.languageSwitcher.getCurrentLanguage();
                                            this.weekdays = currentLang === 'en'
                                                ? ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
                                                : currentLang === 'ru'
                                                ? ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±']
                                                : ['·Éô·Éï·Éò', '·Éù·É†·É®', '·É°·Éê·Éõ', '·Éù·Éó·ÉÆ', '·ÉÆ·É£·Éó', '·Éû·Éê·É†', '·É®·Éê·Éë'];
                                        }
                                        
                                        const firstDay = new Date(year, month, 1);
                                        const lastDay = new Date(year, month + 1, 0);
                                        const daysInMonth = lastDay.getDate();
                                        
                                        weekdaysContainer.innerHTML = '';
                                        for (let w = 0; w < 7; w++) {
                                            const div = document.createElement('div');
                                            div.textContent = this.weekdays[w];
                                            weekdaysContainer.appendChild(div);
                                        }
                                        
                                        const color = this.monthColors[month % this.monthColors.length];
                                        if(headerElement) headerElement.style.backgroundColor = color;
                                        titleElement.textContent = this.monthNames[month] + ' ' + year;
                                        
                                        contentContainer.innerHTML = '';
                                        
                                        const jsFirstWeekdayIndex = firstDay.getDay();
                                        const fixedCalendarFirstWeekdayIndex = jsFirstWeekdayIndex === 0 ? 6 : jsFirstWeekdayIndex - 1;

                                        for (let b = 0; b < fixedCalendarFirstWeekdayIndex; b++) {
                                            const div = document.createElement('div');
                                            div.className = 'blank';
                                            contentContainer.appendChild(div);
                                        }
                                        
                                        const today = new Date();
                                        today.setHours(0, 0, 0, 0);
                                        
                                        for (let day = 1; day <= daysInMonth; day++) {
                                            const currentDate = new Date(year, month, day);
                                            currentDate.setHours(0, 0, 0, 0);
                                            const dateString = formatDateToLocal(currentDate);
                                            
                                            const div = document.createElement('div');
                                            div.textContent = day;
                                            div.dataset.date = dateString;
                                            
                                            const isToday = currentDate.getTime() === today.getTime();
                                            const isPast = currentDate < today;
                                            const isBooked = this.bookedDates.includes(dateString);
                                            
                                            if (isToday) {
                                                div.classList.add('today');
                                                div.style.backgroundColor = color;
                                            }
                                            
                                            if (isPast) {
                                                div.classList.add('past');
                                            } else if (isBooked) {
                                                div.classList.add('booked');
                                            } else {
                                                div.classList.add('available');
                                            }
                                            
                                            contentContainer.appendChild(div);
                                        }
                                        
                                        const totalCells = fixedCalendarFirstWeekdayIndex + daysInMonth;
                                        const blanksAtEnd = totalCells <= 42 ? (42 - totalCells) : 0;
                                        for (let e = 0; e < blanksAtEnd; e++) {
                                            const div = document.createElement('div');
                                            div.className = 'blank';
                                            contentContainer.appendChild(div);
                                        }
                                    };
                                    tourFixedCalendarInstance.render();
                                    tourFixedCalendarInstance.attachEventListeners();
                                }
                            } else {
                                if(calendarModeInput) calendarModeInput.value = 'select-unavailable';
                                fixedCalendarContainerTour.style.display = 'none';
                                
                                const restrictedToggle = document.getElementById('restrictedModeToggle');
                                if (restrictedToggle && !restrictedToggle.checked) {
                                    calendarSection.style.display = 'block';
                                    
                                    if (!tourRegularCalendarInstance) {
                                        const currentBookedDates = JSON.parse(document.getElementById('tourBookedDates').value || '[]');
                                        const durationField = document.getElementById('itemDuration');
                                        let durationDays = null;
                                        if (durationField && durationField.value) {
                                            const match = durationField.value.match(/\d+/);
                                            if (match) {
                                                durationDays = parseInt(match[0]);
                                            }
                                        }
                                        
                                        tourRegularCalendarInstance = new AdminCalendar('tourBookedDatesCalendar', {
                                            selectedDates: currentBookedDates,
                                            mode: 'booked',
                                            itemType: 'tours',
                                            tourDuration: durationDays, // Pass duration limit
                                            onDatesChange: (dates) => {
                                                document.getElementById('tourBookedDates').value = JSON.stringify(dates);
                                            }
                                        });
                                    }
                                }
                            }
                        })
                    }
                    
                    const toggle = document.getElementById('restrictedModeToggle')
                    const restrictedMessage = document.getElementById('restrictedMessage')
                    const restrictedModeInput = document.getElementById('restrictedMode')
                    
                    if (toggle) {
                        toggle.addEventListener('change', (e) => {
                            const isRestricted = e.target.checked
                            restrictedModeInput.value = isRestricted
                            
                            if (isRestricted) {
                                calendarSection.style.display = 'none';
                                fixedCalendarContainerTour.style.display = 'none';
                                restrictedMessage.style.display = 'block';
                                if(fixedTimeToggleTour) fixedTimeToggleTour.disabled = true;
                            } else {
                                restrictedMessage.style.display = 'none';
                                if(fixedTimeToggleTour) fixedTimeToggleTour.disabled = false;
                                
                                if (fixedTimeToggleTour && fixedTimeToggleTour.checked) {
                                    fixedCalendarContainerTour.style.display = 'block';
                                } else {
                                    calendarSection.style.display = 'block';
                                }
                            }
                        })
                    }
                }, 100)
            }

            modal.style.display = "flex"
            
            // Initialize region checkboxes after modal is rendered
            setTimeout(() => initializeRegionCheckboxes(item), 0);
        }

        document.getElementById("adminForm").addEventListener("submit", async (e) => {
            e.preventDefault()

            const name = document.getElementById("itemName").value
            const description = document.getElementById("itemDescription").value
            
            const allCheckbox = document.getElementById('regionAllAdmin');
            const regionCheckboxes = document.querySelectorAll('.region-checkbox-admin[data-region-admin]:checked');
            
            let regions = [];
            if (allCheckbox.checked) {
                // Store 'all' as the only element
                regions = ['all'];
            } else {
                // Store selected regions as array
                regions = Array.from(regionCheckboxes).map(cb => cb.value);
            }
            
            // Changed the check: if regions is empty, show toast. This applies to both cars and tours.
            if (regions.length === 0) {
                showToast("·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éê·Éò·É†·É©·Éò·Éù·Éó ·Éõ·Éò·Éú·Éò·Éõ·É£·Éõ ·Éî·É†·Éó·Éò ·É†·Éî·Éí·Éò·Éù·Éú·Éò ·Éê·Éú ·Éß·Éï·Éî·Éö·Éê ·É†·Éî·Éí·Éò·Éù·Éú·Éò", "warning");
                return;
            }
            
            const type = document.getElementById("itemType").value
            const pricePerDay = Number.parseFloat(document.getElementById("itemPrice").value)
            const imagesInput = document.getElementById("itemImages")

            const uploadButton = document.querySelector('#adminForm button[type="submit"]')
            const originalText = uploadButton.textContent
            uploadButton.textContent = "·Éó·Éê·É†·Éí·Éõ·Éú·Éê..."
            uploadButton.disabled = true

            try {
                // Translate each region separately
                const regionTranslationsPromises = regions.map(r => 
                    r === 'all' 
                        ? Promise.resolve({ ka: 'all', en: 'Universal', ru: '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π' })
                        : getTranslation(r, 'regions')
                );
                
                const regionTranslationsArray = await Promise.all(regionTranslationsPromises);
                
                // Translate name, description, type
                const [nameTranslations, descTranslations, typeTranslations] = await Promise.all([
                    getTranslation(name, null),
                    getTranslation(description, null),
                    getTranslation(type, 'types')
                ]);

                const itemData = {
                    name: nameTranslations.ka,
                    nameTranslations: nameTranslations,
                    description: descTranslations.ka,
                    descriptionTranslations: descTranslations,
                    regions: regions, // Store as array - e.g., ['·Éê·É≠·Éê·É†·Éê'] or ['·Éê·É≠·Éê·É†·Éê', '·Éí·É£·É†·Éò·Éê'] or ['all']
                    regionsTranslations: regionTranslationsArray, // Store translations array
                    type: typeTranslations.ka,
                    typeTranslations: typeTranslations,
                    pricePerDay
                }

                const restrictedModeInput = document.getElementById("restrictedMode")
                if (restrictedModeInput) {
                    itemData.restrictedMode = restrictedModeInput.value === 'true'
                }

                if (currentAdminTab === "cars") {
                    const licensePlate = document.getElementById("itemLicensePlate").value.toUpperCase()
                    if (!licensePlate) {
                        showToast("·Éí·Éó·ÉÆ·Éù·Éï·Éó ·É®·Éî·Éò·Éß·Éï·Éê·Éú·Éù·Éó ·É°·Éê·ÉÆ·Éî·Éö·Éõ·É¨·Éò·É§·Éù ·Éú·Éù·Éõ·Éî·É†·Éò", "warning")
                        uploadButton.textContent = originalText
                        uploadButton.disabled = false
                        return
                    }
                    itemData.licensePlate = licensePlate
                    
                    itemData.doors = Number.parseInt(document.getElementById("itemDoors").value)
                    itemData.seats = Number.parseInt(document.getElementById("itemSeats").value)
                    
                    const fuelType = document.getElementById("itemFuelType").value;
                    const transmission = document.getElementById("itemTransmission").value;
                    const color = document.getElementById("itemColor").value;
                    const features = document.getElementById("itemFeatures").value;
                    const engineCapacity = document.getElementById("itemEngineCapacity").value;
                    const year = document.getElementById("itemYear").value;
                    const withDriver = document.getElementById("itemWithDriver").checked;
                    
                    const translationPromises = [];
                    
                    if (fuelType) {
                        translationPromises.push(
                            getTranslation(fuelType, 'fuelTypes').then(t => {
                                itemData.fuelType = t.ka;
                                itemData.fuelTypeTranslations = t;
                            })
                        );
                    }
                    
                    if (transmission) {
                        translationPromises.push(
                            getTranslation(transmission, 'transmissions').then(t => {
                                itemData.transmission = t.ka;
                                itemData.transmissionTranslations = t;
                            })
                        );
                    }
                    
                    if (color) {
                        translationPromises.push(
                            getTranslation(color, 'colors').then(t => {
                                itemData.color = t.ka;
                                itemData.colorTranslations = t;
                            })
                        );
                    }
                    
                    if (features) {
                        translationPromises.push(
                            getTranslation(features, null).then(t => {
                                itemData.features = t.ka;
                                itemData.featuresTranslations = t;
                            })
                        );
                    }
                    
                    await Promise.all(translationPromises);
                    
                    if (engineCapacity) itemData.engineCapacity = parseFloat(engineCapacity);
                    if (year) itemData.year = parseInt(year);
                    itemData.withDriver = withDriver;
                    
                    const bookedDatesInput = document.getElementById("carBookedDates")
                    const bookedDates = JSON.parse(bookedDatesInput?.value || '[]')
                    itemData.bookedDates = bookedDates
                    
                    const calendarModeInput = document.getElementById("calendarMode")
                    itemData.calendarMode = calendarModeInput?.value || 'select-unavailable'
                } else { // Tour
                    const duration = document.getElementById("itemDuration").value;
                    const route = document.getElementById("itemRoute").value;
                    
                    itemData.capacity = Number.parseInt(document.getElementById("itemCapacity").value)
                    itemData.fixedTime = document.getElementById("fixedTimeToggleTour").checked;
                    
                    const [durationTranslations, routeTranslations] = await Promise.all([
                        getTranslation(duration, null),
                        getTranslation(route, null)
                    ]);
                    
                    itemData.duration = durationTranslations.ka;
                    itemData.durationTranslations = durationTranslations;
                    itemData.route = routeTranslations.ka;
                    itemData.routeTranslations = routeTranslations;
                    
                    const licensePlate = document.getElementById("itemLicensePlate").value.toUpperCase().trim()
                    if (licensePlate) {
                        itemData.licensePlate = licensePlate
                    }
                    
                    const bookedDatesInput = document.getElementById("tourBookedDates")
                    const bookedDates = JSON.parse(bookedDatesInput?.value || '[]')
                    itemData.bookedDates = bookedDates
                    
                    const calendarModeInput = document.getElementById("calendarMode")
                    itemData.calendarMode = calendarModeInput?.value || 'select-unavailable'
                }

                uploadButton.textContent = originalText

                if (imagesInput.files.length > 0) {
                    uploadButton.textContent = "·É§·Éù·É¢·Éù·Éî·Éë·Éò ·Éò·É¢·Éï·Éò·É†·Éó·Éî·Éë·Éê..."

                    try {
                        const imageUrls = await uploadImagesToCloudinary(imagesInput.files)
                        itemData.images = imageUrls
                    } catch (uploadError) {
                        console.error("Error uploading images:", uploadError)
                        showToast(`·É§·Éù·É¢·Éù·Éî·Éë·Éò·É° ·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê: ${uploadError.message}`, "error")
                        uploadButton.textContent = originalText
                        uploadButton.disabled = false
                        return
                    }

                    uploadButton.textContent = originalText
                }

                const collectionName = currentAdminTab === "cars" ? "cars" : "tours"

                if (editingItemId) {
                    const existingItem = (currentAdminTab === "cars" ? allCars : allTours).find((i) => i.id === editingItemId)
                    // Only update images if new ones were uploaded. Otherwise, keep existing ones.
                    if (!itemData.images && existingItem?.images) {
                        itemData.images = existingItem.images;
                    }
                    await updateDoc(doc(db, collectionName, editingItemId), itemData)
                    showToast("·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éì·Éê!", "success")
                } else {
                    itemData.bookings = 0
                    itemData.createdAt = serverTimestamp() // Add creation timestamp
                    await addDoc(collection(db, collectionName), itemData)
                    showToast("·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·Éì·Éê·Éî·Éõ·Éê·É¢·Éê!", "success")
                }

                closeAdminFormModal()
                await loadAdminData()
            } catch (error) {
                console.error("Error saving item:", error)
                showToast(`·É®·Éî·É™·Éì·Éù·Éõ·Éê: ${error.message}`, "error")
            } finally {
                uploadButton.textContent = originalText
                uploadButton.disabled = false
            }
        })

        // Placeholder for showConfirm function
        function showConfirm(message, title = "·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·Éê") {
            return new Promise((resolve) => {
                const confirmModal = document.getElementById("confirmModal");
                const confirmTitle = document.getElementById("confirmTitle");
                const confirmMessage = document.getElementById("confirmMessage");
                const confirmCancel = document.getElementById("confirmCancel");
                const confirmOk = document.getElementById("confirmOk");

                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                confirmModal.style.display = "flex";

                const handleOk = () => {
                    cleanup();
                    resolve(true);
                };

                const handleCancel = () => {
                    cleanup();
                    resolve(false);
                };

                const cleanup = () => {
                    confirmOk.removeEventListener("click", handleOk);
                    confirmCancel.removeEventListener("click", handleCancel);
                    confirmModal.style.display = "none";
                };

                confirmOk.addEventListener("click", handleOk);
                confirmCancel.addEventListener("click", handleCancel);
            });
        }

        // Placeholder for showToast function
        function showToast(message, type = "info") {
            const toastContainer = document.getElementById("toastContainer");
            const toastId = `toast-${Date.now()}`;

            const toast = document.createElement("div");
            toast.id = toastId;
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon"><i class="fas ${
                    type === "success"
                        ? "fa-check-circle"
                        : type === "error"
                        ? "fa-exclamation-circle"
                        : type === "warning"
                        ? "fa-exclamation-triangle"
                        : "fa-info-circle"
                }"></i></div>
                <div class="toast-content">
                    <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close">&times;</button>
                <div class="toast-progress"></div>
            `;
            toastContainer.appendChild(toast);

            // Auto-close toast after 5 seconds
            const autoCloseTimer = setTimeout(() => {
                removeToast(toastId);
            }, 5000);

            // Manual close button
            toast.querySelector(".toast-close").addEventListener("click", () => {
                removeToast(toastId);
                clearTimeout(autoCloseTimer);
            });
        }

        function removeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.add("removing");
                toast.addEventListener("animationend", () => {
                    toast.remove();
                });
            }
        }
        
        // Initialize the FixedCalendar for cars if it's in fixed mode initially
        // This should be called after the modal is rendered and its elements are available.
        document.addEventListener('DOMContentLoaded', () => {
            // Check if the modal form exists and is being opened to initialize calendars
            const adminFormModal = document.getElementById('adminFormModal');
            if (adminFormModal) {
                const observer = new MutationObserver((mutations, obs) => {
                    if (adminFormModal.style.display === 'flex') {
                        // Car form initialization
                        const isCarForm = document.getElementById('itemLicensePlate'); // Indicator for car form
                        if (isCarForm) {
                             const restrictedModeToggle = document.getElementById('restrictedModeToggle');
                            const fixedTimeToggle = document.getElementById('fixedTimeToggle');
                            const calendarModeInput = document.getElementById('calendarMode');

                            if (fixedTimeToggle && fixedTimeToggle.checked) {
                                const existingBookedDates = JSON.parse(document.getElementById('carBookedDates').value || '[]');
                                window.fixedCalendarInstance = new FixedCalendar({ // Make instance globally accessible for form submission
                                    container: document.getElementById('fixedCalendarContent'),
                                    bookedDates: existingBookedDates.length > 0 ? existingBookedDates : generateNext5YearsDates(),
                                    onDateToggle: (dates) => {
                                        document.getElementById('carBookedDates').value = JSON.stringify(dates);
                                    }
                                });
                            } else if (!restrictedModeToggle.checked) {
                                // Initialize regular calendar if not restricted and not in fixed time mode
                                const existingBookedDates = JSON.parse(document.getElementById('carBookedDates').value || '[]');
                                window.regularCalendarInstance = new AdminCalendar('carBookedDatesCalendar', {
                                    selectedDates: existingBookedDates,
                                    mode: 'booked',
                                    onDatesChange: (dates) => {
                                        document.getElementById('carBookedDates').value = JSON.stringify(dates);
                                    }
                                });
                            }
                        }
                        
                        // Tour form initialization
                        const isTourForm = document.getElementById('itemDuration'); // Indicator for tour form
                        if (isTourForm) {
                             const fixedTimeToggleTour = document.getElementById('fixedTimeToggleTour');
                            if (fixedTimeToggleTour && fixedTimeToggleTour.checked) {
                                const existingDatesFromHidden = JSON.parse(document.getElementById('tourBookedDates').value || '[]');
                                window.tourFixedCalendarInstance = new FixedCalendar({ // Instance for tour fixed calendar
                                    container: document.getElementById('fixedCalendarContentTour'),
                                    bookedDates: existingDatesFromHidden.length > 0 ? existingDatesFromHidden : generateNext5YearsDates(), // Default to all booked if none provided
                                    onDateToggle: (dates) => {
                                        document.getElementById('tourBookedDates').value = JSON.stringify(dates);
                                    }
                                });
                                // Ensure the tour fixed calendar's DOM elements are correctly referenced
                                const tourFixedCalendar = window.tourFixedCalendarInstance;
                                if (tourFixedCalendar) {
                                    const prevTourBtn = document.getElementById('fixedCalendarPrevTour');
                                    const nextTourBtn = document.getElementById('fixedCalendarNextTour');
                                    if(prevTourBtn) prevTourBtn.onclick = () => { tourFixedCalendar.currentDate.setMonth(tourFixedCalendar.currentDate.getMonth() - 1); tourFixedCalendar.render(); tourFixedCalendar.attachEventListeners(); };
                                    if(nextTourBtn) nextTourBtn.onclick = () => { tourFixedCalendar.currentDate.setMonth(tourFixedCalendar.currentDate.getMonth() + 1); tourFixedCalendar.render(); tourFixedCalendar.attachEventListeners(); };
                                    tourFixedCalendar.render();
                                    tourFixedCalendar.attachEventListeners();
                                }
                            } else {
                                // Initialize regular calendar for tours if not restricted and not in fixed time mode
                                const existingDates = JSON.parse(document.getElementById('tourBookedDates').value || '[]');
                                window.tourRegularCalendarInstance = new AdminCalendar('tourBookedDatesCalendar', {
                                    selectedDates: existingDates,
                                    mode: 'booked',
                                    itemType: 'tours',
                                    tourDuration: (() => { // Calculate tour duration from input field
                                        const durationField = document.getElementById('itemDuration');
                                        if (durationField && durationField.value) {
                                            const match = durationField.value.match(/\d+/);
                                            if (match) return parseInt(match[0]);
                                        }
                                        return null;
                                    })(),
                                    onDatesChange: (dates) => {
                                        document.getElementById('tourBookedDates').value = JSON.stringify(dates);
                                    }
                                });
                            }
                        }
                        obs.disconnect(); // Stop observing once initialized
                    }
                });
                observer.observe(adminFormModal, { attributes: true, attributeFilter: ['style'] });
            }
        });

    </script>
</body>
</html>
