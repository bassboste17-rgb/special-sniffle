<!DOCTYPE html>
<html lang="ka">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Georgia Trips - contact</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Updated EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="translations.js"></script>
  <script>
    (function() {
      emailjs.init("5kKR_y0O3S8mOT7iz");
    })();
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding-top: 80px;
      font-family: "BPG Glaho", sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: #fff;
      min-height: 100vh;
    }
    
    .contact-section {
      padding: 3rem 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .contact-container {
      display: flex;
      flex-wrap: wrap;
      gap: 2.5rem;
      justify-content: center;
    }
    
    .contact-info {
      flex: 1;
      min-width: 300px;
      max-width: 500px;
      padding: 2rem;
      background: linear-gradient(135deg, rgba(229, 56, 59, 0.1) 0%, rgba(255, 107, 107, 0.05) 100%);
      border-radius: 16px;
      border: 1px solid rgba(229, 56, 59, 0.2);
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .contact-info:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(229, 56, 59, 0.3);
    }
    
    .contact-info h1 {
      font-size: 2.5rem;
      margin-bottom: 2rem;
      color: #ffffff;
      text-align: center;
      background: linear-gradient(135deg, #e5383b 0%, #ff6b6b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .contact-details {
      margin-bottom: 1.5rem;
    }
    
    .contact-details p {
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 1.1rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      transition: all 0.3s ease;
    }
    
    .contact-details p:hover {
      background: rgba(229, 56, 59, 0.1);
      transform: translateX(5px);
    }
    
    .contact-details a {
      color: #ffffff;
      text-decoration: none;
      transition: color 0.3s;
    }
    
    .contact-details a:hover {
      color: #ff6b6b;
    }
    
    .contact-details i {
      color: #e5383b;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      background: rgba(229, 56, 59, 0.2);
      border-radius: 8px;
      padding: 0.5rem;
    }
    
    .contact-form {
      flex: 1;
      min-width: 500px;
      max-width: 600px;
      background: linear-gradient(135deg, rgba(26, 26, 26, 0.95) 0%, rgba(30, 30, 30, 0.95) 100%);
      padding: 2.5rem;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .contact-form:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 50px rgba(229, 56, 59, 0.2);
    }
    
    .contact-form h2 {
      font-size: 2rem;
      margin-bottom: 2rem;
      text-align: center;
      color: #fdfdfd;
      background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .contact-form input,
    .contact-form textarea {
      width: 100%;
      padding: 1rem;
      border: 2px solid rgba(229, 56, 59, 0.3);
      border-radius: 12px;
      background-color: rgba(34, 34, 34, 0.8);
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
      font-family: "BPG Glaho", sans-serif;
    }
    
    .contact-form input:focus,
    .contact-form textarea:focus {
      outline: none;
      border-color: #e5383b;
      background-color: rgba(34, 34, 34, 1);
      box-shadow: 0 0 0 3px rgba(229, 56, 59, 0.1);
    }
    
    .contact-form textarea {
      min-height: 150px;
      resize: vertical;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #e5383b 0%, #ff6b6b 100%);
      color: white;
      padding: 1rem;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      box-shadow: 0 4px 15px rgba(229, 56, 59, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(229, 56, 59, 0.5);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    .popup-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      min-width: 300px;
      max-width: 90%;
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      font-weight: bold;
      z-index: 1000;
      animation: fadeIn 0.3s;
      display: none;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }
    
    .success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    .error {
      background: linear-gradient(135deg, #dc3545 0%, #ff6b6b 100%);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -60%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }

    /* Chat widget styles */
    .chat-widget {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    .chat-button {
      width: 65px;
      height: 65px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e5383b 0%, #ff6b6b 100%);
      border: none;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(229, 56, 59, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .chat-button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .chat-button:hover::before {
      width: 100%;
      height: 100%;
    }

    .chat-button:hover {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 8px 25px rgba(229, 56, 59, 0.6);
    }

    .chat-button i {
      color: white;
      font-size: 28px;
      position: relative;
      z-index: 1;
    }

    .chat-window {
      position: fixed;
      bottom: 100px;
      right: 20px;
      width: 400px;
      height: 550px;
      background: linear-gradient(135deg, rgba(26, 26, 26, 0.98) 0%, rgba(30, 30, 30, 0.98) 100%);
      border-radius: 16px;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.6);
      display: none;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(229, 56, 59, 0.3);
      backdrop-filter: blur(20px);
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chat-window.open {
      display: flex;
    }

    .chat-header {
      background: linear-gradient(135deg, #e5383b 0%, #ff6b6b 100%);
      padding: 1.2rem;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .chat-header h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .chat-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .chat-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: rgba(15, 15, 15, 0.5);
    }
    
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(229, 56, 59, 0.5);
      border-radius: 3px;
    }
    
    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: rgba(229, 56, 59, 0.7);
    }

    .chat-message {
      max-width: 75%;
      padding: 1rem;
      border-radius: 16px;
      word-wrap: break-word;
      animation: messageSlide 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chat-message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #e5383b 0%, #ff6b6b 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .chat-message.admin {
      align-self: flex-start;
      background: linear-gradient(135deg, rgba(42, 42, 42, 0.95) 0%, rgba(50, 50, 50, 0.95) 100%);
      color: #fff;
      border-bottom-left-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-message.system {
      align-self: center;
      background: linear-gradient(135deg, rgba(51, 51, 51, 0.8) 0%, rgba(60, 60, 60, 0.8) 100%);
      color: #ccc;
      font-style: italic;
      max-width: 90%;
      text-align: center;
      font-size: 0.9rem;
      border-radius: 12px;
    }

    .chat-message-time {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 0.4rem;
    }

    .chat-input-container {
      padding: 1.2rem;
      border-top: 1px solid rgba(229, 56, 59, 0.2);
      display: flex;
      gap: 0.8rem;
      background: rgba(20, 20, 20, 0.8);
    }

    .chat-input {
      flex: 1;
      padding: 1rem;
      border: 2px solid rgba(229, 56, 59, 0.3);
      border-radius: 24px;
      background: rgba(34, 34, 34, 0.8);
      color: white;
      outline: none;
      font-family: "BPG Glaho", sans-serif;
      transition: all 0.3s ease;
    }
    
    .chat-input:focus {
      border-color: #e5383b;
      background: rgba(34, 34, 34, 1);
      box-shadow: 0 0 0 3px rgba(229, 56, 59, 0.1);
    }

    .chat-send {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e5383b 0%, #ff6b6b 100%);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(229, 56, 59, 0.4);
    }

    .chat-send:hover:not(:disabled) {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(229, 56, 59, 0.6);
    }
    
    .chat-send:active:not(:disabled) {
      transform: scale(0.95);
    }
    
    .chat-disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: linear-gradient(135deg, #666 0%, #888 100%);
    }
    
    @media (max-width: 600px) {
      body {
        padding-top: 70px;
      }

      .contact-info, 
      .contact-form {
        min-width: 100%;
        padding: 1.5rem;
      }
      
      .contact-info h1 {
        font-size: 2rem;
      }
      
      .contact-form h2 {
        font-size: 1.7rem;
      }

      /* Mobile chat styles */
      .chat-window {
        width: calc(100vw - 40px);
        height: 75vh;
        bottom: 90px;
        right: 20px;
      }
      
      .chat-button {
        width: 60px;
        height: 60px;
      }
      
      .chat-button i {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>

  <div id="navbar"></div>
  <div id="popup-message" class="popup-message" style="display: none;"></div>

  <section class="contact-section">
    <div class="contact-container">
      <div class="contact-info">
        <!-- Added translation -->
        <h1 data-i18n="contactHeading">კონტაქტი</h1>
        <div class="contact-details">
          <p>
            <i class="fas fa-phone"></i>
            <a href="tel:+995599186927" data-i18n="contactPhone">+995 599 18 69 27</a>
          </p>
          <p><i class="fas fa-envelope"></i> <a href="mailto:lominadzebusiness@gmail.com" data-i18n="contactEmail">lominadzebusiness@gmail.com</a></p>
          <p>
            <i class="fab fa-whatsapp"></i>
            <a href="https://wa.me/995599186927" target="_blank" data-i18n="contactWhatsApp">+995 599 18 69 27</a>
          </p>
          <p><i class="fas fa-clock"></i> <span data-i18n="contactAvailability">24/7</span></p>
        </div>
      </div>

      <div class="contact-form">
        <!-- Added translation -->
        <h2 data-i18n="contactFormTitle">მოგვწერე</h2>
        <form id="contact-form">
          <div class="form-group">
            <input type="text" name="name" data-i18n="contactNamePlaceholder" placeholder="სახელი" required />
          </div>
          <div class="form-group">
            <input type="email" name="email" data-i18n="contactEmailPlaceholder" placeholder="ელ. ფოსტა" required />
          </div>
          <div class="form-group">
            <textarea name="message" data-i18n="contactMessagePlaceholder" placeholder="შეტყობინება" required></textarea>
          </div>
          <button type="submit" class="btn-primary" data-i18n="contactSubmitBtn">გაგზავნე</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Chat Widget -->
  <div class="chat-widget">
    <button class="chat-button" id="chatToggle">
      <i class="fas fa-comments"></i>
    </button>
    
    <div class="chat-window" id="chatWindow">
      <div class="chat-header">
        <!-- Added translation -->
        <h3 data-i18n="contactChatOnline">ონლაინ ჩატი</h3>
        <button class="chat-close" id="chatClose">&times;</button>
      </div>
      
      <div class="chat-messages" id="chatMessages">
        <div class="chat-message system">
          <!-- Added translation -->
          <div data-i18n="contactChatWelcome">მოგესალმებით! რით შემიძლია დაგეხმაროთ?</div>
        </div>
      </div>
      
      <div class="chat-input-container">
        <!-- Added translation -->
        <input type="text" class="chat-input" id="chatInput" data-i18n="contactChatInputPlaceholder" placeholder="დაწერეთ შეტყობინება..." />
        <button class="chat-send" id="chatSend">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <div id="footer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged,
      signInAnonymously 
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { 
      getFirestore,
      collection,
      addDoc,
      doc,
      getDoc,
      getDocs,
      query,
      where,
      orderBy,
      onSnapshot,
      serverTimestamp,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBBybpmsrByBZtwThfCd3u0pfHFjEL2ap0",
      authDomain: "rentime-e201e.firebaseapp.com",
      projectId: "rentime-e201e",
      storageBucket: "rentime-e201e.firebasestorage.app",
      messagingSenderId: "420054668757",
      appId: "1:420054668757:web:0accf1d8b9d621fd94195c",
      measurementId: "G-DGWLG9P1ZB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentChatId = null;
    let messageCount = 0;
    let autoReplySent = false;
    let chatUnsubscribe = null;
    let messagesUnsubscribe = null;
    let chatInitialized = false;
    let lastMessageTime = 0;
    const MESSAGE_COOLDOWN = 4000;
    let cooldownTimer = null;
    let isSendingMessage = false;
    let pendingMessages = new Set();

    const chatToggle = document.getElementById('chatToggle');
    const chatWindow = document.getElementById('chatWindow');
    const chatClose = document.getElementById('chatClose');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSend = document.getElementById('chatSend');

    window.addEventListener('languageChanged', () => {
      updateChatTranslations();
      updateContactFormTranslations();
    });

    function updateChatTranslations() {
      // Update welcome message if no active chat
      const welcomeMsgElement = chatMessages.querySelector('.chat-message.system div');
      if (welcomeMsgElement && !currentChatId) {
        welcomeMsgElement.textContent = window.languageSwitcher.translate('contactChatWelcome');
      }
      // Update chat header
      const chatHeader = chatWindow.querySelector('.chat-header h3');
      if (chatHeader) {
        chatHeader.textContent = window.languageSwitcher.translate('contactChatOnline');
      }
      // Update input placeholder
      if (chatInput) {
        chatInput.placeholder = window.languageSwitcher.translate('contactChatInputPlaceholder');
      }
    }
    
    function updateContactFormTranslations() {
      const elements = {
        'contactTitle': 'textContent',
        'contactHeading': 'textContent',
        'contactPhone': 'textContent',
        'contactEmail': 'textContent',
        'contactWhatsApp': 'textContent',
        'contactAvailability': 'textContent',
        'contactFormTitle': 'textContent',
        'contactNamePlaceholder': 'placeholder',
        'contactEmailPlaceholder': 'placeholder',
        'contactMessagePlaceholder': 'placeholder',
        'contactSubmitBtn': 'textContent'
      };
      
      for (const [key, prop] of Object.entries(elements)) {
        const el = document.querySelector(`[data-i18n="${key}"]`);
        if (el) {
          if (prop === 'placeholder') {
            el.placeholder = window.languageSwitcher.translate(key);
          } else {
            el.textContent = window.languageSwitcher.translate(key);
          }
        }
      }
    }

    // Initialize chat
    chatToggle.addEventListener('click', () => {
      chatWindow.classList.toggle('open');
      if (chatWindow.classList.contains('open') && currentUser && !chatInitialized) {
        initializeChat();
        chatInitialized = true;
      }
    });

    chatClose.addEventListener('click', () => {
      chatWindow.classList.remove('open');
      cleanupChatListeners();
      chatInitialized = false;
    });

    chatSend.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // Auth state listener with anonymous auth fallback
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        console.log("[v0] User logged in:", user.uid);
        
        // Load user data if available
        try {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists()) {
            const userData = userDoc.data();
            console.log("[v0] User data loaded:", userData.name);
          }
        } catch (error) {
          console.log("[v0] User document not found, using anonymous chat");
        }
      } else {
        // Try anonymous authentication for chat
        try {
          const result = await signInAnonymously(auth);
          currentUser = result.user;
          console.log("[v0] Anonymous user created:", currentUser.uid);
        } catch (error) {
          console.error("[v0] Anonymous auth failed:", error);
          showChatMessage(
            window.languageSwitcher.translate('contactSystemName'), 
            window.languageSwitcher.translate('contactAuthRequired'), 
            'system'
          );
          disableChatInput();
        }
      }
    });

    function cleanupChatListeners() {
      if (chatUnsubscribe) {
        chatUnsubscribe();
        chatUnsubscribe = null;
      }
      if (messagesUnsubscribe) {
        messagesUnsubscribe();
        messagesUnsubscribe = null;
      }
      if (cooldownTimer) {
        clearInterval(cooldownTimer);
        cooldownTimer = null;
      }
    }

    function disableChatInput() {
      chatInput.disabled = true;
      chatInput.placeholder = window.languageSwitcher.translate('contactAuthRequired');
      chatSend.disabled = true;
      chatSend.classList.add('chat-disabled');
    }

    function enableChatInput() {
      chatInput.disabled = false;
      chatInput.placeholder = window.languageSwitcher.translate('contactChatInputPlaceholder');
      chatSend.disabled = false;
      chatSend.classList.remove('chat-disabled');
    }

    function showChatMessage(senderName, text, type = 'user') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${type}`;
      
      const locale = (window.languageSwitcher && window.languageSwitcher.currentLocale) 
        ? window.languageSwitcher.currentLocale 
        : 'ka-GE';
      const time = new Date().toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' });
      
      messageDiv.innerHTML = `
        <div><strong>${senderName}</strong></div>
        <div>${text}</div>
        <div class="chat-message-time">${time}</div>
      `;
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function getUserName() {
      try {
        if (!currentUser) {
          return window.languageSwitcher.translate('homeAnonymous');
        }

        const userDoc = await getDoc(doc(db, "users", currentUser.uid));
        if (userDoc.exists() && userDoc.data().name) {
          return userDoc.data().name;
        }
        
        return window.languageSwitcher.translate('homeDefaultUserName');
      } catch (error) {
        console.error("[v0] Error getting user name:", error);
        return window.languageSwitcher.translate('homeDefaultUserName');
      }
    }

    async function initializeChat() {
      if (!currentUser) {
        showChatMessage(
          window.languageSwitcher.translate('contactSystemName'), 
          window.languageSwitcher.translate('contactAuthRequired'), 
          'system'
        );
        disableChatInput();
        return;
      }

      enableChatInput();

      try {
        const chatsRef = collection(db, "chats");
        const q = query(
          chatsRef, 
          where("userId", "==", currentUser.uid), 
          where("status", "in", ["active", "assigned"])
        );
        
        chatUnsubscribe = onSnapshot(q, async (snapshot) => {
          if (!snapshot.empty) {
            const activeChat = snapshot.docs[0];
            const chatData = activeChat.data();
            
            if (chatData.status !== "closed") {
              currentChatId = activeChat.id;
              loadMessages();
            } else {
              currentChatId = null;
              chatMessages.innerHTML = `<div class="chat-message system"><div>${window.languageSwitcher.translate('contactChatWelcome')}</div></div>`;
            }
          } else {
            currentChatId = null;
            chatMessages.innerHTML = `<div class="chat-message system"><div>${window.languageSwitcher.translate('contactChatWelcome')}</div></div>`;
          }
        }, (error) => {
          console.error("[v0] Chat listener error:", error);
        });

      } catch (error) {
        console.error("[v0] Error initializing chat:", error);
        showChatMessage(
          window.languageSwitcher.translate('contactSystemName'), 
          window.languageSwitcher.translate('contactAuthFailed'), 
          'system'
        );
      }
    }

    async function createNewChat() {
      try {
        const chatsRef = collection(db, "chats");
        const q = query(
          chatsRef, 
          where("userId", "==", currentUser.uid), 
          where("status", "in", ["active", "assigned"])
        );
        
        const existingChats = await getDocs(q);
        
        if (!existingChats.empty) {
          currentChatId = existingChats.docs[0].id;
          loadMessages();
          return;
        }

        // Get user name with fallback
        const userName = await getUserName();
        const userEmail = currentUser.email || 'anonymous@user.com';

        console.log("[v0] Creating chat with userName:", userName);

        const chatDoc = await addDoc(collection(db, "chats"), {
          userId: currentUser.uid,
          userName: userName,
          userEmail: userEmail,
          status: "active",
          createdAt: serverTimestamp(),
          adminId: null,
          adminName: null,
          adminEmail: null,
          closedBy: null,
          closedAt: null,
          lastMessage: "",
          lastMessageBy: "user",
          lastMessageAt: serverTimestamp()
        });
        
        currentChatId = chatDoc.id;
        messageCount = 0;
        autoReplySent = false;
        console.log("[v0] New chat created:", currentChatId);
        
        // რომ მომხმარებელმა დაინახოს თავისი შეტყობინებები
        loadMessages();
        
      } catch (error) {
        console.error("[v0] Error creating chat:", error);
        showChatMessage(
          window.languageSwitcher.translate('contactSystemName'), 
          window.languageSwitcher.translate('contactChatCreateFailed'), 
          'system'
        );
      }
    }

    function loadMessages() {
      if (!currentChatId) return;
      
      // გავწმინდოთ წინა listener თუ არსებობს
      if (messagesUnsubscribe) {
        messagesUnsubscribe();
      }

      const messagesRef = collection(db, "chats", currentChatId, "messages");
      const q = query(messagesRef, orderBy("timestamp", "asc"));

      messagesUnsubscribe = onSnapshot(q, (snapshot) => {
        chatMessages.innerHTML = '';
        
        snapshot.forEach((docSnap) => {
          const msg = docSnap.data();
          showChatMessage(msg.senderName || 'მომხმარებელი', msg.text, msg.senderType);
        });
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, (error) => {
        console.error("[v0] Messages listener error:", error);
      });
    }

    async function sendMessage() {
      if (isSendingMessage) {
        return;
      }

      const text = chatInput.value.trim();
      if (!text || !currentUser) return;

      const messageId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      
      if (pendingMessages.has(messageId)) {
        return;
      }

      pendingMessages.add(messageId);

      const now = Date.now();
      if (now - lastMessageTime < MESSAGE_COOLDOWN) {
        const remainingSeconds = Math.ceil((MESSAGE_COOLDOWN - (now - lastMessageTime)) / 1000);
        const waitMessage = window.languageSwitcher.translate('contactWaitSeconds').replace('{seconds}', remainingSeconds);
        showChatMessage(
          window.languageSwitcher.translate('contactSystemName'), 
          waitMessage, 
          'system'
        );
        pendingMessages.delete(messageId);
        return;
      }

      if (!currentChatId) {
        await createNewChat();
        
        await new Promise(resolve => setTimeout(resolve, 500));
        
        if (!currentChatId) {
          showChatMessage(
            window.languageSwitcher.translate('contactSystemName'), 
            window.languageSwitcher.translate('contactChatCreateFailed'), 
            'system'
          );
          pendingMessages.delete(messageId);
          return;
        }
      }

      try {
        isSendingMessage = true;
        
        const userName = await getUserName();

        await addDoc(collection(db, "chats", currentChatId, "messages"), {
          text: text,
          senderType: "user",
          senderId: currentUser.uid,
          senderName: userName,
          timestamp: serverTimestamp(),
          messageId: messageId
        });

        await updateDoc(doc(db, "chats", currentChatId), {
          lastMessage: text,
          lastMessageBy: "user",
          lastMessageAt: serverTimestamp()
        });

        chatInput.value = '';
        messageCount++;
        lastMessageTime = now;
        
        chatSend.disabled = true;
        chatSend.classList.add('chat-disabled');
        chatInput.disabled = true;
        
        let remainingTime = MESSAGE_COOLDOWN / 1000;
        chatSend.innerHTML = `<i class="fas fa-clock"></i>`;
        
        cooldownTimer = setInterval(() => {
          remainingTime--;
          if (remainingTime > 0) {
            chatSend.innerHTML = `<i class="fas fa-clock"></i>`;
          } else {
            clearInterval(cooldownTimer);
            cooldownTimer = null;
            chatSend.disabled = false;
            chatSend.classList.remove('chat-disabled');
            chatSend.innerHTML = '<i class="fas fa-paper-plane"></i>';
            chatInput.disabled = false;
          }
        }, 1000);
        
        if (messageCount === 1 && !autoReplySent) {
          setTimeout(async () => {
            try {
              await addDoc(collection(db, "chats", currentChatId, "messages"), {
                text: window.languageSwitcher.translate('contactSystemReply'),
                senderType: "admin",
                senderId: "system",
                senderName: window.languageSwitcher.translate('contactSystemName'),
                timestamp: serverTimestamp()
              });
              autoReplySent = true;
            } catch (error) {
              console.error("[v0] Error sending auto-reply:", error);
            }
          }, 1000);
        }
      } catch (error) {
        console.error("[v0] Error sending message:", error);
        showChatMessage(
          window.languageSwitcher.translate('contactSystemName'), 
          window.languageSwitcher.translate('contactMessageSendFailed'), 
          'system'
        );
        
        if (cooldownTimer) clearInterval(cooldownTimer);
        cooldownTimer = null;
        chatSend.disabled = false;
        chatSend.classList.remove('chat-disabled');
        chatSend.innerHTML = '<i class="fas fa-paper-plane"></i>';
        chatInput.disabled = false;
      } finally {
        isSendingMessage = false;
        pendingMessages.delete(messageId);
      }
    }

    document.getElementById('contact-form').addEventListener('submit', function(e) {
      e.preventDefault();
  
      const popup = document.getElementById('popup-message');
  
      emailjs.sendForm('service_fjymp06', 'template_btyx9a9', this)
        .then(() => {
          popup.textContent = window.languageSwitcher.translate('contactSuccessMessage');
          popup.style.display = 'block';
          popup.className = 'popup-message success';
          this.reset();
  
          setTimeout(() => {
            popup.style.display = 'none';
          }, 5000);
        }, (error) => {
          popup.textContent = window.languageSwitcher.translate('contactErrorMessage') + ' ' + error.text;
          popup.style.display = 'block';
          popup.className = 'popup-message error';
  
          setTimeout(() => {
            popup.style.display = 'none';
          }, 5000);
        });
    });

    // Initial translation application
    document.addEventListener('DOMContentLoaded', () => {
      updateContactFormTranslations();
      updateChatTranslations();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', cleanupChatListeners);
  </script>

  <script src="/pages/js/footer.js"></script>
  <script type="module" src="navbar.js"></script>

</body>
</html>
