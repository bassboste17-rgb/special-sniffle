<!DOCTYPE html>
<html lang="ka">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Georgia Trips - chat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #e5383b;
      --primary-gradient: linear-gradient(135deg, #e5383b 0%, #ff6b6b 100%);
      --dark-bg: #0a0a0a;
      --darker-bg: #1a1a1a;
      --card-bg: rgba(26, 26, 26, 0.95);
      --card-border: rgba(229, 56, 59, 0.2);
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --info-color: #17a2b8;
    }

    body {
      margin: 0;
      font-family: "BPG Glaho", sans-serif;
      background: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header Styles */
    .admin-header {
      background: linear-gradient(135deg, rgba(26, 26, 26, 0.95) 0%, rgba(30, 30, 30, 0.95) 100%);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--card-border);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .admin-header h1 {
      font-size: 1.8rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .admin-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .admin-user {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }

    .admin-user i {
      color: var(--primary-color);
    }

    /* Main Layout */
    .admin-container {
      display: flex;
      height: calc(100vh - 80px);
    }

    /* Sidebar Styles */
    .admin-sidebar {
      width: 280px;
      background: linear-gradient(135deg, rgba(20, 20, 20, 0.95) 0%, rgba(25, 25, 25, 0.95) 100%);
      border-right: 1px solid var(--card-border);
      padding: 1.5rem;
      overflow-y: auto;
      transition: all 0.3s ease;
    }

    .sidebar-section {
      margin-bottom: 2rem;
    }

    .sidebar-section h3 {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      color: var(--text-secondary);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 0.5rem;
    }

    .filter-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .filter-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
      padding: 0.8rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-btn:hover {
      background: rgba(229, 56, 59, 0.1);
      color: var(--text-primary);
    }

    .filter-btn.active {
      background: var(--primary-gradient);
      color: white;
      border-color: var(--primary-color);
    }

    .filter-btn i {
      width: 20px;
      text-align: center;
    }

    .chat-count {
      margin-left: auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.8rem;
    }

    /* Main Content Area */
    .admin-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Chat List Styles */
    .chats-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .chats-list {
      width: 350px;
      background: linear-gradient(135deg, rgba(20, 20, 20, 0.95) 0%, rgba(25, 25, 25, 0.95) 100%);
      border-right: 1px solid var(--card-border);
      overflow-y: auto;
      padding: 1rem;
    }

    .chats-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chats-list-header h2 {
      font-size: 1.3rem;
    }

    .search-box {
      position: relative;
      margin-bottom: 1rem;
    }

    .search-box input {
      width: 100%;
      padding: 0.8rem 1rem 0.8rem 2.5rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      font-family: "BPG Glaho", sans-serif;
    }

    .search-box i {
      position: absolute;
      left: 0.8rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
    }

    .chat-item {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .chat-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(229, 56, 59, 0.2);
    }

    .chat-item.active {
      background: rgba(229, 56, 59, 0.1);
      border-color: var(--primary-color);
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }

    .chat-user {
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .online-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success-color);
    }

    .offline-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
    }

    .chat-time {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .chat-preview {
      font-size: 0.9rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-status {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.7rem;
      margin-top: 0.5rem;
    }

    .status-active {
      background: rgba(40, 167, 69, 0.2);
      color: var(--success-color);
    }

    .status-assigned {
      background: rgba(255, 193, 7, 0.2);
      color: var(--warning-color);
    }

    .status-closed {
      background: rgba(220, 53, 69, 0.2);
      color: var(--danger-color);
    }

    /* Chat Area Styles */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, rgba(15, 15, 15, 0.95) 0%, rgba(20, 20, 20, 0.95) 100%);
    }

    .chat-header-area {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(26, 26, 26, 0.8);
    }

    .chat-user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .chat-actions {
      display: flex;
      gap: 0.5rem;
    }

    .chat-action-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: "BPG Glaho", sans-serif;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chat-action-btn:hover {
      background: rgba(229, 56, 59, 0.1);
      color: var(--text-primary);
    }

    .chat-action-btn.btn-success {
      background: var(--success-color);
      color: white;
      border-color: var(--success-color);
    }

    .chat-action-btn.btn-danger {
      background: var(--danger-color);
      color: white;
      border-color: var(--danger-color);
    }

    .chat-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Added proper scrolling to messages area */
    .chat-messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-height: calc(100vh - 300px);
      scroll-behavior: smooth;
    }

    .chat-messages-area::-webkit-scrollbar {
      width: 8px;
    }
    
    .chat-messages-area::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }
    
    .chat-messages-area::-webkit-scrollbar-thumb {
      background: rgba(229, 56, 59, 0.5);
      border-radius: 4px;
    }
    
    .chat-messages-area::-webkit-scrollbar-thumb:hover {
      background: rgba(229, 56, 59, 0.7);
    }

    .message {
      max-width: 70%;
      padding: 1rem;
      border-radius: 16px;
      word-wrap: break-word;
      animation: messageSlide 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      align-self: flex-start;
      background: linear-gradient(135deg, rgba(42, 42, 42, 0.95) 0%, rgba(50, 50, 50, 0.95) 100%);
      color: var(--text-primary);
      border-bottom-left-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .message.admin {
      align-self: flex-end;
      background: var(--primary-gradient);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.system {
      align-self: center;
      background: linear-gradient(135deg, rgba(51, 51, 51, 0.8) 0%, rgba(60, 60, 60, 0.8) 100%);
      color: #ccc;
      font-style: italic;
      max-width: 90%;
      text-align: center;
      font-size: 0.9rem;
      border-radius: 12px;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
    }

    .message-sender {
      font-weight: bold;
    }

    .message-time {
      opacity: 0.7;
    }

    .message-content {
      line-height: 1.4;
    }

    /* Moved send button below emoji picker */
    .chat-input-area {
      padding: 1.2rem;
      border-top: 1px solid var(--card-border);
      background: rgba(20, 20, 20, 0.8);
    }

    .chat-input-container {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .chat-input {
      width: 100%;
      padding: 1rem;
      border: 2px solid rgba(229, 56, 59, 0.3);
      border-radius: 12px;
      background: rgba(34, 34, 34, 0.8);
      color: white;
      outline: none;
      font-family: "BPG Glaho", sans-serif;
      transition: all 0.3s ease;
      resize: none;
      min-height: 50px;
      max-height: 120px;
    }
    
    .chat-input:focus {
      border-color: var(--primary-color);
      background: rgba(34, 34, 34, 1);
      box-shadow: 0 0 0 3px rgba(229, 56, 59, 0.1);
    }

    /* Added input controls row with emoji and send button */
    .input-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.8rem;
    }

    .emoji-btn {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: rgba(229, 56, 59, 0.2);
      border: 1px solid rgba(229, 56, 59, 0.3);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      font-size: 1.2rem;
    }

    .emoji-btn:hover {
      background: rgba(229, 56, 59, 0.3);
      color: var(--text-primary);
      transform: scale(1.1);
    }

    .char-count {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-left: auto;
    }

    .send-btn {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: var(--primary-gradient);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(229, 56, 59, 0.4);
    }

    .send-btn:hover:not(:disabled) {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(229, 56, 59, 0.6);
    }
    
    .send-btn:active:not(:disabled) {
      transform: scale(0.95);
    }
    
    .send-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: linear-gradient(135deg, #666 0%, #888 100%);
    }

    .emoji-panel {
      position: absolute;
      bottom: 140px;
      right: 20px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 1rem;
      display: none;
      grid-template-columns: repeat(6, 1fr);
      gap: 0.5rem;
      max-width: 300px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      z-index: 10;
    }

    .emoji-panel.show {
      display: grid;
    }

    .emoji-item {
      font-size: 1.5rem;
      cursor: pointer;
      text-align: center;
      padding: 0.2rem;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .emoji-item:hover {
      background: rgba(229, 56, 59, 0.1);
      transform: scale(1.2);
    }

    /* No Chat Selected State */
    .no-chat-selected {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem;
    }

    .no-chat-icon {
      font-size: 4rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }

    .no-chat-text {
      font-size: 1.2rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }

    /* User Info Panel */
    .user-info-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 2rem;
      width: 90%;
      max-width: 500px;
      z-index: 1000;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      display: none;
    }

    .user-info-panel.show {
      display: block;
    }

    .user-info-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .user-info-header h3 {
      font-size: 1.3rem;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .close-user-info {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .close-user-info:hover {
      color: var(--primary-color);
    }

    .user-details {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .user-detail-item {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .user-detail-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .user-detail-value {
      font-size: 1rem;
      padding: 0.8rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .back-to-booking {
      margin-top: 0.2rem;
      width: 100%;
      padding: 0.5rem;
      background: var(--primary-gradient);
      border: none;
      border-radius: 8px;
      color: white;
      font-family: "BPG Glaho", sans-serif;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.rem;
    }

    .back-to-booking:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(229, 56, 59, 0.4);
    }

    /* Overlay for user info panel */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 999;
      display: none;
    }

    .overlay.show {
      display: block;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .admin-sidebar {
        width: 240px;
      }
      
      .chats-list {
        width: 300px;
      }
    }

    @media (max-width: 768px) {
      .admin-container {
        flex-direction: column;
        height: auto;
      }
      
      .admin-sidebar {
        width: 100%;
        height: auto;
        border-right: none;
        border-bottom: 1px solid var(--card-border);
      }
      
      .filter-buttons {
        flex-direction: row;
        overflow-x: auto;
        padding-bottom: 0.5rem;
      }
      
      .filter-btn {
        white-space: nowrap;
      }
      
      .chats-container {
        flex-direction: column;
      }
      
      .chats-list {
        width: 100%;
        height: 300px;
        border-right: none;
        border-bottom: 1px solid var(--card-border);
      }
      
      .chat-area {
        height: 500px;
      }
    }

    /* Notification Styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      color: white;
      z-index: 1000;
      animation: slideIn 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .notification.success {
      background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
    }
    
    .notification.error {
      background: linear-gradient(135deg, var(--danger-color) 0%, #ff6b6b 100%);
    }
    
    .notification.info {
      background: linear-gradient(135deg, var(--info-color) 0%, #6fcf97 100%);
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Admin Header -->
  <header class="admin-header">
    <h1><i class="fas fa-headset"></i> áƒáƒ“áƒ›áƒ˜áƒœáƒ˜áƒ¡áƒ¢áƒ áƒáƒ¢áƒáƒ áƒ˜áƒ¡ áƒáƒáƒœáƒ”áƒšáƒ˜</h1>
    <div class="admin-controls">
      <div class="admin-user">
        <i class="fas fa-user-shield"></i>
        <span id="adminName">áƒáƒ“áƒ›áƒ˜áƒœáƒ˜áƒ¡áƒ¢áƒ áƒáƒ¢áƒáƒ áƒ˜</span>
      </div>
      <button class="back-to-booking" id="backToBooking">
        <i class="fas fa-arrow-left"></i> áƒ£áƒ™áƒáƒœ
      </button>
    </div>
  </header>

  <!-- Main Container -->
  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <!-- Removed settings section (auto-assign, sound, cooldown toggles) -->
      <div class="sidebar-section">
        <h3><i class="fas fa-filter"></i> áƒ¤áƒ˜áƒšáƒ¢áƒ áƒáƒªáƒ˜áƒ</h3>
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="all">
            <i class="fas fa-list"></i> áƒ§áƒ•áƒ”áƒšáƒ áƒ©áƒáƒ¢áƒ˜
            <span class="chat-count" id="countAll">0</span>
          </button>
          <button class="filter-btn" data-filter="active">
            <i class="fas fa-circle"></i> áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜
            <span class="chat-count" id="countActive">0</span>
          </button>
          <button class="filter-btn" data-filter="assigned">
            <i class="fas fa-user-check"></i> áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒ˜
            <span class="chat-count" id="countAssigned">0</span>
          </button>
          <button class="filter-btn" data-filter="closed">
            <i class="fas fa-check-circle"></i> áƒ“áƒáƒ®áƒ£áƒ áƒ£áƒšáƒ˜
            <span class="chat-count" id="countClosed">0</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <div class="chats-container">
        <!-- Chats List -->
        <div class="chats-list">
          <div class="chats-list-header">
            <h2>áƒ©áƒáƒ¢áƒ”áƒ‘áƒ˜</h2>
            <button class="chat-action-btn" id="refreshChats" style="padding: 0.5rem; width: auto;">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
          
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchChats" placeholder="áƒ«áƒ˜áƒ”áƒ‘áƒ...">
          </div>
          
          <div class="chats-list-container" id="chatsList">
            <!-- Chat items will be populated here -->
          </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
          <div class="no-chat-selected" id="noChatSelected">
            <div class="no-chat-icon">
              <i class="fas fa-comments"></i>
            </div>
            <div class="no-chat-text">
              áƒáƒ˜áƒ áƒ©áƒ˜áƒ”áƒ— áƒ©áƒáƒ¢áƒ˜ áƒ›áƒáƒ¡áƒáƒ£áƒ‘áƒ áƒ”áƒ“
            </div>
          </div>

          <div class="chat-active" id="chatActive" style="display: none; flex: 1; display: flex; flex-direction: column;">
            <div class="chat-header-area">
              <div class="chat-user-info">
                <div>
                  <h3 id="currentChatUser">áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜</h3>
                  <div id="currentChatStatus" class="chat-status status-active">áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜</div>
                </div>
              </div>
              <div class="chat-actions">
                <button class="chat-action-btn" id="viewUserInfoBtn">
                  <i class="fas fa-user"></i> áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ
                </button>
                <button class="chat-action-btn btn-success" id="takeChatBtn">
                  <i class="fas fa-hand-paper"></i> áƒ©áƒáƒ¢áƒ˜áƒ¡ áƒáƒ¦áƒ”áƒ‘áƒ
                </button>
                <button class="chat-action-btn btn-danger" id="closeChatBtn">
                  <i class="fas fa-times-circle"></i> áƒ©áƒáƒ¢áƒ˜áƒ¡ áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ
                </button>
              </div>
            </div>

            <div class="chat-messages-area" id="chatMessages">
              <!-- Messages will be populated here -->
            </div>

            <div class="chat-input-area">
              <div class="chat-input-container">
                <textarea class="chat-input" id="messageInput" placeholder="áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒ”áƒ— áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ..." disabled></textarea>
                <div class="input-controls">
                  <button class="emoji-btn" id="emojiBtn" title="áƒ”áƒ›áƒáƒ¯áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ">
                    <i class="fas fa-smile"></i>
                  </button>
                  <span class="char-count" id="charCount">0/500</span>
                  <button class="send-btn" id="sendBtn" disabled>
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Emoji Panel -->
  <div class="emoji-panel" id="emojiPanel">
    <div class="emoji-item">ğŸ˜€</div>
    <div class="emoji-item">ğŸ˜ƒ</div>
    <div class="emoji-item">ğŸ˜„</div>
    <div class="emoji-item">ğŸ˜</div>
    <div class="emoji-item">ğŸ˜†</div>
    <div class="emoji-item">ğŸ˜…</div>
    <div class="emoji-item">ğŸ˜‚</div>
    <div class="emoji-item">ğŸ¤£</div>
    <div class="emoji-item">ğŸ˜Š</div>
    <div class="emoji-item">ğŸ˜‡</div>
    <div class="emoji-item">ğŸ™‚</div>
    <div class="emoji-item">ğŸ™ƒ</div>
    <div class="emoji-item">ğŸ˜‰</div>
    <div class="emoji-item">ğŸ˜Œ</div>
    <div class="emoji-item">ğŸ˜</div>
    <div class="emoji-item">ğŸ¥°</div>
    <div class="emoji-item">ğŸ˜˜</div>
    <div class="emoji-item">ğŸ˜—</div>
    <div class="emoji-item">ğŸ˜™</div>
    <div class="emoji-item">ğŸ˜š</div>
    <div class="emoji-item">ğŸ˜‹</div>
    <div class="emoji-item">ğŸ˜›</div>
    <div class="emoji-item">ğŸ˜</div>
    <div class="emoji-item">ğŸ˜œ</div>
    <div class="emoji-item">ğŸ¤ª</div>
    <div class="emoji-item">ğŸ¤¨</div>
    <div class="emoji-item">ğŸ§</div>
    <div class="emoji-item">ğŸ¤“</div>
    <div class="emoji-item">ğŸ˜</div>
    <div class="emoji-item">ğŸ¤©</div>
  </div>

  <!-- User Info Panel -->
  <div class="overlay" id="userInfoOverlay"></div>
  <div class="user-info-panel" id="userInfoPanel">
    <div class="user-info-header">
      <h3><i class="fas fa-user-circle"></i> áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ</h3>
      <button class="close-user-info" id="closeUserInfo">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="user-details" id="userDetails">
      <!-- User details will be populated here -->
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { 
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { 
      getFirestore,
      collection,
      addDoc,
      doc,
      getDoc,
      getDocs,
      query,
      where,
      orderBy,
      onSnapshot,
      serverTimestamp,
      updateDoc,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBBybpmsrByBZtwThfCd3u0pfHFjEL2ap0",
      authDomain: "rentime-e201e.firebaseapp.com",
      projectId: "rentime-e201e",
      storageBucket: "rentime-e201e.firebasestorage.app",
      messagingSenderId: "420054668757",
      appId: "1:420054668757:web:0accf1d8b9d621fd94195c",
      measurementId: "G-DGWLG9P1ZB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Admin state
    let currentChatId = null;
    let currentFilter = 'all';
    let chatsUnsubscribe = null;
    let messagesUnsubscribe = null;
    const adminId = 'admin_' + Date.now();
    const adminName = 'áƒáƒ“áƒ›áƒ˜áƒœáƒ˜áƒ¡áƒ¢áƒ áƒáƒ¢áƒáƒ áƒ˜';

    // DOM Elements
    const adminNameSpan = document.getElementById('adminName');
    const filterButtons = document.querySelectorAll('.filter-btn[data-filter]');
    const chatCounts = {
        all: document.getElementById('countAll'),
        active: document.getElementById('countActive'),
        assigned: document.getElementById('countAssigned'),
        closed: document.getElementById('countClosed')
    };
    const refreshChatsBtn = document.getElementById('refreshChats');
    const searchInput = document.getElementById('searchChats');
    const chatsListContainer = document.getElementById('chatsList');
    const noChatSelectedDiv = document.getElementById('noChatSelected');
    const chatActiveDiv = document.getElementById('chatActive');
    const currentChatUserH3 = document.getElementById('currentChatUser');
    const currentChatStatusDiv = document.getElementById('currentChatStatus');
    const viewUserInfoBtn = document.getElementById('viewUserInfoBtn');
    const takeChatBtn = document.getElementById('takeChatBtn');
    const closeChatBtn = document.getElementById('closeChatBtn');
    const chatMessagesDiv = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const charCountSpan = document.getElementById('charCount');
    const sendBtn = document.getElementById('sendBtn');
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPanel = document.getElementById('emojiPanel');
    const userInfoPanel = document.getElementById('userInfoPanel');
    const userInfoOverlay = document.getElementById('userInfoOverlay');
    const closeUserInfoBtn = document.getElementById('closeUserInfo');
    const userDetailsDiv = document.getElementById('userDetails');
    const backToBookingBtn = document.getElementById('backToBooking');


    // Update admin name in header
    adminNameSpan.textContent = adminName;

    // Initialize filter buttons
    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all filter buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            button.classList.add('active');
            // Update current filter
            currentFilter = button.dataset.filter;
            // Reload chats with new filter
            loadChats();
        });
    });

    // Update chat counts
    function updateChatCounts(counts) {
        chatCounts.all.textContent = counts.all || 0;
        chatCounts.active.textContent = counts.active || 0;
        chatCounts.assigned.textContent = counts.assigned || 0;
        chatCounts.closed.textContent = counts.closed || 0;
    }


    // Refresh chats button
    refreshChatsBtn.addEventListener('click', loadChats);

    // Chat search functionality
    searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        document.querySelectorAll('.chat-item').forEach(item => {
            const userName = item.querySelector('.chat-user').textContent.toLowerCase();
            const lastMessage = item.querySelector('.chat-preview').textContent.toLowerCase();
            if (userName.includes(searchTerm) || lastMessage.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });

    // Load chats from Firestore
    function loadChats() {
        if (chatsUnsubscribe) {
            chatsUnsubscribe();
        }

        const chatsRef = collection(db, "chats");
        // Always fetch all chats ordered by lastMessageAt
        const q = query(chatsRef, orderBy("lastMessageAt", "desc"));

        chatsUnsubscribe = onSnapshot(q, (snapshot) => {
            chatsListContainer.innerHTML = '';
            let counts = { all: 0, active: 0, assigned: 0, closed: 0 };
            let allChats = [];

            // Collect all chats and count them
            snapshot.forEach((doc) => {
                const chat = doc.data();
                const chatWithId = { id: doc.id, ...chat };
                allChats.push(chatWithId);
                
                counts.all++;
                if (chat.status) counts[chat.status]++;
            });

            // Filter chats based on current filter
            const filteredChats = currentFilter === 'all' 
                ? allChats 
                : allChats.filter(chat => chat.status === currentFilter);

            // Display filtered chats
            filteredChats.forEach(chat => {
                const chatItem = createChatListItem(chat.id, chat);
                chatsListContainer.appendChild(chatItem);
            });

            updateChatCounts(counts);
        }, (error) => {
            console.error("Error loading chats:", error);
        });
    }

    // Create a single chat list item element
    function createChatListItem(chatId, chat) {
        const chatItem = document.createElement('div');
        chatItem.className = `chat-item ${currentChatId === chatId ? 'active' : ''}`;
        chatItem.dataset.chatId = chatId;

        const statusClass = `status-${chat.status || 'active'}`;
        const statusText = {
            'active': 'áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜',
            'assigned': 'áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒ˜',
            'closed': 'áƒ“áƒáƒ®áƒ£áƒ áƒ£áƒšáƒ˜'
        }[chat.status] || 'áƒ£áƒªáƒœáƒáƒ‘áƒ˜';

        let time = 'áƒ“áƒ áƒ áƒáƒ  áƒáƒ áƒ˜áƒ¡';
        if (chat.lastMessageAt) {
            try {
                if (chat.lastMessageAt.toDate && typeof chat.lastMessageAt.toDate === 'function') {
                    time = formatTime(chat.lastMessageAt.toDate());
                } else if (chat.lastMessageAt instanceof Date) {
                    time = formatTime(chat.lastMessageAt);
                } else if (typeof chat.lastMessageAt === 'number') {
                    time = formatTime(new Date(chat.lastMessageAt));
                } else if (typeof chat.lastMessageAt === 'string') {
                    time = formatTime(new Date(chat.lastMessageAt));
                }
            } catch (error) {
                console.error('Error formatting time:', error);
                time = 'áƒ“áƒ áƒ áƒáƒ  áƒáƒ áƒ˜áƒ¡';
            }
        }

        chatItem.innerHTML = `
            <div class="chat-header">
                <div class="chat-user">
                    <span class="online-indicator"></span> ${chat.userName || 'áƒ£áƒªáƒœáƒáƒ‘áƒ˜ áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜'}
                </div>
                <span class="chat-time">${time}</span>
            </div>
            <div class="chat-preview">${chat.lastMessage || 'áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ áƒáƒ  áƒáƒ áƒ˜áƒ¡'}</div>
            <div class="chat-status ${statusClass}">${statusText}</div>
        `;

        chatItem.addEventListener('click', () => {
            selectChat(chatId, chat);
        });

        return chatItem;
    }

    // Select a chat to display
    function selectChat(chatId, chatData) {
        currentChatId = chatId;

        document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.chatId === chatId) {
                item.classList.add('active');
            }
        });

        noChatSelectedDiv.style.display = 'none';
        chatActiveDiv.style.display = 'flex';

        currentChatUserH3.textContent = chatData.userName || 'áƒ£áƒªáƒœáƒáƒ‘áƒ˜ áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜';
        currentChatStatusDiv.textContent = {
            'active': 'áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜',
            'assigned': 'áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒ˜',
            'closed': 'áƒ“áƒáƒ®áƒ£áƒ áƒ£áƒšáƒ˜'
        }[chatData.status] || 'áƒ£áƒªáƒœáƒáƒ‘áƒ˜';
        currentChatStatusDiv.className = `chat-status status-${chatData.status || 'active'}`;

        takeChatBtn.disabled = (chatData.status !== 'active');
        closeChatBtn.disabled = (chatData.status === 'closed');
        messageInput.disabled = (chatData.status !== 'assigned' || chatData.adminId !== adminId);
        sendBtn.disabled = messageInput.disabled || messageInput.value.trim().length === 0;

        loadMessages(chatId);
    }

    // Load messages for a specific chat
    function loadMessages(chatId) {
        if (messagesUnsubscribe) {
            messagesUnsubscribe();
        }

        const messagesRef = collection(db, "chats", chatId, "messages");
        const q = query(messagesRef, orderBy("timestamp", "asc"));

        messagesUnsubscribe = onSnapshot(q, (snapshot) => {
            chatMessagesDiv.innerHTML = '';
            snapshot.forEach((doc) => {
                const msg = doc.data();
                const messageElement = createMessageElement(msg);
                chatMessagesDiv.appendChild(messageElement);
            });
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }, (error) => {
            console.error("Error loading messages:", error);
        });
    }

    // Create a single message element
    function createMessageElement(msg) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.senderType || 'user'}`;

        let time = 'N/A';
        if (msg.timestamp) {
            try {
                if (msg.timestamp.toDate && typeof msg.timestamp.toDate === 'function') {
                    time = formatTime(msg.timestamp.toDate());
                } else if (msg.timestamp instanceof Date) {
                    time = formatTime(msg.timestamp);
                } else if (typeof msg.timestamp === 'number') {
                    time = formatTime(new Date(msg.timestamp));
                } else if (typeof msg.timestamp === 'string') {
                    time = formatTime(new Date(msg.timestamp));
                }
            } catch (error) {
                console.error('Error formatting message time:', error);
                time = 'N/A';
            }
        }

        if (msg.senderType === 'system') {
            messageDiv.innerHTML = `<div class="message-content">${msg.text}</div>`;
        } else {
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${msg.senderName || 'áƒ£áƒªáƒœáƒáƒ‘áƒ˜'}</span>
                    <span class="message-time">${time}</span>
                </div>
                <div class="message-content">${msg.text}</div>
            `;
        }
        return messageDiv;
    }

    // View user info
    viewUserInfoBtn.addEventListener('click', async () => {
        if (!currentChatId) return;

        try {
            const chatDoc = await getDoc(doc(db, "chats", currentChatId));
            if (chatDoc.exists()) {
                const chatData = chatDoc.data();
                const userId = chatData.userId;
                
                const userDoc = await getDoc(doc(db, "users", userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    displayUserInfo(userData);
                } else {
                    displayUserInfo({
                        name: chatData.userName || 'áƒ£áƒªáƒœáƒáƒ‘áƒ˜',
                        email: chatData.userEmail || 'áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡',
                        phone: chatData.userPhone || 'áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡',
                        createdAt: chatData.createdAt || 'áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡'
                    });
                }
            }
        } catch (error) {
            console.error("Error fetching user info:", error);
            alert("áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒšáƒ˜áƒ¡ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ.");
        }
    });

    // Display user information in the panel
    function displayUserInfo(userData) {
        userDetailsDiv.innerHTML = `
            <div class="user-detail-item">
                <div class="user-detail-label">áƒ¡áƒáƒ®áƒ”áƒšáƒ˜:</div>
                <div class="user-detail-value">${userData.name || 'áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡'}</div>
            </div>
            <div class="user-detail-item">
                <div class="user-detail-label">áƒ”áƒš. áƒ¤áƒáƒ¡áƒ¢áƒ:</div>
                <div class="user-detail-value">${userData.email || 'áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡'}</div>
            </div>
            <div class="user-detail-item">
                <div class="user-detail-label">áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜:</div>
                <div class="user-detail-value">${userData.phone || 'áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡'}</div>
            </div>
            <div class="user-detail-item">
                <div class="user-detail-label">áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ—áƒáƒ áƒ˜áƒ¦áƒ˜:</div>
                <div class="user-detail-value">${userData.createdAt ? formatDate(userData.createdAt) : 'áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡'}</div>
            </div>
        `;
        
        userInfoPanel.classList.add('show');
        userInfoOverlay.classList.add('show');
    }

    // Close user info panel
    closeUserInfoBtn.addEventListener('click', () => {
        userInfoPanel.classList.remove('show');
        userInfoOverlay.classList.remove('show');
    });

    userInfoOverlay.addEventListener('click', () => {
        userInfoPanel.classList.remove('show');
        userInfoOverlay.classList.remove('show');
    });

    // Back to booking page
    backToBookingBtn.addEventListener('click', () => {
        window.location.href = 'booking.html';
    });

    // Handle taking a chat
    takeChatBtn.addEventListener('click', async () => {
        if (!currentChatId) return;

        try {
            await updateDoc(doc(db, "chats", currentChatId), {
                status: "assigned",
                adminId: adminId,
                adminName: adminName,
                assignedAt: serverTimestamp()
            });
            await addDoc(collection(db, "chats", currentChatId, "messages"), {
                text: `${adminName} áƒ¨áƒ”áƒ£áƒ”áƒ áƒ—áƒ“áƒ áƒ¡áƒáƒ£áƒ‘áƒáƒ áƒ¡.`,
                senderType: "system",
                senderId: adminId,
                senderName: "áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ",
                timestamp: serverTimestamp()
            });
            
            // Reload the chat to update UI
            const chatDoc = await getDoc(doc(db, "chats", currentChatId));
            if (chatDoc.exists()) {
                selectChat(currentChatId, chatDoc.data());
            }
        } catch (error) {
            console.error("Error taking chat:", error);
            alert("áƒ©áƒáƒ¢áƒ˜áƒ¡ áƒáƒ¦áƒ”áƒ‘áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ.");
        }
    });

    // Handle closing a chat
    closeChatBtn.addEventListener('click', async () => {
        if (!currentChatId) return;

        if (!confirm('áƒ“áƒáƒ áƒ¬áƒ›áƒ£áƒœáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ®áƒáƒ áƒ—, áƒ áƒáƒ› áƒ’áƒ¡áƒ£áƒ áƒ— áƒ©áƒáƒ¢áƒ˜áƒ¡ áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ?')) {
            return;
        }

        try {
            await updateDoc(doc(db, "chats", currentChatId), {
                status: "closed",
                closedBy: adminId,
                closedAt: serverTimestamp()
            });
            await addDoc(collection(db, "chats", currentChatId, "messages"), {
                text: `áƒ©áƒáƒ¢áƒ˜ áƒ“áƒáƒ˜áƒ®áƒ£áƒ áƒ ${adminName}-áƒ˜áƒ¡ áƒ›áƒ˜áƒ”áƒ .`,
                senderType: "system",
                senderId: adminId,
                senderName: "áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒ",
                timestamp: serverTimestamp()
            });
            currentChatId = null;
            noChatSelectedDiv.style.display = 'flex';
            chatActiveDiv.style.display = 'none';
            if (messagesUnsubscribe) messagesUnsubscribe();
        } catch (error) {
            console.error("Error closing chat:", error);
            alert("áƒ©áƒáƒ¢áƒ˜áƒ¡ áƒ“áƒáƒ®áƒ£áƒ áƒ•áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ.");
        }
    });

    // Send message functionality
    messageInput.addEventListener('input', () => {
        charCountSpan.textContent = `${messageInput.value.length}/500`;
        sendBtn.disabled = messageInput.value.trim().length === 0 || messageInput.disabled;
    });

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text || !currentChatId || messageInput.disabled) return;

        try {
            await addDoc(collection(db, "chats", currentChatId, "messages"), {
                text: text,
                senderType: "admin",
                senderId: adminId,
                senderName: adminName,
                timestamp: serverTimestamp()
            });
            await updateDoc(doc(db, "chats", currentChatId), {
                lastMessage: text,
                lastMessageBy: "admin",
                lastMessageAt: serverTimestamp()
            });
            messageInput.value = '';
            charCountSpan.textContent = '0/500';
            sendBtn.disabled = true;
            messageInput.focus();
        } catch (error) {
            console.error("Error sending message:", error);
            alert("áƒ¨áƒ”áƒ¢áƒ§áƒáƒ‘áƒ˜áƒœáƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ.");
        }
    }

    // Emoji panel functionality
    emojiBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        emojiPanel.classList.toggle('show');
    });

    document.addEventListener('click', (e) => {
        if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) {
            emojiPanel.classList.remove('show');
        }
    });

    const emojiItems = document.querySelectorAll('.emoji-item');
    emojiItems.forEach(item => {
        item.addEventListener('click', () => {
            messageInput.value += item.textContent;
            messageInput.dispatchEvent(new Event('input'));
            emojiPanel.classList.remove('show');
            messageInput.focus();
        });
    });

    // Utility functions
    function formatTime(date) {
        const now = new Date();
        const diffMilliseconds = now - date;
        const diffMinutes = Math.floor(diffMilliseconds / (1000 * 60));
        const diffHours = Math.floor(diffMinutes / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffMinutes < 1) return 'áƒáƒ®áƒšáƒáƒ®áƒáƒœ';
        if (diffMinutes < 60) return `${diffMinutes} áƒ¬áƒ£áƒ—áƒ˜áƒ¡ áƒ¬áƒ˜áƒœ`;
        if (diffHours < 24) return `${diffHours} áƒ¡áƒáƒáƒ—áƒ˜áƒ¡ áƒ¬áƒ˜áƒœ`;
        if (diffDays < 7) return `${diffDays} áƒ“áƒ¦áƒ˜áƒ¡ áƒ¬áƒ˜áƒœ`;

        return date.toLocaleDateString('ka-GE', {
            day: 'numeric',
            month: 'short',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function formatDate(date) {
        if (date.toDate && typeof date.toDate === 'function') {
            date = date.toDate();
        }
        return date.toLocaleDateString('ka-GE', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }


    // Initial load
    loadChats();

    // Clean up listeners when the page unloads
    window.addEventListener('beforeunload', () => {
        if (chatsUnsubscribe) chatsUnsubscribe();
        if (messagesUnsubscribe) messagesUnsubscribe();
    });
  </script>

</body>
</html>
